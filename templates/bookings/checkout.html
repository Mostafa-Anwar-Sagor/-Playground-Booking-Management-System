{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - {{ playground.name }} | PlayGround Booking{% endblock %}

{% block extra_head %}
<!-- VERSION: 2025-10-02-AMENITY-FIX-V2 -->
<meta name="csrf-token" content="{{ csrf_token }}">
<meta http-equiv="Permissions-Policy" content="unload=()">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
    :root {
        --primary-color: #10b981;
        --primary-hover: #059669;
        --primary-light: #d1fae5;
        --secondary-color: #3b82f6;
        --secondary-hover: #2563eb;
        --accent-color: #f59e0b;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --error-color: #ef4444;
        --card-bg: #1f2937;
        --card-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.6), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
        --border-color: #374151;
        --border-radius: 16px;
        --border-radius-sm: 8px;
        --text-primary: #f9fafb;
        --text-secondary: #d1d5db;
        --text-light: #9ca3af;
        --bg-primary: #111827;
        --bg-secondary: #1f2937;
        --bg-gradient: linear-gradient(135deg, #111827 0%, #1f2937 50%, #374151 100%);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--bg-primary) !important;
        min-height: 100vh;
        line-height: 1.6;
        color: var(--text-primary);
        padding-top: 0 !important;
    }
    
    /* CRITICAL: Ensure base.html navbar is visible */
    nav.navbar-fixed,
    nav.bg-gray-900 {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* CRITICAL: Ensure base.html footer is visible */
    body > footer {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* Hide the checkout-header that looks like a navbar */
    .checkout-header {
        display: none !important;
    }
    
    /* Ensure all containers use dark theme */
    .container, .container-fluid, .main-content, html, body, .wrapper, .content {
        background: var(--bg-primary) !important;
        background-color: var(--bg-primary) !important;
    }
    
    /* Override any white or light backgrounds */
    .bg-white, .bg-light, .bg-gray-100, .bg-gray-50 {
        background: var(--bg-primary) !important;
        background-color: var(--bg-primary) !important;
    }
    
    .checkout-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem 1rem;
        background: var(--bg-secondary);
        border-radius: var(--border-radius);
        margin-top: 2rem; /* Space below navbar (navbar height is 64px + main-content has 20px padding) */
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
        position: relative;
        z-index: 1; /* Below navbar which has z-index: 9999 */
    }
    
    .checkout-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 2.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }
    
    .checkout-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color));
    }
    
    .checkout-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
    }
    
    .checkout-card h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .checkout-card h2 i {
        color: var(--primary-color);
        font-size: 1.25rem;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        display: block;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }
    
    .form-input, .form-select, .form-textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: 0.5rem;
        font-size: 1rem;
        transition: border-color 0.2s ease;
        background: var(--bg-secondary);
        color: var(--text-primary);
    }
    
    .form-input:focus, .form-select:focus, .form-textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
        background: var(--bg-primary);
    }
    
    .form-input::placeholder, .form-textarea::placeholder {
        color: var(--text-light);
    }
    
    .form-textarea {
        resize: vertical;
        min-height: 100px;
    }
    
    .booking-summary {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 1rem;
        padding: 1.5rem;
        position: sticky;
        top: 2rem;
        box-shadow: var(--card-shadow);
    }
    
    .booking-summary h3 {
        color: var(--text-primary);
        font-weight: 700;
        margin-bottom: 1rem;
    }
    
    .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-secondary);
    }
    
    .summary-item:last-child {
        border-bottom: none;
        font-weight: 600;
        font-size: 1.125rem;
        color: var(--primary-color);
        background: rgba(16, 185, 129, 0.1);
        margin: 0 -1rem;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .time-slot {
        background: var(--bg-secondary);
        color: var(--text-primary);
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        text-align: center;
        margin: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid var(--border-color);
    }
    
    .time-slot:hover {
        background: rgba(16, 185, 129, 0.2);
        border-color: var(--primary-color);
        transform: translateY(-2px);
        color: var(--text-primary);
    }
    
    .time-slot.selected {
        background: linear-gradient(135deg, var(--primary-color), var(--success-color));
        border-color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        color: white;
    }
    
    .time-slot.unavailable {
        background: rgba(239, 68, 68, 0.1);
        color: rgba(239, 68, 68, 0.8);
        cursor: not-allowed;
        opacity: 0.6;
        border-color: rgba(239, 68, 68, 0.4);
    }
    
    .time-slot.unavailable:hover {
        transform: none;
        background: rgba(239, 68, 68, 0.1);
    }
    
    .slot-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .slot-category {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .slot-category h3 {
        color: var(--text-primary);
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .slot-type-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 0;
    }
    
    .slot-tab {
        padding: 0.75rem 1.25rem;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        border-radius: 8px 8px 0 0;
        position: relative;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .slot-tab:hover {
        background: rgba(16, 185, 129, 0.05);
        color: var(--primary-color);
    }
    
    .slot-tab.active {
        background: rgba(16, 185, 129, 0.1);
        border-bottom: 3px solid var(--primary-color);
        color: var(--primary-color);
        font-weight: 600;
    }
    
    .slot-container {
        padding: 1.5rem 0;
    }
    
    .custom-slot-form {
        background: rgba(16, 185, 129, 0.05);
        border: 2px dashed var(--primary-color);
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .custom-slot-form:hover {
        background: rgba(16, 185, 129, 0.08);
        border-color: var(--success-color);
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .membership-slot {
        background: linear-gradient(135deg, #f59e0b, #d97706) !important;
        color: white !important;
        border: 2px solid #f59e0b !important;
        position: relative;
        overflow: hidden;
    }
    
    .membership-slot::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
        transform: rotate(45deg);
        animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
        0% { transform: translateX(-100%) rotate(45deg); }
        100% { transform: translateX(100%) rotate(45deg); }
    }
    
    .slot-type-tab {
        padding: 0.75rem 1.25rem;
        background: var(--bg-secondary);
        border: 2px solid var(--border-color);
        border-radius: 2rem;
        color: var(--text-secondary);
        cursor: pointer;
        transition: var(--transition);
        font-weight: 500;
    }
    
    .slot-type-tab:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }
    
    .slot-type-tab.active {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }
    
    .payment-method {
        border: 2px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 1rem;
        margin: 0.5rem 0;
        cursor: pointer;
        transition: all 0.2s ease;
        background: var(--bg-secondary);
        color: var(--text-primary);
    }
    
    .payment-method:hover {
        border-color: var(--primary-color);
        background: rgba(16, 185, 129, 0.1);
        transform: translateY(-2px);
    }
    
    .payment-method.selected {
        border-color: var(--primary-color);
        background: rgba(16, 185, 129, 0.2);
        color: var(--text-primary);
    }
    
    .payment-method h4 {
        color: var(--text-primary);
    }
    
    .payment-method p {
        color: var(--text-secondary);
    }
    
    .payment-icon {
        width: 40px;
        height: 40px;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        margin-right: 1rem;
        background: rgba(16, 185, 129, 0.2);
        color: var(--primary-color);
        border: 1px solid var(--border-color);
    }
    
    .amenity-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        margin-bottom: 0.75rem;
        background: var(--bg-secondary);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        position: relative;
        overflow: visible;
    }
    
    .amenity-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--primary-color), #059669);
        opacity: 0;
        transition: all 0.3s ease;
    }
    
    .amenity-item:hover {
        border-color: var(--primary-color);
        background: rgba(16, 185, 129, 0.08);
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.15);
    }
    
    .amenity-item:hover::before {
        opacity: 1;
    }
    
    .amenity-item.selected {
        border-color: var(--primary-color);
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(16, 185, 129, 0.25);
    }
    
    .amenity-item.selected::before {
        opacity: 1;
    }
    
    .amenity-item.free {
        background: rgba(16, 185, 129, 0.1);
        border-color: var(--primary-color);
    }
    
    .amenity-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .amenity-icon {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        background: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
    }
    
    .amenity-details h4 {
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .amenity-details p {
        color: var(--text-secondary);
        font-size: 0.875rem;
    }
    
    .amenity-price {
        font-weight: 600;
        color: var(--primary-color);
    }
    
    .membership-pass {
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 1rem;
        background: var(--bg-secondary);
        transition: var(--transition);
        cursor: pointer;
    }
    
    .membership-pass:hover {
        border-color: var(--primary-color);
        background: rgba(16, 185, 129, 0.05);
        transform: translateY(-2px);
    }
    
    .membership-pass.selected {
        border-color: var(--primary-color);
        background: rgba(16, 185, 129, 0.1);
    }
    
    .pass-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .pass-title {
        color: var(--text-primary);
        font-weight: 700;
        font-size: 1.1rem;
    }
    
    .pass-price {
        color: var(--primary-color);
        font-weight: 700;
        font-size: 1.2rem;
    }
    
    .pass-features {
        list-style: none;
        margin: 0;
        padding: 0;
    }
    
    .pass-features li {
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .pass-features li i {
        color: var(--primary-color);
        width: 1rem;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
        color: white;
        padding: 1rem 2rem;
        border: none;
        border-radius: 0.75rem;
        font-weight: 600;
        font-size: 1.125rem;
        cursor: pointer;
        transition: all 0.2s ease;
        width: 100%;
    }
    
    /* ðŸŽ¨ Professional Booking Animations */
    @keyframes selectedPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.15); }
        100% { transform: scale(1); }
    }
    
    @keyframes counterPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    
    @keyframes feedbackSlide {
        0% { 
            opacity: 0; 
            transform: translate(-50%, -50%) translateY(-20px) scale(0.9); 
        }
        100% { 
            opacity: 1; 
            transform: translate(-50%, -50%) translateY(0) scale(1); 
        }
    }
    
    @keyframes rippleEffect {
        to {
            transform: scale(4);
            opacity: 0;
        }
    }
    
    @keyframes slideIn {
        0% { 
            opacity: 0; 
            transform: translateX(20px); 
        }
        100% { 
            opacity: 1; 
            transform: translateX(0); 
        }
    }
    
    @keyframes slotGlow {
        0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
        100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }
    
    /* Professional slot selection styles */
    .professional-slot-item {
        position: relative;
        overflow: hidden;
    }
    
    .professional-slot-item::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--primary-color), #059669);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .professional-slot-item:hover::after,
    .professional-slot-item.selected::after {
        opacity: 1;
    }
    
    .professional-slot-item:hover {
        animation: slotGlow 1.5s ease-in-out;
    }
    
    /* Amenity professional styling */
    .amenity-item {
        position: relative;
        overflow: visible;
    }
    
    .amenity-item::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #f59e0b, #d97706);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .amenity-item:hover::after,
    .amenity-item.selected::after {
        opacity: 1;
    }
    
    /* Enhanced Slot Selection Styling */
    .slot-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
        overflow: visible;
        padding: 20px 0; /* Add padding to accommodate indicators */
    }
    
    /* Ensure amenity containers allow indicator overflow */
    #freeAmenitiesContainer,
    #paidAmenitiesContainer {
        overflow: visible;
        padding: 20px 0;
    }
    
    #freeAmenitiesContainer .slot-container,
    #paidAmenitiesContainer .slot-container {
        overflow: visible;
        padding: 20px 0;
    }
    
    /* Force amenity indicators to be visible */
    .amenity-selected-indicator {
        position: absolute !important;
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        z-index: 1000 !important;
        pointer-events: none !important;
        background: linear-gradient(135deg, var(--primary-color), #059669) !important;
        color: white !important;
        border-radius: 50% !important;
        border: 4px solid white !important;
        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.8) !important;
        align-items: center !important;
        justify-content: center !important;
        font-weight: bold !important;
    }
    
    .slot-item {
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        background: var(--bg-secondary);
        transition: var(--transition);
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    
    .slot-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        opacity: 0;
        transition: var(--transition);
    }
    
    .slot-item:hover {
        border-color: var(--primary-color);
        background: rgba(16, 185, 129, 0.05);
        transform: translateY(-3px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
    }
    
    .slot-item:hover::before {
        opacity: 1;
    }
    
    .slot-item.selected {
        border-color: var(--primary-color);
        background: rgba(16, 185, 129, 0.1);
        transform: translateY(-3px);
        box-shadow: 0 20px 40px rgba(16, 185, 129, 0.3);
    }
    
    .slot-item.selected::before {
        opacity: 1;
    }
    
    .slot-item.unavailable {
        opacity: 0.5;
        cursor: not-allowed;
        background: var(--bg-secondary);
        border-color: #4a5568;
    }
    
    .slot-item.unavailable:hover {
        transform: none;
        box-shadow: none;
        border-color: #4a5568;
    }
    
    .slot-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .slot-time {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .slot-time i {
        color: var(--primary-color);
    }
    
    .slot-price {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--primary-color);
    }
    
    .slot-duration {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }
    
    .slot-details {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .slot-detail-tag {
        background: rgba(16, 185, 129, 0.2);
        color: var(--primary-color);
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.8rem;
        font-weight: 600;
    }

    /* ========================================
       ðŸŽ¨ PROFESSIONAL SLOT SELECTION ANIMATIONS
       ======================================== */
    
    @keyframes selectedPulse {
        0% {
            transform: scale(0.8);
            opacity: 0;
        }
        50% {
            transform: scale(1.1);
            opacity: 1;
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }
    
    @keyframes counterPulse {
        0% {
            transform: scale(0.9);
            opacity: 0.7;
        }
        50% {
            transform: scale(1.05);
            opacity: 1;
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }
    
    @keyframes feedbackSlide {
        0% {
            transform: translate(-50%, -50%) scale(0.8);
            opacity: 0;
        }
        15% {
            transform: translate(-50%, -50%) scale(1.05);
            opacity: 1;
        }
        85% {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        100% {
            transform: translate(-50%, -50%) scale(0.95);
            opacity: 0;
        }
    }
    
    @keyframes rippleEffect {
        0% {
            transform: scale(0);
            opacity: 0.6;
        }
        100% {
            transform: scale(2);
            opacity: 0;
        }
    }
    
    @keyframes slideIn {
        0% {
            transform: translateX(-20px);
            opacity: 0;
        }
        100% {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slotGlow {
        0%, 100% {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        50% {
            box-shadow: 0 8px 30px rgba(16, 185, 129, 0.3);
        }
    }
    
    /* Professional Slot Cards */
    .professional-slot {
        will-change: transform, box-shadow, border-color;
        backdrop-filter: blur(10px);
        border: 2px solid transparent;
        background: linear-gradient(var(--card-bg), var(--card-bg)) padding-box,
                    linear-gradient(135deg, transparent, rgba(16, 185, 129, 0.1)) border-box;
    }
    
    .professional-slot:hover:not(.selected) {
        transform: translateY(-2px) scale(1.01);
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(16, 185, 129, 0.1);
        border-color: rgba(16, 185, 129, 0.3);
        animation: slotGlow 2s ease-in-out infinite;
    }
    
    .professional-slot.selected {
        transform: translateY(-4px) scale(1.02) !important;
        box-shadow: 0 20px 60px rgba(16, 185, 129, 0.4), 
                    0 0 0 3px rgba(16, 185, 129, 0.2) !important;
        border-color: var(--primary-color) !important;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05)) !important;
        z-index: 10 !important;
        animation: none;
    }
    
    .professional-slot.selected::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), #059669, #0d9488);
        border-radius: 16px 16px 0 0;
        z-index: 1;
    }
    
    .professional-slot.selected::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
        height: 100%;
        background: radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, transparent 70%);
        border-radius: 16px;
        z-index: -1;
        animation: rippleEffect 0.6s ease-out;
    }
    
    /* Selection Indicator Enhancements */
    .selected-indicator {
        animation: selectedPulse 0.6s ease-out;
    }
    
    /* Responsive Grid for Slots */
    @media (max-width: 768px) {
        .professional-slot {
            padding: 1.25rem;
            min-height: 120px;
        }
    }
    
    @media (max-width: 480px) {
        .professional-slot {
            padding: 1rem;
            min-height: 110px;
        }
    }
    
    /* Enhanced Button Interactions */
    .tab-button {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .tab-button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.1), transparent);
        transition: left 0.5s ease;
    }
    
    .tab-button:hover::before {
        left: 100%;
    }
    
    .tab-button.active {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05)) !important;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
    
        border-radius: 1rem;
        font-size: 0.8rem;
        font-weight: 500;
        border: 1px solid rgba(16, 185, 129, 0.3);
    }
    
    .slot-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid var(--border-color);
    }
    
    .slot-status.available {
        color: var(--success-color);
    }
    
    .slot-status.unavailable {
        color: var(--error-color);
    }
    
    .slot-status i {
        font-size: 0.9rem;
    }
    
    /* Membership Pass Enhanced Styling */
    .membership-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
        margin-top: 1rem;
    }
    
    .membership-pass {
        position: relative;
        overflow: hidden;
    }
    
    .membership-pass::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--accent-color), var(--secondary-color));
        opacity: 0;
        transition: var(--transition);
    }
    
    .membership-pass:hover::before,
    .membership-pass.selected::before {
        opacity: 1;
    }
    
    .btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        padding: 0.75rem 1.5rem;
        border: 2px solid var(--border-color);
        border-radius: 0.5rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-secondary:hover {
        background: var(--bg-primary);
        border-color: var(--primary-color);
        color: var(--primary-color);
    }
    
    /* Beautiful Playground Info */
    .playground-info {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: var(--bg-secondary);
        border-radius: var(--border-radius);
        transition: var(--transition);
        border: 1px solid var(--border-color);
    }
    
    .playground-info:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.2);
    }
    
    .playground-image, .playground-thumb {
        width: 100px;
        height: 100px;
        border-radius: var(--border-radius);
        object-fit: cover;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        transition: var(--transition);
    }
    
    .playground-image:hover, .playground-thumb:hover {
        transform: scale(1.05) rotate(2deg);
    }
    
    .playground-details h3 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0 0 0.5rem 0;
    }
    
    .playground-details p {
        color: var(--text-secondary);
        margin: 0.25rem 0;
        font-weight: 500;
    }
    
    /* Header Styling */
    .checkout-header {
        text-align: center;
        margin-bottom: 3rem;
        color: var(--text-primary);
    }
    
    .checkout-header h1 {
        font-size: 3rem;
        font-weight: 800;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, var(--text-primary), var(--primary-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .checkout-header p {
        font-size: 1.25rem;
        opacity: 0.9;
        font-weight: 300;
        color: var(--text-secondary);
    }
    
    /* Beautiful Step Indicator */
    .step-indicator {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 3rem;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .step {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 1.5rem;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.95rem;
        transition: var(--transition);
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
    }
    
    .step::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.2), transparent);
        transition: left 0.5s;
    }
    
    .step:hover::before {
        left: 100%;
    }
    
    .step.completed {
        background: linear-gradient(135deg, var(--success-color), #059669);
        color: white;
        box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
    }
    
    .step.active {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
        color: white;
        box-shadow: 0 8px 32px rgba(16, 185, 129, 0.4);
        animation: pulse 2s infinite;
    }
    
    .step.inactive {
        background: var(--bg-secondary);
        color: var(--text-secondary);
        border-color: var(--border-color);
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .calendar-widget {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 1rem;
        margin: 1rem 0;
    }
    
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .calendar-date {
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s ease;
        background: var(--bg-secondary);
        color: var(--text-primary);
    }
    
    .calendar-date:hover {
        background: var(--primary-color);
        color: white;
    }
    
    .calendar-date.selected {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .calendar-date.unavailable {
        background: rgba(239, 68, 68, 0.1);
        color: rgba(239, 68, 68, 0.8);
        cursor: not-allowed;
        border-color: rgba(239, 68, 68, 0.4);
    }
    
    .error-message {
        color: #dc2626;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    
    /* Layout utilities */
    .grid {
        display: grid;
    }
    
    .grid-cols-1 {
        grid-template-columns: repeat(1, minmax(0, 1fr));
    }
    
    .grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    
    .grid-cols-3 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
    }
    
    .gap-3 {
        gap: 0.75rem;
    }
    
    .gap-4 {
        gap: 1rem;
    }
    
    .gap-8 {
        gap: 2rem;
    }
    
    .flex {
        display: flex;
    }
    
    .items-center {
        align-items: center;
    }
    
    .items-start {
        align-items: flex-start;
    }
    
    .justify-center {
        justify-content: center;
    }
    
    .justify-between {
        justify-content: space-between;
    }
    
    .text-center {
        text-align: center;
    }
    
    .text-sm {
        font-size: 0.875rem;
    }
    
    .text-lg {
        font-size: 1.125rem;
    }
    
    .text-xl {
        font-size: 1.25rem;
    }
    
    .text-3xl {
        font-size: 1.875rem;
    }
    
    .font-bold {
        font-weight: 700;
    }
    
    .font-semibold {
        font-weight: 600;
    }
    
    .font-medium {
        font-weight: 500;
    }
    
    .mb-2 {
        margin-bottom: 0.5rem;
    }
    
    .mb-4 {
        margin-bottom: 1rem;
    }
    
    .mb-6 {
        margin-bottom: 1.5rem;
    }
    
    .mb-8 {
        margin-bottom: 2rem;
    }
    
    .mt-1 {
        margin-top: 0.25rem;
    }
    
    .mt-3 {
        margin-top: 0.75rem;
    }
    
    .mt-6 {
        margin-top: 1.5rem;
    }
    
    .ml-auto {
        margin-left: auto;
    }
    
    .w-full {
        width: 100%;
    }
    
    .py-8 {
        padding-top: 2rem;
        padding-bottom: 2rem;
    }
    
    .space-y-3 > * + * {
        margin-top: 0.75rem;
    }
    
    .bg-gray-200 {
        background-color: var(--bg-secondary);
    }
    
    .bg-blue-100 {
        background-color: rgba(59, 130, 246, 0.1);
    }
    
    .bg-green-100 {
        background-color: rgba(16, 185, 129, 0.1);
    }
    
    .text-gray-500 {
        color: var(--text-light);
    }
    
    .text-gray-600 {
        color: var(--text-secondary);
    }
    
    .text-gray-900 {
        color: var(--text-primary);
    }
    
    .text-blue-600 {
        color: #60a5fa;
    }
    
    .text-green-600 {
        color: var(--primary-color);
    }
    
    .text-secondary {
        color: var(--text-secondary);
    }
    
    .text-error-color {
        color: var(--error-color);
    }
    
    .hover\:underline:hover {
        text-decoration: underline;
    }
    
    /* Responsive design */
    @media (min-width: 768px) {
        .md\:grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        
        .md\:grid-cols-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }
    }
    
    @media (min-width: 1024px) {
        .lg\:grid-cols-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }
        
        .lg\:col-span-1 {
            grid-column: span 1 / span 1;
        }
        
        .lg\:col-span-2 {
            grid-column: span 2 / span 2;
        }
    }
    
    .calendar-date {
        padding: 0.5rem;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 0.5rem;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s ease;
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
    }
    
    .calendar-date:hover {
        background: var(--primary-color);
        color: white;
    }
    
    .calendar-date.selected {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .calendar-date.unavailable {
        background: rgba(239, 68, 68, 0.2);
        color: rgba(239, 68, 68, 0.8);
        cursor: not-allowed;
        border-color: rgba(239, 68, 68, 0.4);
    }
    
    .error-message {
        color: #dc2626;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    
    /* Additional missing styles */
    
    .playground-thumb {
        width: 60px;
        height: 60px;
        border-radius: 0.5rem;
        object-fit: cover;
    }
    
    .sticky {
        position: sticky;
    }
    
    .top-6 {
        top: 1.5rem;
    }
    
    .hidden {
        display: none;
    }
    
    .text-primary {
        color: var(--primary-color);
    }
    
    .py-8 {
        padding-top: 2rem;
        padding-bottom: 2rem;
    }
    
    .py-4 {
        padding-top: 1rem;
        padding-bottom: 1rem;
    }
    
    .mt-3 {
        margin-top: 0.75rem;
    }
    
    .mt-4 {
        margin-top: 1rem;
    }
    
    .mt-6 {
        margin-top: 1.5rem;
    }
    
    .w-full {
        width: 100%;
    }
    
    .space-y-3 > * + * {
        margin-top: 0.75rem;
    }
    
    /* Payment Section Styles */
    .payment-methods-grid {
        display: grid;
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .booking-summary-details {
        margin-top: 1rem;
    }
    
    .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border-color);
    }
    
    .summary-row:last-child {
        border-bottom: none;
    }
    
    .summary-row.total-row {
        border-top: 2px solid var(--primary-color);
        margin-top: 1rem;
        padding-top: 1rem;
        font-weight: 700;
        font-size: 1.1rem;
    }
    
    .summary-row .label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-secondary);
        font-weight: 500;
    }
    
    .summary-row .value {
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .summary-row.total-row .label,
    .summary-row.total-row .value {
        color: var(--primary-color);
    }
    
    /* Payment method selection enhancement */
    .payment-method.selected {
        border: 2px solid var(--primary-color);
        background: rgba(16, 185, 129, 0.05);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.2);
    }
    
    .payment-method.selected .payment-icon {
        background: var(--primary-color);
        color: white;
    }
    
    /* Payment section animation */
    #paymentSection {
        animation: slideInPayment 0.5s ease-out;
    }
    
    @keyframes slideInPayment {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Bank details styling */
    #bankDetails {
        animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Multi-Step Flow Styles */
    .step-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 3rem;
        padding: 0 2rem;
    }

    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        flex: 1;
        max-width: 200px;
    }

    .step-circle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #e5e7eb;
        color: #9ca3af;
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        transition: all 0.3s ease;
        position: relative;
        z-index: 2;
    }

    .step.completed .step-circle {
        background: var(--primary-color);
        color: white;
    }

    .step.active .step-circle {
        background: var(--primary-color);
        color: white;
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
        animation: stepPulse 2s infinite;
    }

    .step-number {
        display: block;
    }

    .step.completed .step-number {
        display: none;
    }

    .step.completed .fas {
        display: block;
    }

    .step .fas {
        display: none;
    }

    .step-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #6b7280;
        text-align: center;
        margin-top: 0.5rem;
    }

    .step.active .step-label,
    .step.completed .step-label {
        color: var(--primary-color);
        font-weight: 600;
    }

    .step-line {
        height: 2px;
        background: #e5e7eb;
        flex: 1;
        margin: 0 1rem;
        margin-top: -30px;
        position: relative;
        z-index: 1;
    }

    .step.completed + .step-line {
        background: var(--primary-color);
    }

    .step-content {
        animation: stepSlideIn 0.5s ease-out;
    }

    @keyframes stepPulse {
        0%, 100% {
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
        }
        50% {
            box-shadow: 0 0 0 8px rgba(16, 185, 129, 0.1);
        }
    }

    @keyframes stepSlideIn {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    /* Payment Container Styles */
    .payment-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-top: 2rem;
    }

    .booking-summary,
    .payment-methods {
        background: transparent;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 2rem;
        box-shadow: var(--card-shadow);
    }

    .payment-options {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin: 1.5rem 0;
    }

    .payment-option {
        position: relative;
    }

    .payment-option input[type="radio"] {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }

    .payment-option label {
        display: flex;
        align-items: center;
        padding: 1rem;
        border: 2px solid #e5e7eb;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
    }

    .payment-option label:hover {
        border-color: var(--primary-color);
        background: var(--primary-light);
    }

    .payment-option input[type="radio"]:checked + label {
        border-color: var(--primary-color);
        background: var(--primary-light);
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .payment-info {
        margin-left: 1rem;
    }

    .payment-title {
        font-weight: 600;
        color: var(--text-primary);
    }

    .payment-desc {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .payment-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }

    /* Confirmation Styles */
    .confirmation-container {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
    }

    .confirmation-summary {
        background: white;
        border-radius: var(--border-radius);
        padding: 2rem;
        box-shadow: var(--card-shadow);
        max-width: 600px;
        width: 100%;
    }

    .confirmation-section {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .confirmation-section:last-of-type {
        border-bottom: none;
        margin-bottom: 1rem;
    }

    .confirmation-section h4 {
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .confirmation-total {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        background: var(--primary-light);
        border-radius: var(--border-radius-sm);
        margin-bottom: 2rem;
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--primary-color);
    }

    .confirmation-actions {
        display: flex;
        gap: 1rem;
    }

    /* Detail Grid Styles */
    .detail-grid {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f3f4f6;
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-label {
        font-weight: 500;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .detail-value {
        font-weight: 600;
        color: var(--text-primary);
        text-align: right;
    }

    /* Summary Row Styles */
    .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f3f4f6;
    }

    .summary-row:last-child {
        border-bottom: none;
    }

    .summary-row .label {
        font-weight: 500;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .summary-row .value {
        font-weight: 600;
        color: var(--text-primary);
    }

    .summary-row.total-row {
        padding-top: 1rem;
        margin-top: 1rem;
        border-top: 2px solid var(--primary-color);
        border-bottom: none;
        font-size: 1.125rem;
    }

    .summary-row.total-row .label,
    .summary-row.total-row .value {
        color: var(--primary-color);
        font-weight: 700;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .step-indicator {
            padding: 0 1rem;
        }
        
        .step-circle {
            width: 50px;
            height: 50px;
            font-size: 1rem;
        }
        
        .step-label {
            font-size: 0.75rem;
        }
        
        .payment-container {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .payment-actions,
        .confirmation-actions {
            flex-direction: column;
        }

        .detail-row,
        .summary-row {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
        }

        .detail-value,
        .summary-row .value {
            text-align: left;
        }
    }
    
    /* Clean up - removing all duplicates and fixing styles */
</style>
{% endblock %}

{% block content %}
<!-- TIMESTAMP VERIFICATION: Page updated at Oct 2, 2025 - 6:40 AM - All checkout-headers removed -->
<div id="version-check" style="position: fixed; top: 70px; right: 10px; background: #10b981; color: white; padding: 8px 15px; border-radius: 5px; z-index: 10000; font-size: 12px; font-weight: bold;">
    âœ“ NEW VERSION LOADED
</div>

<div class="checkout-container">
    <!-- Beautiful Step Indicator -->
    <div class="step-indicator">
        <div class="step completed">
            <i class="fas fa-check"></i>
            <span>Select Playground</span>
        </div>
        <div class="step active">
            <i class="fas fa-calendar-alt"></i>
            <span>Booking Details</span>
        </div>
        <div class="step inactive">
            <i class="fas fa-credit-card"></i>
            <span>Payment</span>
        </div>
        <div class="step inactive">
            <i class="fas fa-check-circle"></i>
            <span>Confirmation</span>
        </div>
    </div>

    <form id="checkoutForm" method="post" action="javascript:void(0);" data-original-action="{% url 'bookings:create_booking' playground.id %}">>
        {% csrf_token %}
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2">
                
                <!-- Playground Information -->
                <div class="checkout-card">
                    <h2><i class="fas fa-map-marker-alt"></i> Playground Details</h2>
                    <div class="playground-info" id="playgroundInfo">
                        {% if playground.main_image %}
                        <img src="{{ playground.main_image.url }}" alt="{{ playground.name }}" class="playground-image" id="playgroundImage">
                        {% else %}
                        <img src="{% static 'images/stadium-placeholder.jpg' %}" alt="{{ playground.name }}" class="playground-image" id="playgroundImage" onerror="this.onerror=null; this.src='/media/playgrounds/gallery/stadium.jpg';">
                        {% endif %}
                        <div class="playground-details">
                            <h3 id="playgroundName">{{ playground.name }}</h3>
                            <p id="playgroundAddress"><i class="fas fa-map-marker-alt"></i> {{ playground.address }}</p>
                            <p id="playgroundPricing"><i class="fas fa-dollar-sign"></i> {{ playground.currency }} {{ playground.price_per_hour|floatformat:2 }}/hour â€¢ <i class="fas fa-users"></i> {{ playground.capacity }} capacity</p>
                            <p id="playgroundSports"><i class="fas fa-futbol"></i> {{ playground.get_sport_types_display }}</p>
                        </div>
                    </div>
                </div>

                <!-- Date Selection -->
                <div class="checkout-card">
                    <h2><i class="fas fa-calendar-alt"></i> Select Date</h2>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-calendar"></i> Booking Date</label>
                        <input type="date" name="booking_date" id="bookingDate" class="form-input" required 
                               value="{{ today }}" min="{{ today }}" max="{{ max_date }}" 
                               onchange="handleDateChangeFromInput(this.value)">
                    </div>
                </div>

                <!-- Professional Time Slots Section - From Detail.html -->
                <div class="checkout-card" id="slotsSection">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-6">
                        <h2 class="text-2xl font-bold mb-4 lg:mb-0" style="color: var(--text-primary);">
                            <i class="fas fa-clock" style="color: var(--primary-color);"></i> Available Time Slots
                        </h2>
                        <div class="flex items-center space-x-2 text-sm" style="color: var(--text-secondary);">
                            <i class="fas fa-calendar-day" style="color: var(--primary-color);"></i>
                            <span id="selectedDateDisplay" style="color: var(--text-primary);">Select Date First</span>
                        </div>
                    </div>
                    
                    <!-- Professional Slot Types Tabs -->
                    <div class="slot-tabs mb-6" style="border-bottom: 2px solid var(--border-color); padding-bottom: 0;">
                        <div class="flex space-x-2">
                            <button class="tab-button active" onclick="event.preventDefault(); switchSlotType('regular'); return false;" id="regular-tab" style="
                                padding: 0.75rem 1.5rem;
                                background: none;
                                border: none;
                                border-bottom: 3px solid var(--primary-color);
                                color: var(--primary-color);
                                cursor: pointer;
                                transition: all 0.3s ease;
                                font-weight: 600;
                                border-radius: 8px 8px 0 0;
                                background: rgba(16, 185, 129, 0.1);
                            ">
                                <i class="fas fa-clock"></i> Regular Slots
                            </button>
                            <button class="tab-button" onclick="event.preventDefault(); switchSlotType('custom'); return false;" id="custom-tab" style="
                                padding: 0.75rem 1.5rem;
                                background: none;
                                border: none;
                                border-bottom: 3px solid transparent;
                                color: var(--text-secondary);
                                cursor: pointer;
                                transition: all 0.3s ease;
                                font-weight: 500;
                                border-radius: 8px 8px 0 0;
                            ">
                                <i class="fas fa-star"></i> Custom Slots
                            </button>
                            <button class="tab-button" onclick="event.preventDefault(); switchSlotType('membership'); return false;" id="membership-tab" style="
                                padding: 0.75rem 1.5rem;
                                background: none;
                                border: none;
                                border-bottom: 3px solid transparent;
                                color: var(--text-secondary);
                                cursor: pointer;
                                transition: all 0.3s ease;
                                font-weight: 500;
                                border-radius: 8px 8px 0 0;
                            ">
                                <i class="fas fa-crown"></i> Membership
                            </button>
                        </div>
                    </div>
                    
                    <!-- Loading Spinner DISABLED -->
                    <div id="slots-loading" style="display: none !important; visibility: hidden !important;">
                        <!-- Loading disabled -->
                    </div>
                    
                    <div id="time-slots-container">
                        
                        <!-- Regular Slots -->
                        <div id="regular-slots" class="slot-content active">
                            <div id="regular-slots-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem;">
                                <!-- Dynamic content will be loaded here -->
                            </div>
                            <div id="regular-no-slots" style="display: none;">
                                <div style="text-align: center; padding: 3rem 0;">
                                    <i class="fas fa-calendar-plus" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem; opacity: 0.7;"></i>
                                    <h4 style="font-size: 1.2rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">Select a Date First</h4>
                                    <p style="color: var(--text-secondary); margin: 0;">Choose a booking date above to view available time slots</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Custom Premium Slots -->
                        <div id="custom-slots" class="slot-content" style="display: none;">
                            <div id="custom-slots-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem;">
                                <!-- Dynamic content will be loaded here -->
                            </div>
                            <div id="custom-no-slots" style="display: none;">
                                <div style="text-align: center; padding: 3rem 0;">
                                    <i class="fas fa-star" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem; opacity: 0.7;"></i>
                                    <h4 style="font-size: 1.2rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">No Custom Slots</h4>
                                    <p style="color: var(--text-secondary); margin: 0;">Custom premium slots haven't been added yet</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Membership Slots -->
                        <div id="membership-slots" class="slot-content" style="display: none;">
                            <div id="membership-slots-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem;">
                                <!-- Dynamic content will be loaded here -->
                            </div>
                            <div id="membership-no-slots" style="display: none;">
                                <div style="text-align: center; padding: 3rem 0;">
                                    <i class="fas fa-crown" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem; opacity: 0.7;"></i>
                                    <h4 style="font-size: 1.2rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">No Membership Slots</h4>
                                    <p style="color: var(--text-secondary); margin: 0;">Membership slots are not available</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="selected_slots" id="selectedSlots">
                    <input type="hidden" name="slot_type" id="slotType" value="regular">
                    <input type="hidden" name="start_time" id="startTime">
                    <input type="hidden" name="end_time" id="endTime">
                </div>

                <!-- Membership Pass Selection -->
                <div class="checkout-card" id="membershipSection" style="display: none;">
                    <h2><i class="fas fa-id-card"></i> Select Membership Pass</h2>
                    <div id="membershipPassesContainer">
                        <p class="text-secondary text-center py-8"><i class="fas fa-info-circle"></i> No membership passes available</p>
                    </div>
                    <input type="hidden" name="selected_membership_pass" id="selectedMembershipPass">
                </div>

                <!-- Amenities Selection -->
                <div class="checkout-card">
                    <h2><i class="fas fa-star"></i> Select Amenities</h2>
                    
                    <div class="slot-category">
                        <h3><i class="fas fa-gift"></i> Free Amenities</h3>
                        <div id="freeAmenitiesContainer">
                            <p class="text-secondary text-center py-4"><i class="fas fa-info-circle"></i> No free amenities available</p>
                        </div>
                    </div>

                    <div class="slot-category">
                        <h3><i class="fas fa-dollar-sign"></i> Paid Amenities</h3>
                        <div id="paidAmenitiesContainer">
                            <p class="text-secondary text-center py-4"><i class="fas fa-info-circle"></i> No paid amenities available</p>
                        </div>
                    </div>
                    
                    <input type="hidden" name="selected_amenities" id="selectedAmenities">
                </div>

                <!-- Customer Information -->
                <div class="checkout-card">
                    <h2><i class="fas fa-user"></i> Customer Information</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-user"></i> First Name *</label>
                            <input type="text" name="first_name" class="form-input" required 
                                   value="{{ user.first_name }}" placeholder="Enter your first name">
                        </div>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-user"></i> Last Name *</label>
                            <input type="text" name="last_name" class="form-input" required 
                                   value="{{ user.last_name }}" placeholder="Enter your last name">
                        </div>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-envelope"></i> Email Address *</label>
                            <input type="email" name="email" class="form-input" required 
                                   value="{{ user.email }}" placeholder="Enter your email">
                        </div>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-phone"></i> Phone Number *</label>
                            <input type="tel" name="phone_number" class="form-input" required 
                                   placeholder="Enter your phone number">
                            <input type="hidden" name="contact_phone" id="contactPhone">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-users"></i> Number of Players</label>
                        <select name="number_of_players" class="form-select" required>
                            <option value="">Select number of players</option>
                            {% for i in player_range %}
                            <option value="{{ i }}" {% if i == 2 %}selected{% endif %}>{{ i }} player{{ i|pluralize }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-comment"></i> Special Requests (Optional)</label>
                        <textarea name="special_requests" class="form-textarea" 
                                  placeholder="Any special requirements or requests..."></textarea>
                    </div>
                </div>

                <!-- Terms and Conditions -->
                <div class="checkout-card">
                    <div class="flex items-start gap-3">
                        <input type="checkbox" id="terms" name="terms" required class="mt-1">
                        <label for="terms" class="text-sm" style="color: rgba(255, 255, 255, 0.8); cursor: pointer;">
                            <i class="fas fa-shield-alt"></i> I agree to the 
                            <a href="#" class="text-blue-300 hover:underline" style="cursor: pointer;">Terms and Conditions</a> 
                            and <a href="#" class="text-blue-300 hover:underline" style="cursor: pointer;">Cancellation Policy</a>. 
                            I understand that cancellations must be made at least 24 hours in advance for a full refund.
                        </label>
                    </div>
                </div>
            </div>

            <!-- Dynamic Booking Summary Sidebar -->
            <div class="lg:col-span-1">
                <div class="booking-summary">
                    <h3><i class="fas fa-clipboard-list"></i> Booking Summary</h3>
                    
                    <!-- Selected Slots Display (Dynamic) -->
                    <div id="selectedSlotsDisplay" style="display: none;"></div>
                    
                    <div class="summary-item">
                        <span><i class="fas fa-map-marker-alt"></i> Playground</span>
                        <span class="font-medium" id="summaryPlaygroundName">{{ playground.name }}</span>
                    </div>
                    
                    <div class="summary-item">
                        <span><i class="fas fa-layer-group"></i> Slot Type</span>
                        <span id="summarySlotType">Regular</span>
                    </div>
                    
                    <div class="summary-item">
                        <span><i class="fas fa-calendar"></i> Date</span>
                        <span id="summaryDate">Select a date</span>
                    </div>
                    
                    <div class="summary-item" id="slotsRow">
                        <span><i class="fas fa-clock"></i> Time Slots</span>
                        <span id="summarySlots">Select slots</span>
                    </div>
                    
                    <div class="summary-item" id="membershipRow" style="display: none;">
                        <span><i class="fas fa-id-card"></i> Membership Pass</span>
                        <span id="summaryMembership">Not selected</span>
                    </div>
                    
                    <div class="summary-item" id="durationRow">
                        <span><i class="fas fa-hourglass-half"></i> Duration</span>
                        <span id="summaryDuration">0 hours</span>
                    </div>
                    
                    <div class="summary-item" id="amenitiesRow" style="display: none;">
                        <span><i class="fas fa-star"></i> Amenities</span>
                        <span id="summaryAmenities">None selected</span>
                    </div>
                    
                    <div class="summary-item">
                        <span><i class="fas fa-calculator"></i> Subtotal</span>
                        <span id="summarySubtotal">{{ playground.currency }} 0.00</span>
                    </div>
                    
                    <div class="summary-item" id="amenityFeeRow" style="display: none;">
                        <span><i class="fas fa-plus-circle"></i> Amenity Fees</span>
                        <span id="summaryAmenityFees">$0.00</span>
                    </div>
                    
                    <div class="summary-item">
                        <span class="font-bold"><i class="fas fa-money-check-alt"></i> Total Amount</span>
                        <span class="font-bold text-xl" id="summaryTotal">{{ playground.currency }} 0.00</span>
                    </div>
                    
                    <button type="submit" class="btn-primary mt-6 w-full" id="submitBtn" disabled>
                        <i class="fas fa-credit-card"></i> Proceed to Payment
                    </button>
                    
                    <button type="button" class="btn-secondary mt-3 w-full" onclick="history.back()">
                        <i class="fas fa-arrow-left"></i> Back to Playground
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Multi-Step Booking Flow -->
<div id="multiStepContainer" class="container mx-auto px-4 py-8" style="display: none;">
    <div class="max-w-4xl mx-auto">
        <!-- Step Indicator -->
        <div class="step-indicator mb-8">
            <div class="step completed" id="step1">
                <div class="step-circle">
                    <i class="fas fa-check"></i>
                    <span class="step-number">1</span>
                </div>
                <span class="step-label">Booking Details</span>
            </div>
            <div class="step-line"></div>
            <div class="step active" id="step2">
                <div class="step-circle">
                    <i class="fas fa-credit-card"></i>
                    <span class="step-number">2</span>
                </div>
                <span class="step-label">Payment</span>
            </div>
            <div class="step-line"></div>
            <div class="step" id="step3">
                <div class="step-circle">
                    <i class="fas fa-check-circle"></i>
                    <span class="step-number">3</span>
                </div>
                <span class="step-label">Confirmation</span>
            </div>
        </div>

        <!-- Payment Step -->
        <div id="paymentStepContent" class="step-content" style="display: none !important; visibility: hidden !important; opacity: 0 !important; position: relative !important; z-index: 9999 !important; background: white !important; padding: 0px !important; min-height: 100vh !important;">
            <!-- API Payment content will be loaded here dynamically -->
        </div>

            <div class="payment-container" style="display: block !important; visibility: visible !important; opacity: 1 !important; background: #f5f5f5 !important; padding: 20px !important; border-radius: 8px !important;">
                <!-- Booking Summary Column -->
                <div class="booking-summary" style="display: block !important; visibility: visible !important; background: white !important; padding: 20px !important; margin-bottom: 20px !important; border-radius: 8px !important;">
                    <h3 style="color: #000 !important; margin-bottom: 15px !important;"><i class="fas fa-receipt"></i> Booking Summary</h3>
                    
                    <div class="summary-item">
                        <div class="label"><i class="fas fa-calendar"></i> Date:</div>
                        <div class="value" id="paymentBookingDate">-</div>
                    </div>
                    
                    <div class="summary-item">
                        <div class="label"><i class="fas fa-clock"></i> Time:</div>
                        <div class="value" id="paymentTimeSlot">-</div>
                    </div>
                    
                    <div class="summary-item">
                        <div class="label"><i class="fas fa-users"></i> Players:</div>
                        <div class="value" id="paymentPlayers">-</div>
                    </div>
                    
                    <div class="summary-total">
                        <div class="label">Total Amount:</div>
                        <div class="value" id="paymentTotal">{{ playground.currency }} 0.00</div>
                    </div>
                    
                    <div id="bookingSummaryContent" class="booking-details">
                        <!-- Dynamic booking details will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Confirmation Step -->
        <div id="confirmationStepContent" class="step-content" style="display: none;">

            <div class="confirmation-container">
                <div class="confirmation-summary">
                    <h3><i class="fas fa-clipboard-check"></i> Final Review</h3>
                    
                    <div class="confirmation-section">
                        <h4><i class="fas fa-info-circle"></i> Booking Information</h4>
                        <div id="finalBookingDetails">
                            <!-- Final booking details will be populated here -->
                        </div>
                    </div>
                    
                    <div class="confirmation-section">
                        <h4><i class="fas fa-credit-card"></i> Payment Information</h4>
                        <div id="finalPaymentDetails">
                            <!-- Final payment details will be populated here -->
                        </div>
                    </div>
                    
                    <div class="confirmation-total">
                        <div class="label">Final Total:</div>
                        <div class="value" id="finalTotal">{{ playground.currency }} 0.00</div>
                    </div>
                    
                    <div class="confirmation-actions">
                        <button type="button" class="btn-secondary" onclick="backToPayment()">
                            <i class="fas fa-arrow-left"></i> Back to Payment
                        </button>
                        <button type="button" class="btn-primary" id="finalConfirmBtn" onclick="finalConfirmBooking()">
                            <i class="fas fa-check-circle"></i> Confirm & Complete Booking
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Section (Hidden by default) -->
<div id="paymentSection" class="container mx-auto px-4 py-8" style="display: none;">
    <div class="max-w-4xl mx-auto">
        
        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step completed">
                <i class="fas fa-check"></i>
                <span>Booking</span>
            </div>
            <div class="step-arrow"><i class="fas fa-chevron-right"></i></div>
            <div class="step active">
                <i class="fas fa-credit-card"></i>
                <span>Payment</span>
            </div>
            <div class="step-arrow"><i class="fas fa-chevron-right"></i></div>
            <div class="step">
                <i class="fas fa-check-circle"></i>
                <span>Confirmation</span>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Booking Summary -->
            <div class="lg:col-span-2">
                <div class="card">
                    <h2><i class="fas fa-receipt"></i> Booking Summary</h2>
                    <div id="bookingSummaryContent">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
            </div>
            
            <!-- Payment Summary Sidebar -->
            <div class="lg:col-span-1">
                <div class="card sticky top-6">
                    <h3><i class="fas fa-calculator"></i> Payment Summary</h3>
                    
                    <div class="summary-item">
                        <span><i class="fas fa-calendar"></i> Booking Date</span>
                        <span id="paymentBookingDate">-</span>
                    </div>
                    
                    <div class="summary-item">
                        <span><i class="fas fa-clock"></i> Time Slot</span>
                        <span id="paymentTimeSlot">-</span>
                    </div>
                    
                    <div class="summary-item">
                        <span><i class="fas fa-users"></i> Players</span>
                        <span id="paymentPlayers">-</span>
                    </div>
                    
                    <div class="summary-item border-t pt-3">
                        <span class="font-bold text-xl"><i class="fas fa-money-check-alt"></i> Total Amount</span>
                        <span class="font-bold text-xl text-green-600" id="paymentTotal">{{ playground.currency }} 0.00</span>
                    </div>
                    
                    <button type="button" class="btn-primary mt-6 w-full" id="confirmPaymentBtn" onclick="confirmPayment()">
                        <i class="fas fa-check-circle"></i> Confirm Payment
                    </button>
                    
                    <button type="button" class="btn-secondary mt-3 w-full" onclick="backToCheckout()">
                        <i class="fas fa-arrow-left"></i> Back to Booking
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ðŸš€ PROFESSIONAL DYNAMIC CHECKOUT SYSTEM - ALL BACKEND DATA
const PLAYGROUND_ID = {{ playground.id }};

// Fix missing variable definitions
const playgroundId = PLAYGROUND_ID;
const serviceFee = 0.00; // No service fee

// Set global currency variable from backend
window.playgroundCurrency = "{{ playground.currency }}";

// Get currency symbol function
function getCurrencySymbol(currency) {
    const symbols = {
        'USD': '$',
        'EUR': 'â‚¬',
        'GBP': 'Â£',
        'JPY': 'Â¥',
        'INR': 'â‚¹',
        'CAD': 'C$',
        'AUD': 'A$',
        'CHF': 'Fr',
        'CNY': 'Â¥',
        'SEK': 'kr',
        'NZD': 'NZ$',
        'BDT': 'à§³',
        'MYR': 'RM'
    };
    return symbols[currency] || currency + ' ';
}

// Get CSRF token for API requests
function getCsrfToken() {
    // Try multiple ways to get CSRF token
    let token = document.querySelector('[name=csrfmiddlewaretoken]');
    if (token && token.value) {
        console.log('ðŸ” CSRF token found in DOM:', token.value.substring(0, 10) + '...');
        return token.value;
    }
    
    // Try getting from meta tag
    token = document.querySelector('meta[name="csrf-token"]');
    if (token && token.content) {
        console.log('ðŸ” CSRF token found in meta tag:', token.content.substring(0, 10) + '...');
        return token.content;
    }
    
    // Try getting from cookies
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            console.log('ðŸ” CSRF token found in cookies:', value.substring(0, 10) + '...');
            return value;
        }
    }
    
    // Try to find it in any form on the page
    const allForms = document.querySelectorAll('form');
    for (let form of allForms) {
        const formToken = form.querySelector('[name=csrfmiddlewaretoken]');
        if (formToken && formToken.value) {
            console.log('ðŸ” CSRF token found in form:', formToken.value.substring(0, 10) + '...');
            return formToken.value;
        }
    }
    
    console.error('âŒ CSRF token not found anywhere!');
    console.log('ðŸ” Available cookies:', document.cookie);
    console.log('ðŸ” Available meta tags:', Array.from(document.querySelectorAll('meta')).map(m => m.name || m.getAttribute('property')));
    console.log('ðŸ” Available input fields:', Array.from(document.querySelectorAll('input')).map(i => i.name || i.type));
    
    // As last resort, try to get it from the server via a quick request
    return getCSRFTokenFromServer();
}

function getCSRFTokenFromServer() {
    // This is a synchronous request (not recommended but necessary for fallback)
    try {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', '/admin/', false); // Admin page always has CSRF token
        xhr.send();
        
        // Parse the response to find CSRF token
        const parser = new DOMParser();
        const doc = parser.parseFromString(xhr.responseText, 'text/html');
        const token = doc.querySelector('[name=csrfmiddlewaretoken]');
        
        if (token && token.value) {
            console.log('ðŸ” CSRF token retrieved from server:', token.value.substring(0, 10) + '...');
            return token.value;
        }
    } catch (e) {
        console.error('âŒ Failed to get CSRF token from server:', e);
    }
    
    console.warn('âš ï¸ CSRF token not found, using empty string');
    return '';
}

// Global time conversion function - converts 12-hour to 24-hour format
function convertTo24Hour(timeStr) {
    if (!timeStr) return '10:00';
    
    // Clean the input string
    timeStr = timeStr.toString().trim();
    
    // If already in 24-hour format (no AM/PM), return as is
    if (!/AM|PM/i.test(timeStr)) {
        // Ensure it's in HH:MM format
        if (/^\d{1,2}:\d{2}$/.test(timeStr)) {
            return timeStr;
        }
        return '10:00'; // fallback for invalid format
    }
    
    // Parse 12-hour format and convert to 24-hour - more flexible regex
    const timeParts = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
    if (!timeParts) {
        console.warn('Invalid time format:', timeStr);
        return '10:00'; // fallback
    }
    
    let hours = parseInt(timeParts[1], 10);
    const minutes = timeParts[2];
    const period = timeParts[3].toUpperCase();
    
    // Convert to 24-hour format
    if (period === 'AM' && hours === 12) {
        hours = 0;
    } else if (period === 'PM' && hours !== 12) {
        hours += 12;
    }
    
    // Ensure proper formatting
    return `${hours.toString().padStart(2, '0')}:${minutes}`;
}

// Show notification to user
function showNotification(title, message, type = 'info') {
    // Simple notification using browser alert for now
    // You can enhance this with a proper notification system later
    console.log(`${type.toUpperCase()}: ${title} - ${message}`);
    
    // For now, use a simple alert for critical errors
    if (type === 'error') {
        alert(`${title}: ${message}`);
    }
}

// Wrapper function for async updateBookingSummary calls
function updateBookingSummaryAsync() {
    updateBookingSummary().catch(error => {
        console.error('Failed to update booking summary:', error);
    });
}

// Missing hideAllLoadingStates function
function hideAllLoadingStates() {
    console.log('ðŸ§¹ Hiding all loading states');
    
    // Hide all possible loading elements
    const loadingElements = [
        'amenitiesLoading',
        'membershipLoading',
        'slotsLoading',
        'regularSlotsLoading',
        'customSlotsLoading',
        'membershipSlotsLoading'
    ];
    
    loadingElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.style.display = 'none';
        }
    });
    
    // Hide any loading spinners with class
    document.querySelectorAll('.loading-spinner, .loading, .spinner').forEach(el => {
        if (el) {
            el.style.display = 'none';
        }
    });
}

// Dynamic state management - no static data
let bookingState = {
    type: 'slots', // 'slots' or 'membership'
    selectedSlots: [],
    selectedMembershipPass: null,
    selectedAmenities: [],
    customSlot: null,
    selectedMembership: null,
    slotType: 'regular', // 'regular', 'custom', or 'membership'  
    selectedDate: '',
    totalAmount: 0.00,
    playgroundData: null, // Will be loaded from backend
    playgroundId: PLAYGROUND_ID // Add playground ID to state
};

// Make bookingState globally accessible
window.bookingState = bookingState;

// ðŸ”§ SAFE initialization with comprehensive null checks
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸš€ Professional Dynamic Checkout System Initialized');
    console.log('Playground ID:', PLAYGROUND_ID);
    console.log('Service Fee:', serviceFee);
    
    // Initialize booking state date
    const dateInput = document.getElementById('bookingDate');
    if (dateInput) {
        console.log('ðŸ“… Date input found:', dateInput.value);
        bookingState.selectedDate = dateInput.value || new Date().toISOString().split('T')[0];
    } else {
        console.error('âŒ Date input not found!');
    }
    
    try {
        // Load playground data from backend first
        loadPlaygroundData();
        
        // Set date constraints
        initializeDatePicker();
        
        // Load all dynamic data from backend
        loadDynamicContent();
        
        console.log('âœ… Dynamic checkout system ready');
    } catch (error) {
        console.error('âŒ Error initializing checkout system:', error);
        showSystemError('Failed to initialize checkout system');
    }
});

//load playground data from backend
async function loadPlaygroundData() {
    try {
        const response = await fetch(`/api/playground/${PLAYGROUND_ID}/`);
        if (response.ok) {
            bookingState.playgroundData = await response.json();
            console.log('âœ… Playground data loaded:', bookingState.playgroundData);
            updatePlaygroundInfo();
        } else {
            // Fallback to template data
            bookingState.playgroundData = {
                id: {{ playground.id }},
                name: "{{ playground.name|escapejs }}",
                currency: "{{ playground.currency|escapejs }}",
                pricePerHour: {{ playground.price_per_hour|default:0 }},
                address: "{{ playground.address|escapejs }}",
                capacity: {{ playground.capacity|default:0 }},
                sportTypes: "{{ playground.get_sport_types_display|escapejs }}"
            };
            updatePlaygroundInfo();
        }
    } catch (error) {
        console.error('âŒ Error loading playground data:', error);
        // Use template fallback
        bookingState.playgroundData = {
            id: {{ playground.id }},
            name: "{{ playground.name|escapejs }}",
            currency: "{{ playground.currency|escapejs }}",
            pricePerHour: {{ playground.price_per_hour|default:0 }},
            address: "{{ playground.address|escapejs }}",
            capacity: {{ playground.capacity|default:0 }},
            sportTypes: "{{ playground.get_sport_types_display|escapejs }}"
        };
        updatePlaygroundInfo();   
    }
}

// ðŸŸï¸ Update playground info display
function updatePlaygroundInfo() {
    const data = bookingState.playgroundData;
    if (!data) return;
    
    const currency = data.currency || '{{ playground.currency }}';
    const currencySymbol = getCurrencySymbol(currency);
    
    // Update playground details
    const nameElement = document.getElementById('playgroundName');
    const addressElement = document.getElementById('playgroundAddress');
    const pricingElement = document.getElementById('playgroundPricing');
    const sportsElement = document.getElementById('playgroundSports');
    
    if (nameElement) nameElement.textContent = data.name || '{{ playground.name }}';
    if (addressElement) addressElement.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${data.address || '{{ playground.address }}'}`;
    if (pricingElement) pricingElement.innerHTML = `<i class="fas fa-dollar-sign"></i> ${currencySymbol}${data.pricePerHour || 0}/hour â€¢ <i class="fas fa-users"></i> ${data.capacity || 0} capacity`;
    if (sportsElement) sportsElement.innerHTML = `<i class="fas fa-futbol"></i> ${data.sportTypes || '{{ playground.get_sport_types_display }}'}`;
}

// ðŸ“… Initialize date picker with dynamic constraints
function initializeDatePicker() {
    try {
        const today = new Date().toISOString().split('T')[0];
        const bookingDateInput = document.getElementById('bookingDate');
        if (bookingDateInput) {
            bookingDateInput.min = today;
            
            const maxDate = new Date();
            maxDate.setDate(maxDate.getDate() + 30);
            bookingDateInput.max = maxDate.toISOString().split('T')[0];
            
            // Set today's date if no date is selected
            if (!bookingDateInput.value) {
                bookingDateInput.value = today;
                bookingState.selectedDate = today;
                console.log('ðŸ“… Auto-set date to today:', today);
            }
            
            // Add event listener for date changes
            bookingDateInput.addEventListener('change', handleDateChange);
            
            // Load slots for the initial date (after a small delay to ensure DOM is ready)
            if (bookingDateInput.value) {
                console.log('ðŸ”„ Loading initial slots for date:', bookingDateInput.value);
                setTimeout(() => {
                    handleDateChangeFromInput(bookingDateInput.value);
                }, 100);
            }
        }
    } catch (error) {
        console.error('âŒ Error initializing date picker:', error);
    }
}

// ðŸ“‹ Load all dynamic content from backend
async function loadDynamicContent() {
    try {
        // Load in parallel for better performance
        await Promise.all([
            loadDynamicAmenities(),
            loadDynamicMembershipPasses(),
            initializeSlotType('regular')
        ]);
    } catch (error) {
        console.error('âŒ Error loading dynamic content:', error);
    }
}

// ðŸŒŸ Load amenities dynamically from backend
async function loadDynamicAmenities() {
    console.log('ðŸŒŸ Loading amenities from backend for playground:', PLAYGROUND_ID);
    
    try {
        // Get amenities from playground details
        const response = await fetch(`/api/playground/${PLAYGROUND_ID}/`);
        const data = await response.json();
        
        if (data && data.amenities) {
            console.log('ðŸ” Raw amenities from API:', data.amenities);
            data.amenities.forEach((amenity, index) => {
                console.log(`Amenity ${index}:`, {
                    id: amenity.id, 
                    name: amenity.name, 
                    price: amenity.price,
                    allFields: amenity
                });
            });
            renderAmenities(data.amenities);
        } else {
            // Show empty state
            showEmptyAmenities();
        }
    } catch (error) {
        console.error('âŒ Error loading amenities:', error);
        showEmptyAmenities();
    }
}

// ï¿½ REMOVED DUPLICATE FUNCTION - Using renderAmenities instead

// ðŸ—ï¸ Create amenities HTML dynamically
function createAmenitiesHTML(amenities, type) {
    const currency = bookingState.playgroundData?.currency || '{{ playground.currency }}';
    
    return amenities.map((amenity, index) => {
        const isSelected = bookingState.selectedAmenities.some(a => a.id == amenity.id);
        // Generate fallback ID if missing
        const amenityId = amenity.id || `amenity-${index}-${amenity.name?.replace(/\s+/g, '-').toLowerCase()}`;
        return `
        <div class="amenity-item ${type === 'free' ? 'free' : ''} ${isSelected ? 'selected' : ''}" 
             data-amenity-id="${amenity.id}" 
             onclick="selectAmenity('${amenity.id}', '${amenity.name}', ${amenity.price || 0})">>
            <div class="amenity-info">
                <div class="amenity-name">
                    <i class="${amenity.icon || 'fas fa-star'}"></i>
                    ${amenity.name}
                </div>
                <div class="amenity-description">${amenity.description || ''}</div>
            </div>
            <div class="amenity-price">
                ${type === 'free' ? 'Free' : `${currency} ${parseFloat(amenity.price).toFixed(2)}`}
            </div>
        </div>
        `;
    }).join('');
}

// ðŸŽ¯ REMOVED DUPLICATE FUNCTION - Using selectAmenity instead

// ðŸŽ« Load membership passes dynamically from backend with enhanced API integration
async function loadDynamicMembershipPasses() {
    console.log('ðŸŽ« Loading membership passes from backend for playground:', PLAYGROUND_ID);
    
    try {
        const container = document.getElementById('membershipPassesContainer');
        if (!container) return;
        
        container.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-primary"></i> Loading membership passes...</div>';
        
        // Use the professional membership passes API
        const response = await fetch(`/api/membership-passes/${PLAYGROUND_ID}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            }
        });
        
        console.log('ðŸ“¡ Membership passes API response:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log('ðŸ“‹ Membership passes data:', data);
            
            if (data.success && data.passes && data.passes.length > 0) {
                renderDynamicMembershipPasses(data.passes);
                
                // Store passes data for later use
                sessionStorage.setItem('membershipPassesData', JSON.stringify(data.passes));
                
                console.log('âœ… Loaded', data.passes.length, 'membership passes from API');
            } else {
                console.log('â„¹ï¸ No membership passes available for playground', PLAYGROUND_ID);
                container.innerHTML = '<div class="text-center py-4 text-secondary"><i class="fas fa-info-circle"></i> No membership passes available for this playground</div>';
            }
        } else {
            throw new Error(`API returned status ${response.status}`);
        }
    } catch (error) {
        console.error('âŒ Error loading membership passes:', error);
        
        // Try fallback to playground-specific API
        try {
            console.log('ðŸ”„ Trying fallback API...');
            const fallbackResponse = await fetch(`/playgrounds/api/membership-passes/?playground_id=${PLAYGROUND_ID}`);
            if (fallbackResponse.ok) {
                const fallbackData = await fallbackResponse.json();
                if (fallbackData.passes && fallbackData.passes.length > 0) {
                    renderDynamicMembershipPasses(fallbackData.passes);
                    return;
                }
            }
        } catch (fallbackError) {
            console.warn('âš ï¸ Fallback API also failed:', fallbackError);
        }
        
        // Show error message
        const container = document.getElementById('membershipPassesContainer');
        if (container) {
            container.innerHTML = '<div class="text-center py-4 text-error-color"><i class="fas fa-exclamation-triangle"></i> Failed to load membership passes. Please refresh the page.</div>';
        }
    }
}

// Render membership passes in slot format
function renderMembershipPassesInSlots(passes) {
    const container = document.getElementById('membership-slots-grid');
    const noSlotsDiv = document.getElementById('membership-no-slots');
    
    if (!container) {
        console.error('âŒ Membership slots container not found');
        return;
    }
    
    if (!passes || passes.length === 0) {
        container.style.display = 'none';
        if (noSlotsDiv) {
            noSlotsDiv.style.display = 'block';
        }
        return;
    }
    
    // Hide no-slots message
    if (noSlotsDiv) {
        noSlotsDiv.style.display = 'none';
    }
    
    container.style.display = 'grid';
    container.innerHTML = passes.map(pass => {
        const isSelected = bookingState.selectedMembershipPass && bookingState.selectedMembershipPass.id === pass.id;
        const isBooked = pass.is_booked || false;
        const canBook = pass.can_book !== false;
        
        return `
        <div class="membership-pass-card ${isSelected ? 'selected' : ''} ${isBooked ? 'booked' : ''}" 
             onclick="${!isBooked ? `selectMembershipPass('${pass.id}', '${pass.name}', ${pass.price}, '${pass.duration_type}', ${pass.duration_days})` : ''}"
             data-pass-id="${pass.id}"
             style="
                border: 2px solid ${isBooked ? '#ef4444' : (isSelected ? 'var(--primary-color)' : 'var(--border-color)')};
                border-radius: 16px;
                padding: 1.5rem;
                background: ${isBooked ? 'linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05))' : (isSelected ? 'linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05))' : 'linear-gradient(135deg, var(--bg-secondary), rgba(16, 185, 129, 0.05))')};
                cursor: ${isBooked ? 'not-allowed' : 'pointer'};
                transition: all 0.3s ease;
                text-align: center;
                position: relative;
                overflow: hidden;
                transform: ${isBooked ? 'none' : (isSelected ? 'translateY(-4px) scale(1.02)' : 'translateY(0) scale(1)')};
                box-shadow: ${isBooked ? '0 4px 15px rgba(239, 68, 68, 0.2)' : (isSelected ? '0 20px 50px rgba(16, 185, 129, 0.3), 0 0 0 3px rgba(16, 185, 129, 0.15)' : '0 4px 15px rgba(0, 0, 0, 0.1)')};
                opacity: ${isBooked ? '0.7' : '1'};
             ">
                    
                    <!-- Selection Indicator -->
                    ${isSelected ? `
                    <div class="membership-selected-indicator" style="
                        position: absolute;
                        top: -8px;
                        right: -8px;
                        background: linear-gradient(135deg, var(--primary-color), #059669);
                        color: white;
                        border-radius: 50%;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 14px;
                        font-weight: bold;
                        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
                        animation: selectedPulse 0.8s ease-out;
                        border: 3px solid white;
                        z-index: 15;
                    ">
                        <i class="fas fa-check"></i>
                    </div>
                    ` : ''}
                    
                    <!-- Crown Badge -->
                    <div style="
                        position: absolute;
                        top: 10px;
                        left: 10px;
                        background: linear-gradient(135deg, #f59e0b, #d97706);
                        color: white;
                        padding: 0.3rem 0.8rem;
                        border-radius: 15px;
                        font-size: 0.75rem;
                        font-weight: 600;
                    ">
                        <i class="fas fa-crown"></i> VIP
                    </div>
                    
                    <!-- Booked Badge -->
                    ${isBooked ? `
                    <div style="
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        background: linear-gradient(135deg, #ef4444, #dc2626);
                        color: white;
                        padding: 0.3rem 0.8rem;
                        border-radius: 15px;
                        font-size: 0.75rem;
                        font-weight: 600;
                        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
                        animation: bookedPulse 1s ease-out;
                        z-index: 10;
                    ">
                        <i class="fas fa-lock"></i> BOOKED
                    </div>
                    ` : ''}
                    
                    <!-- Pass Name -->
                    <div style="
                        font-size: 1.3rem;
                        font-weight: 700;
                        color: ${isSelected ? 'var(--primary-color)' : 'var(--text-primary)'};
                        margin-bottom: 0.5rem;
                        letter-spacing: 0.5px;
                        margin-top: 1rem;
                    ">
                        ${pass.name}
                    </div>
                    
                    <!-- Duration -->
                    <div style="
                        font-size: 0.9rem;
                        color: var(--text-secondary);
                        margin-bottom: 1rem;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                    ">
                        ${pass.duration_days} Days â€¢ ${pass.duration_type}
                    </div>
                    
                    <!-- Price Display -->
                    <div style="
                        font-size: 1.4rem;
                        font-weight: 700;
                        color: ${isSelected ? 'var(--primary-color)' : 'var(--primary-color)'};
                        margin-bottom: 1rem;
                    ">
                        ${pass.currency} ${parseFloat(pass.price).toFixed(2)}
                    </div>
                    
                    <!-- Description -->
                    <div style="
                        font-size: 0.85rem;
                        color: var(--text-secondary);
                        margin-bottom: 1rem;
                        line-height: 1.4;
                    ">
                        ${pass.description || 'Unlimited access to this playground'}
                    </div>
                    
                    <!-- Select Button -->
                    <div style="
                        display: inline-flex;
                        align-items: center;
                        gap: 0.5rem;
                        padding: 0.75rem 1.5rem;
                        background: ${isBooked ? 'linear-gradient(135deg, #ef4444, #dc2626)' : (isSelected ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, var(--primary-color), var(--success-color))')};
                        color: white;
                        border: none;
                        border-radius: 25px;
                        font-size: 0.9rem;
                        font-weight: 600;
                        cursor: ${isBooked ? 'not-allowed' : 'pointer'};
                        transition: all 0.3s ease;
                        opacity: ${isBooked ? '0.8' : (isSelected ? '0.9' : '1')};
                    ">
                        <i class="fas ${isBooked ? 'fa-lock' : (isSelected ? 'fa-check-circle' : 'fa-id-card')}"></i>
                        <span>${isBooked ? 'Already Booked' : (isSelected ? 'Selected' : 'Select Pass')}</span>
                    </div>
        </div>
    `}).join('');
}


// ðŸŽ¨ Render membership passes dynamically
function renderDynamicMembershipPasses(passes) {
    try {
        const container = document.getElementById('membershipPassesContainer');
        if (!container) return;
        
        const currency = bookingState.playgroundData?.currency || '{{ playground.currency }}';
        
        container.innerHTML = passes.map(pass => {
            const isSelected = bookingState.selectedMembershipPass && bookingState.selectedMembershipPass.id == pass.id;
            return `
            <div class="membership-pass ${isSelected ? 'selected' : ''}" 
                 data-pass-id="${pass.id}" 
                 onclick="selectDynamicMembershipPass(${pass.id}, '${pass.name}', ${pass.price}, '${pass.duration_type}', ${pass.duration_days})">
                <div class="membership-header">
                    <i class="fas fa-crown"></i>
                    <h4>${pass.name}</h4>
                </div>
                <div class="membership-price">${currency} ${parseFloat(pass.price).toFixed(2)}</div>
                <div class="membership-duration">${pass.duration_days} days</div>
                <input type="radio" name="membership_pass" value="${pass.id}" ${isSelected ? 'checked' : ''} style="display: none;">
            </div>
            `;
        }).join('');
    } catch (error) {
        console.error('âŒ Error rendering membership passes:', error);
    }
}

// ï¿½ Ensure updateBookingStateType function is available
if (!window.updateBookingStateType) {
    window.updateBookingStateType = function() {
        console.log('ðŸ”§ Using early-defined updateBookingStateType function');
        if (!window.bookingState) return;
        
        const hasMembershipPass = window.bookingState.selectedMembershipPass !== null && window.bookingState.selectedMembershipPass !== undefined;
        const hasSlots = (window.bookingState.selectedSlots && window.bookingState.selectedSlots.length > 0) || window.bookingState.customSlot !== null;
        
        if (hasMembershipPass) {
            window.bookingState.type = 'membership';
            console.log('ðŸŽ« [Early] Booking type set to: membership');
        } else if (hasSlots) {
            window.bookingState.type = 'slots';
            console.log('â° [Early] Booking type set to: slots');
        } else {
            window.bookingState.type = 'none';
            console.log('âŒ [Early] Booking type set to: none');
        }
    };
}

// ï¿½ðŸ‘‘ ADVANCED Professional Membership Pass Selection with Real-Time Dynamic Updates
function selectMembershipPass(passId, passName, price, durationType, durationDays) {
    console.log('ðŸŽ« ADVANCED membership pass selection:', { passId, passName, price, durationType, durationDays });
    
    const passElement = document.querySelector(`[data-pass-id="${passId}"]`);
    
    if (bookingState.selectedMembershipPass && String(bookingState.selectedMembershipPass.id) === String(passId)) {
        // DESELECT MEMBERSHIP PASS - IMMEDIATE STATE CLEARING
        bookingState.selectedMembershipPass = null;
        
        // Reset slot type to regular when membership is deselected
        currentSlotType = 'regular';
        bookingState.slotType = 'regular';
        
        console.log('ðŸ”„ Membership pass DESELECTED - clearing all states:', passName);
        
        // Remove visual selection with enhanced animation
        if (passElement) {
            passElement.classList.remove('selected');
            passElement.style.borderColor = 'var(--border-color)';
            passElement.style.background = 'var(--card-bg)';
            passElement.style.transform = 'translateY(0) scale(1)';
            passElement.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.1)';
            
            // Remove selection indicator with animation
            const indicator = passElement.querySelector('.pass-selected-indicator');
            if (indicator) {
                indicator.style.animation = 'counterPulse 0.3s ease-out';
                setTimeout(() => indicator.remove(), 300);
            }
            
            // Add professional deselection ripple effect
            createRippleEffect(passElement, 'rgba(239, 68, 68, 0.3)');
        }
        
        // Force immediate UI updates for deselection
        console.log('ðŸ”„ FORCING immediate summary reset for membership deselection');
        resetBookingSummary(); // Reset summary to default state
        updateHiddenFormFields();
        updateSelectedSlotsDisplay(); // Ensure display updates immediately
        
        // Safe call to updateBookingStateType
        if (typeof window.updateBookingStateType === 'function') {
            window.updateBookingStateType(); // Update booking state for validation
        }
        
        // Professional deselection feedback
        showSlotFeedback('deselected', 'Membership', passName);
        
        // Add visual feedback with toast/notification
        showNotification('Membership Deselected', `${passName} has been removed from your booking`, 'info');
        
        return; // Exit early for deselection
        
    } else {
        // Clear all previous membership pass selections (only one pass allowed)
        document.querySelectorAll('.membership-pass-card[data-pass-id]').forEach(pass => {
            pass.classList.remove('selected');
            pass.style.borderColor = 'var(--border-color)';
            pass.style.background = 'var(--card-bg)';
            pass.style.transform = 'translateY(0) scale(1)';
            pass.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.1)';
            
            // Remove existing indicators
            const existingIndicator = pass.querySelector('.pass-selected-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
        });
        
        // SELECT MEMBERSHIP PASS - PROPER PRICING INTEGRATION
        bookingState.selectedMembershipPass = {
            id: passId,
            name: passName,
            price: parseFloat(price),
            duration_type: durationType,
            duration_days: durationDays
        };
        
        // Update current slot type to reflect membership selection
        currentSlotType = 'membership';
        bookingState.slotType = 'membership';
        
        console.log('âœ… Membership pass SELECTED with accurate pricing:', {
            name: passName,
            price: parseFloat(price),
            duration: durationDays,
            currency: bookingState.playgroundData?.currency || 'MYR',
            slotType: currentSlotType
        });
        
        // Apply enhanced visual selection
        if (passElement) {
            passElement.classList.add('selected');
            passElement.style.borderColor = 'var(--accent-color)';
            passElement.style.background = 'linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.05))';
            passElement.style.transform = 'translateY(-3px) scale(1.02)';
            passElement.style.boxShadow = '0 15px 40px rgba(245, 158, 11, 0.25), 0 0 0 3px rgba(245, 158, 11, 0.15)';
            
            // Add professional selection indicator
            if (!passElement.querySelector('.pass-selected-indicator')) {
                const indicator = document.createElement('div');
                indicator.className = 'pass-selected-indicator';
                indicator.style.cssText = `
                    position: absolute;
                    top: -8px;
                    right: -8px;
                    background: linear-gradient(135deg, var(--accent-color), #d97706);
                    color: white;
                    border-radius: 50%;
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 14px;
                    font-weight: bold;
                    box-shadow: 0 8px 25px rgba(245, 158, 11, 0.5);
                    animation: selectedPulse 0.8s ease-out;
                    border: 3px solid white;
                    z-index: 15;
                `;
                indicator.innerHTML = '<i class="fas fa-crown"></i>';
                passElement.appendChild(indicator);
            }
            
            // Add selection ripple effect
            createRippleEffect(passElement, 'rgba(245, 158, 11, 0.4)');
        }
        
        // Professional selection feedback
        showSlotFeedback('selected', 'Membership', passName);
    }
    
    // CRITICAL: IMMEDIATE REAL-TIME UPDATES
    console.log('ðŸš€ Triggering IMMEDIATE membership pass updates...');
    
    // Force immediate booking summary update
    updateBookingSummaryAsync();
    
    // ðŸ”¥ CRITICAL FIX: Update booking state type to handle membership vs slot booking validation
    console.log('ðŸš€ UPDATING BOOKING STATE TYPE for membership pass validation...');
    if (typeof window.updateBookingStateType === 'function') {
        window.updateBookingStateType();
    } else {
        console.warn('âš ï¸ updateBookingStateType not available yet, will retry...');
        setTimeout(() => {
            if (typeof window.updateBookingStateType === 'function') {
                window.updateBookingStateType();
            }
        }, 100);
    }
    
    // Force re-render membership passes to update visual state (reduced delay)
    setTimeout(() => {
        loadDynamicMembershipPasses();
    }, 50);
    
    // Use advanced real-time update system
    triggerRealTimeUpdate(bookingState.selectedMembershipPass ? 'select' : 'deselect', 'membership-pass');
}

// Professional membership pass selection feedback
function showMembershipFeedback(action, passName) {
    const feedback = document.createElement('div');
    feedback.className = `membership-feedback ${action}`;
    feedback.style.cssText = `
        position: fixed;
        top: 30%;
        right: 20px;
        background: ${action === 'selected' ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #ef4444, #dc2626)'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        z-index: 10000;
        animation: slideIn 0.5s ease-out;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.2);
        max-width: 280px;
    `;
    
    feedback.innerHTML = `
        <div style="display: flex; align-items: center; gap: 0.75rem;">
            <div style="
                background: rgba(255, 255, 255, 0.2);
                border-radius: 50%;
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
            ">
                <i class="fas ${action === 'selected' ? 'fa-crown' : 'fa-times'}" style="font-size: 1rem;"></i>
            </div>
            <div>
                <div style="font-size: 0.85rem; opacity: 0.9;">
                    ${action === 'selected' ? 'Membership Selected' : 'Membership Removed'}
                </div>
                <div style="font-size: 1rem; font-weight: 700;">
                    ${passName}
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(feedback);
    
    setTimeout(() => {
        if (feedback.parentNode) {
            feedback.remove();
        }
    }, 2500);
}

// ï¿½ðŸŽ¯ Select membership pass dynamically
function selectDynamicMembershipPass(id, name, price, durationType, durationDays) {
    try {
        // Remove previous selection
        document.querySelectorAll('.membership-pass').forEach(pass => {
            pass.classList.remove('selected');
        });
        
        // Select new pass
        const passElement = document.querySelector(`[data-pass-id="${id}"]`);
        if (passElement) {
            passElement.classList.add('selected');
            const radioInput = passElement.querySelector('input[type="radio"]');
            if (radioInput) radioInput.checked = true;
        }
        
        bookingState.selectedMembershipPass = { 
            id, 
            name, 
            price: parseFloat(price),
            duration_type: durationType,
            duration_days: durationDays
        };
        
        const hiddenInput = document.getElementById('selectedMembershipPass');
        if (hiddenInput) hiddenInput.value = id;
        
        console.log('ðŸŽ« Selected membership pass:', name, 'Price:', price);
        updateBookingSummaryAsync();
    } catch (error) {
        console.error('âŒ Error selecting membership pass:', error);
    }
}

// â° Initialize slot type dynamically
async function initializeSlotType(type) {
    try {
        bookingState.slotType = type;
        console.log('â° Initializing slot type:', type);
        
        // Initialize regular slots view
        if (type === 'regular') {
            showSlotSelectionMessage();
        }
    } catch (error) {
        console.error('âŒ Error initializing slot type:', error);
    }
}

// ðŸ“… Handle date change dynamically
async function handleDateChange(event) {
    try {
        const selectedDate = event.target.value;
        bookingState.selectedDate = selectedDate;
        
        console.log('ðŸ“… Date changed to:', selectedDate);
        updateSelectedDateDisplay(selectedDate);
        
        // Clear existing selections
        clearSlotSelections();
        
        // Load slots based on the current slot type
        if (bookingState.slotType === 'regular' && selectedDate) {
            await loadRegularSlots(selectedDate);
        }
        
        updateBookingSummaryAsync();
    } catch (error) {
        console.error('âŒ Error handling date change:', error);
    }
}

// ðŸ§¹ Reset booking summary to default state
function resetBookingSummary() {
    console.log('ðŸ§¹ RESETTING booking summary to default state');
    
    const currency = bookingState.playgroundData?.currency || 'MYR';
    const currencySymbol = getCurrencySymbol(currency);
    
    // Reset all summary elements to zero
    updateSummaryElement('summarySlots', 'No slots selected');
    updateSummaryElement('summaryDuration', '0 hours');
    updateSummaryElement('summaryMembership', 'None selected');
    updateSummaryElement('summaryAmenities', 'None selected');
    updateSummaryElement('summarySubtotal', `${currencySymbol} 0.00`);
    updateSummaryElement('summaryTotal', `${currencySymbol} 0.00`);
    
    // Hide amenity fee row
    const amenityFeeRow = document.getElementById('amenityFeeRow');
    if (amenityFeeRow) {
        amenityFeeRow.style.display = 'none';
        console.log('ðŸ™ˆ Hidden amenity fee row');
    }
    
    // Hide all summary rows except basic ones
    toggleSummaryRow('slotsRow', false);
    toggleSummaryRow('durationRow', false);
    toggleSummaryRow('membershipRow', false);
    toggleSummaryRow('amenitiesRow', false);
    toggleSummaryRow('amenityFeeRow', false);
    
    // Reset booking state values
    bookingState.totalAmount = 0;
    bookingState.subtotal = 0;
    bookingState.amenityFees = 0;
    
    // Reset submit button
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-clock"></i> Select Time Slots or Membership';
        submitBtn.style.opacity = '0.6';
        submitBtn.style.cursor = 'not-allowed';
    }
    
    console.log('âœ… Booking summary reset complete');
}

// Clear all slot selections
function clearSlotSelections() {
    // Clear booking state
    bookingState.selectedSlots = [];
    bookingState.selectedCustomSlots = [];
    bookingState.selectedMembership = null;
    bookingState.selectedMembershipPass = null;
    bookingState.customSlot = null;
    bookingState.selectedAmenities = [];
    
    // Clear visual selections
    document.querySelectorAll('.time-slot.selected').forEach(slot => {
        slot.classList.remove('selected');
    });
    
    document.querySelectorAll('.custom-slot.selected').forEach(slot => {
        slot.classList.remove('selected');
    });
    
    document.querySelectorAll('.membership-pass.selected, .professional-slot.selected').forEach(pass => {
        pass.classList.remove('selected');
    });
    
    // Clear amenity selections and trigger change events
    document.querySelectorAll('input[type="checkbox"][data-amenity-name]').forEach(checkbox => {
        if (checkbox.checked) {
            checkbox.checked = false;
            // Trigger change event to ensure proper cleanup
            checkbox.dispatchEvent(new Event('change', { bubbles: true }));
        }
    });
    
    // Reset booking summary
    resetBookingSummary();
    
    console.log('ðŸ§¹ Cleared all slot selections and reset summary');
}

// Wrapper function for input onchange event
async function handleDateChangeFromInput(dateValue) {
    try {
        console.log('ðŸ“… Date changed from input to:', dateValue);
        
        // Update booking state
        bookingState.selectedDate = dateValue;
        updateSelectedDateDisplay(dateValue);
        
        // Clear any existing slot selections
        clearSlotSelections();
        
        // Update booking summary to reflect cleared selections
        updateBookingSummaryAsync();
        
        // Load new slots for the selected date based on current slot type
        if (bookingState.slotType === 'regular') {
            await loadRegularSlots(dateValue);
        } else if (bookingState.slotType === 'custom') {
            // Custom slots are not date-specific, but refresh them
            await loadCustomSlots();
        } else if (bookingState.slotType === 'membership') {
            // Membership passes are not date-specific, but refresh them
            await loadMembershipPasses();
        }
        
        console.log('âœ… Date change completed successfully');
    } catch (error) {
        console.error('âŒ Error handling date change from input:', error);
    }
}

// ðŸŽ° Load regular slots dynamically from backend
async function loadDynamicRegularSlots(date) {
    console.log('ðŸ“… Loading regular slots from backend for date:', date);
    
    try {
        const container = document.getElementById('regular-slots-grid');
        if (!container) return;
        
        // Show loading state
        container.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-primary"></i> Loading available slots...</div>';
        
        const response = await fetch(`/api/today-slots/${PLAYGROUND_ID}/?date=${date}`);
        const data = await response.json();
        
        if (data.success) {
            renderDynamicRegularSlots(data.slots || []);
        } else {
            showNoSlotsMessage('regular', data.message || 'No slots available for this date');
        }
    } catch (error) {
        console.error('âŒ Error loading regular slots:', error);
        showNoSlotsMessage('regular', 'Failed to load slots');
    }
}

// ðŸŽ¨ Render regular slots dynamically
function renderDynamicRegularSlots(slots) {
    try {
        const container = document.getElementById('regular-slots-grid');
        const noSlotsDiv = document.getElementById('regular-no-slots');
        
        if (!container) return;
        
        if (!slots || slots.length === 0) {
            container.innerHTML = '';
            if (noSlotsDiv) noSlotsDiv.style.display = 'block';
            return;
        }
        
        if (noSlotsDiv) noSlotsDiv.style.display = 'none';
        
        const currency = bookingState.playgroundData?.currency || '{{ playground.currency }}';
        const availableSlots = slots.filter(slot => slot.is_available);
        
        if (availableSlots.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12" style="color: var(--text-secondary);">
                    <i class="fas fa-clock" style="color: var(--error-color); font-size: 3rem; margin-bottom: 1rem; opacity: 0.7;"></i>
                    <h3 style="color: var(--text-primary); margin-bottom: 0.5rem; font-size: 1.2rem;">All Slots Booked</h3>
                    <p style="margin: 0; font-size: 0.9rem;">All time slots for this date are already booked</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = availableSlots.map(slot => `
            <div class="time-slot-card" 
                 onclick="selectDynamicSlot('${slot.id}', '${slot.time_display}', ${slot.price})"
                 data-slot-id="${slot.id}">
                <div class="slot-time">${slot.time_display || `${slot.start_time} - ${slot.end_time}`}</div>
                <div class="slot-price">${currency} ${parseFloat(slot.price || 0).toFixed(2)}</div>
                <div class="slot-duration">${slot.duration || (window.bookingState?.playgroundData?.configuration?.default_slot_duration || 60)} minutes</div>
                <div class="slot-status available">
                    <i class="fas fa-check-circle"></i>
                    <span>Available</span>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('âŒ Error rendering regular slots:', error);
    }
}

// ðŸŽ¯ Select slot dynamically
function selectDynamicSlot(slotId, slotTime, price) {
    try {
        const slotElement = document.querySelector(`[data-slot-id="${slotId}"]`);
        if (!slotElement) return;
        
        const existingIndex = bookingState.selectedSlots.findIndex(s => s.id === slotId);
        
        if (existingIndex > -1) {
            // Remove slot
            bookingState.selectedSlots.splice(existingIndex, 1);
            console.log('âž– Removed slot:', slotTime);
        } else {
            // Add slot
            bookingState.selectedSlots.push({ 
                id: slotId, 
                time: slotTime, 
                price: parseFloat(price) 
            });
            console.log('âž• Added slot:', slotTime, 'Price:', price);
        }
        
        // Re-render regular slots to update visual state
        const regularSlotsData = JSON.parse(sessionStorage.getItem('regularSlotsData') || '[]');
        if (regularSlotsData.length > 0) {
            renderRegularSlots(regularSlotsData);
        }
        
        updateBookingSummaryAsync();
    } catch (error) {
        console.error('âŒ Error selecting slot:', error);
    }
}

// Professional slot feedback and animation utilities
function showSlotFeedback(action, startTime, endTime) {
    const feedbackText = action === 'selected' 
        ? `âœ… Selected: ${startTime} - ${endTime}`
        : `ðŸ”„ Deselected: ${startTime} - ${endTime}`;
    
    console.log(`ðŸŽ¯ Slot ${action}:`, { startTime, endTime });
    
    // You can add visual toast notifications here if needed
    // For now, just console logging for debugging
}

function createRippleEffect(element, color = 'rgba(16, 185, 129, 0.4)') {
    if (!element) return;
    
    const ripple = document.createElement('div');
    ripple.style.cssText = `
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        background: ${color};
        border-radius: 50%;
        transform: translate(-50%, -50%) scale(0);
        animation: rippleEffect 0.6s ease-out;
        pointer-events: none;
        z-index: 10;
    `;
    
    element.style.position = 'relative';
    element.appendChild(ripple);
    
    setTimeout(() => {
        if (ripple.parentNode) {
            ripple.parentNode.removeChild(ripple);
        }
    }, 600);
}

// Add CSS animations for the ripple and pulse effects
const rippleStyle = document.createElement('style');
rippleStyle.textContent = `
    @keyframes rippleEffect {
        0% {
            transform: translate(-50%, -50%) scale(0);
            opacity: 1;
        }
        100% {
            transform: translate(-50%, -50%) scale(4);
            opacity: 0;
        }
    }
    
    @keyframes selectedPulse {
        0% {
            transform: scale(0.8);
            opacity: 0;
        }
        50% {
            transform: scale(1.1);
            opacity: 1;
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }
    
    @keyframes counterPulse {
        0% {
            transform: scale(1);
            opacity: 1;
        }
        100% {
            transform: scale(0.8);
            opacity: 0;
        }
    }
`;
document.head.appendChild(rippleStyle);

// ï¿½ REAL-TIME BOOKING STATE MANAGER - IMMEDIATE DYNAMIC UPDATES
function triggerRealTimeUpdate(action = 'update', slotType = 'unknown') {
    console.log(`ðŸš€ REAL-TIME UPDATE triggered: ${action} for ${slotType}`);
    
    // IMMEDIATE visual feedback
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        submitBtn.style.opacity = '0.8';
    }
    
    // Queue multiple updates with different priorities
    const updates = [
        { fn: updateBookingSummary, delay: 50, priority: 'high' },
        { fn: updateSubmitButton, delay: 100, priority: 'high' },
        { fn: updateHiddenFormFields, delay: 150, priority: 'medium' }
    ];
    
    // Execute updates in sequence
    updates.forEach(update => {
        setTimeout(() => {
            try {
                update.fn();
                console.log(`âœ… ${update.fn.name} completed (${update.priority} priority)`);
            } catch (error) {
                console.error(`âŒ Error in ${update.fn.name}:`, error);
            }
        }, update.delay);
    });
    
    // Final state verification
    setTimeout(() => {
        console.log('ðŸ” Final booking state verification:', {
            selectedSlots: bookingState.selectedSlots?.length || 0,
            customSlot: !!bookingState.customSlot,
            membershipPass: !!bookingState.selectedMembershipPass,
            totalAmount: bookingState.totalAmount
        });
    }, 300);
}

// ï¿½ðŸ“Š Professional Update Booking Summary with Backend API
async function updateBookingSummary() {
    try {
        const currency = bookingState.playgroundData?.currency || 'RM';
        const currencySymbol = getCurrencySymbol(currency);
        const playgroundName = bookingState.playgroundData?.name || '{{ playground.name }}';
        
        // Helper function to convert time to 24-hour format
        function convertTo24Hour(timeStr) {
            if (!timeStr) return '10:00';
            
            // If already in 24-hour format (no AM/PM), return as is
            if (!/AM|PM/i.test(timeStr)) {
                return timeStr.trim();
            }
            
            // Parse 12-hour format and convert to 24-hour
            const timeParts = timeStr.trim().match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
            if (!timeParts) {
                console.warn('Invalid time format:', timeStr);
                return '10:00'; // fallback
            }
            
            let hours = parseInt(timeParts[1]);
            const minutes = timeParts[2];
            const period = timeParts[3].toUpperCase();
            
            if (period === 'AM' && hours === 12) {
                hours = 0;
            } else if (period === 'PM' && hours !== 12) {
                hours += 12;
            }
            
            return `${hours.toString().padStart(2, '0')}:${minutes}`;
        }
        
        // Debug: Check if playground data is available
        console.log('ðŸ” Debug booking state:', {
            playgroundData: bookingState.playgroundData,
            playgroundId: bookingState.playgroundData?.id,
            selectedSlots: bookingState.selectedSlots,
            selectedAmenities: bookingState.selectedAmenities
        });
        
        // Skip API call if no selections made
        const hasRegularSlots = bookingState.selectedSlots && bookingState.selectedSlots.length > 0;
        const hasCustomSlot = bookingState.customSlot;
        const hasMembershipSlot = bookingState.selectedMembership;
        const hasMembershipPass = bookingState.selectedMembershipPass;
        const hasAmenities = bookingState.selectedAmenities && bookingState.selectedAmenities.length > 0;
        
        if (!hasRegularSlots && !hasCustomSlot && !hasMembershipSlot && !hasMembershipPass && !hasAmenities) {
            console.log('â³ No selections made (slots or amenities), resetting summary');
            resetBookingSummary(); // Use dedicated reset function
            return; // Exit early since nothing is selected
            updateSummaryElement('summaryDuration', '0 hours');
            
            // Hide all booking-related rows
            toggleSummaryRow('slotsRow', false);
            toggleSummaryRow('durationRow', false);
            toggleSummaryRow('membershipRow', false);
            
            // CRITICAL: Clear the selected slots display section 
            const selectedSlotsDisplay = document.getElementById('selectedSlotsDisplay');
            if (selectedSlotsDisplay) {
                selectedSlotsDisplay.style.display = 'none';
                selectedSlotsDisplay.innerHTML = '';
            }
            
            // Clear booking state completely
            bookingState.totalAmount = 0;
            bookingState.subtotal = 0;
            
            // Update hidden form fields for empty state
            updateHiddenFormFields();
            
            // Force submit button update
            updateSubmitButton();
            
            // Update the selected slots display to handle clearing
            updateSelectedSlotsDisplay();
            
            console.log('ðŸ§¹ COMPLETE CLEAR: All selections and displays cleared');
            return;
        }
        
        // ðŸŽ« HANDLE MEMBERSHIP PASS SELECTION (Use main pricing API to include amenities)
        if (hasMembershipPass && !hasRegularSlots && !hasCustomSlot && !hasMembershipSlot) {
            console.log('ðŸ‘‘ Processing membership pass WITH amenities via main API:', bookingState.selectedMembershipPass);
            
            // Don't return early - continue to main API that handles amenities
            // This ensures amenities are included in the calculation
        }
        
        // ðŸŒŸ REMOVED STATIC CUSTOM SLOT HANDLING - ALL PRICING NOW GOES THROUGH API
        // This ensures accurate backend calculations for all booking types
        
        // Skip API call if playground data is not loaded yet
        if (!bookingState.playgroundData?.id) {
            console.log('â³ Playground data not loaded yet, skipping API call');
            updateSummaryElement('summarySubtotal', `${currencySymbol} 0.00`);
            updateSummaryElement('summaryTotal', `${currencySymbol} 0.00`);
            return;
        }
        
        // Update playground name in summary
        updateSummaryElement('summaryPlaygroundName', playgroundName);
        
        // Update slot type display professionally based on actual selection with priority
        let slotTypeText = 'Regular';
        
        // Debug logging for slot type detection
        console.log('ðŸ” Slot type detection:', {
            selectedMembershipPass: !!bookingState.selectedMembershipPass,
            selectedMembership: !!bookingState.selectedMembership,
            customSlot: !!bookingState.customSlot,
            selectedSlots: bookingState.selectedSlots?.length || 0,
            currentSlotType: currentSlotType
        });
        
        // PRIORITY ORDER: Membership Pass > Custom Slot > Regular Slots
        if (bookingState.selectedMembershipPass) {
            slotTypeText = 'Membership Pass';
            currentSlotType = 'membership';
        } else if (bookingState.selectedMembership) {
            slotTypeText = 'Membership';
            currentSlotType = 'membership';
        } else if (bookingState.customSlot) {
            slotTypeText = 'Custom';
            currentSlotType = 'custom';
        } else if (bookingState.selectedSlots && bookingState.selectedSlots.length > 0) {
            slotTypeText = 'Regular';
            currentSlotType = 'regular';
        } else {
            slotTypeText = currentSlotType.charAt(0).toUpperCase() + currentSlotType.slice(1);
        }
        
        console.log('ðŸ“‹ Setting slot type to:', slotTypeText);
        updateSummaryElement('summarySlotType', slotTypeText);
        
        // Update date display
        if (bookingState.selectedDate) {
            const formattedDate = new Date(bookingState.selectedDate).toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            updateSummaryElement('summaryDate', formattedDate);
        }
        
        // Prepare data for backend calculation
        let apiUrl = '/bookings/api/calculate-price/';
        let apiParams = new URLSearchParams({
            playground_id: PLAYGROUND_ID,
            date: bookingState.selectedDate || new Date().toISOString().split('T')[0]
        });
        
        // Handle COMBINED slot selection with proper time conversion - PROFESSIONAL DYNAMIC BOOKING
        let totalBookings = [];
        let combinedStartTime = '10:00';
        let combinedEndTime = '11:00';
        
        // ðŸŽ¯ REGULAR SLOTS (can select multiple individually)
        if (bookingState.selectedSlots && bookingState.selectedSlots.length > 0) {
            const regularSlots = bookingState.selectedSlots;
            totalBookings.push({
                type: 'regular',
                count: regularSlots.length,
                slots: regularSlots
            });
            
            // Use earliest start and latest end for regular slots
            const startTimes = regularSlots.map(slot => convertTo24Hour(slot.start_time));
            const endTimes = regularSlots.map(slot => convertTo24Hour(slot.end_time));
            combinedStartTime = startTimes.sort()[0];
            combinedEndTime = endTimes.sort().reverse()[0];
        }
        
        // ðŸŒŸ CUSTOM SLOTS (individual selection)
        if (bookingState.customSlot) {
            totalBookings.push({
                type: 'custom',
                count: 1,
                slot: bookingState.customSlot
            });
            
            // Extend time range if needed
            const timeRange = bookingState.customSlot.time.split(' - ');
            if (timeRange.length === 2) {
                const customStart = convertTo24Hour(timeRange[0]);
                const customEnd = convertTo24Hour(timeRange[1]);
                
                if (customStart < combinedStartTime) combinedStartTime = customStart;
                if (customEnd > combinedEndTime) combinedEndTime = customEnd;
            }
        }
        
        // ðŸ‘‘ MEMBERSHIP SLOTS (individual selection)
        if (bookingState.selectedMembership) {
            totalBookings.push({
                type: 'membership',
                count: 1,
                slot: bookingState.selectedMembership
            });
            
            // Extend time range if needed
            const memberStart = convertTo24Hour(bookingState.selectedMembership.start_time);
            const memberEnd = convertTo24Hour(bookingState.selectedMembership.end_time);
            
            if (memberStart < combinedStartTime) combinedStartTime = memberStart;
            if (memberEnd > combinedEndTime) combinedEndTime = memberEnd;
        }
        
        // Use combined time range for API calculation
        apiParams.append('start_time', combinedStartTime);
        apiParams.append('end_time', combinedEndTime);
        
        // Add booking type information for backend
        apiParams.append('booking_types', totalBookings.map(b => b.type).join(','));
        apiParams.append('total_bookings', totalBookings.length.toString());
        
        // ðŸŽ¯ ADD AMENITIES TO API CALCULATION - ENSURES BACKEND PRICING
        if (bookingState.selectedAmenities && bookingState.selectedAmenities.length > 0) {
            // Include all amenity IDs (both numeric and generated string IDs)
            const amenityIds = bookingState.selectedAmenities
                .map(a => a.id)
                .filter(id => id !== null && id !== undefined);
            
            if (amenityIds.length > 0) {
                apiParams.append('amenity_ids', amenityIds.join(','));
                console.log('ðŸŒŸ Added amenities to API (mixed IDs):', amenityIds);
            } else {
                console.warn('âš ï¸ No valid amenity IDs found:', bookingState.selectedAmenities);
            }
        }
        
        // ðŸŽ¯ ADD MEMBERSHIP PASS TO API CALCULATION - ENSURES BACKEND PRICING
        if (bookingState.selectedMembershipPass) {
            apiParams.append('membership_pass_id', bookingState.selectedMembershipPass.id);
            console.log('ðŸ‘‘ Added membership pass to API:', bookingState.selectedMembershipPass.id);
        }
        
        // ðŸŽ¯ ADD CUSTOM SLOT DATA TO API CALCULATION
        if (bookingState.customSlot) {
            apiParams.append('custom_slot_id', bookingState.customSlot.id);
            apiParams.append('custom_slot_time', bookingState.customSlot.time);
            console.log('ðŸŒŸ Added custom slot to API:', bookingState.customSlot.id);
        }
        
        apiUrl += '?' + apiParams.toString();
        
        console.log('ðŸ“¤ Sending API request to:', apiUrl);
        console.log('ï¿½ API Parameters Debug:', {
            playground_id: apiParams.get('playground_id'),
            start_time: apiParams.get('start_time'),
            end_time: apiParams.get('end_time'),
            amenity_ids: apiParams.get('amenity_ids'),
            membership_pass_id: apiParams.get('membership_pass_id'),
            custom_slot_id: apiParams.get('custom_slot_id'),
            custom_slot_time: apiParams.get('custom_slot_time'),
            booking_types: apiParams.get('booking_types'),
            selectedAmenities: bookingState.selectedAmenities,
            customSlot: bookingState.customSlot,
            membershipPass: bookingState.selectedMembershipPass
        });
        
        // Show loading state
        updateSummaryElement('summarySubtotal', 'Calculating...');
        updateSummaryElement('summaryTotal', 'Calculating...');
        
        // Call backend API for dynamic calculation
        const response = await fetch(apiUrl, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        console.log('ðŸ“¥ API Response:', response.status, response.statusText);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('âŒ API Error Details:', {
                status: response.status,
                statusText: response.statusText,
                body: errorText
            });
            throw new Error(`API Error: ${response.status} - ${errorText}`);
        }
        
        const result = await response.json();
        console.log('ðŸ“Š API Response Data:', result);
        
        if (!result.success) {
            console.error('âŒ API calculation failed:', result.error);
            throw new Error(result.error || 'Calculation failed');
        }
        
        // Debug log the response for amenity fees
        console.log('ðŸ” Amenity calculation debug:', {
            amenity_fees: result.amenity_fees,
            breakdown: result.breakdown,
            selected_amenities: bookingState.selectedAmenities,
            amenities_count: bookingState.selectedAmenities?.length || 0
        });
        
        // Get backend-calculated amenity fees if available
        let backendAmenityFees = 0;
        if (result.amenity_fees !== undefined) {
            backendAmenityFees = parseFloat(result.amenity_fees) || 0;
        } else if (result.breakdown && result.breakdown.amenities !== undefined) {
            backendAmenityFees = parseFloat(result.breakdown.amenities) || 0;
        }
        
        console.log('ðŸ’° Backend amenity fees calculated:', backendAmenityFees);
        
        // Update summary with backend results
        const dynamicCurrency = bookingState.playgroundData?.currency || 'MYR';
        const dynamicCurrencySymbol = getCurrencySymbol(dynamicCurrency);
        
        // ðŸŽ¯ PROFESSIONAL COMBINED BOOKING SUMMARY DISPLAY
        let summaryParts = [];
        let totalDuration = 0;
        let totalSlotCount = 0;
        
        // Update slot information for COMBINED bookings
        if (totalBookings.length > 0) {
            totalBookings.forEach(booking => {
                switch(booking.type) {
                    case 'regular':
                        summaryParts.push(`${booking.count} Regular Slot${booking.count !== 1 ? 's' : ''}`);
                        totalSlotCount += booking.count;
                        totalDuration += booking.count;
                        break;
                    case 'custom':
                        summaryParts.push(`1 Custom Slot (${booking.slot.time})`);
                        totalSlotCount += 1;
                        // Parse duration from custom slot time range
                        const customRange = booking.slot.time.split(' - ');
                        if (customRange.length === 2) {
                            const start = convertTo24Hour(customRange[0]);
                            const end = convertTo24Hour(customRange[1]);
                            const startHour = parseInt(start.split(':')[0]);
                            const endHour = parseInt(end.split(':')[0]);
                            totalDuration += Math.max(1, endHour - startHour);
                        } else {
                            // Use dynamic custom slot duration from playground or default
                            const defaultCustomDuration = window.bookingState?.playgroundData?.configuration?.default_custom_duration || 2;
                            totalDuration += defaultCustomDuration;
                        }
                        break;
                    case 'membership':
                        summaryParts.push(`1 Membership Slot (${booking.slot.start_time} - ${booking.slot.end_time})`);
                        totalSlotCount += 1;
                        // Parse duration from membership slot
                        const memberStart = convertTo24Hour(booking.slot.start_time);
                        const memberEnd = convertTo24Hour(booking.slot.end_time);
                        const startHour = parseInt(memberStart.split(':')[0]);
                        const endHour = parseInt(memberEnd.split(':')[0]);
                        totalDuration += Math.max(1, endHour - startHour);
                        break;
                }
            });
            
            // Professional combined summary
            const combinedSummary = summaryParts.join(' + ');
            updateSummaryElement('summarySlots', `ðŸŽ¯ ${combinedSummary}`);
            updateSummaryElement('summaryDuration', `${totalDuration} hour${totalDuration !== 1 ? 's' : ''}`);
            
            // Show all relevant rows
            toggleSummaryRow('slotsRow', true);
            toggleSummaryRow('durationRow', true);
            
            // Show membership row if membership slot or pass is selected
            if (bookingState.selectedMembership) {
                const memberStartTime = bookingState.selectedMembership.start_time || 'N/A';
                const memberEndTime = bookingState.selectedMembership.end_time || 'N/A';
                updateSummaryElement('summaryMembership', `ðŸ‘‘ Membership Slot: ${memberStartTime} - ${memberEndTime}`);
                toggleSummaryRow('membershipRow', true);
            } else if (bookingState.selectedMembershipPass) {
                updateSummaryElement('summaryMembership', `ðŸ‘‘ Membership Pass: ${bookingState.selectedMembershipPass.name || 'Unknown'}`);
                toggleSummaryRow('membershipRow', true);
            } else {
                toggleSummaryRow('membershipRow', false);
            }
            
        } else if (bookingState.selectedMembershipPass) {
            // Handle membership pass only (no other slots)
            console.log('ðŸ‘‘ Displaying membership pass only summary');
            const membershipPass = bookingState.selectedMembershipPass;
            
            // Show pass name as slot
            updateSummaryElement('summarySlots', `ðŸ‘‘ ${membershipPass.name || 'Membership Pass'}`);
            
            // Show duration with proper formatting
            const durationType = membershipPass.duration_type || 'Weekly';
            const durationDays = membershipPass.duration_days || 14;
            updateSummaryElement('summaryDuration', `${durationType} (${durationDays} days)`);
            
            // Show membership info
            updateSummaryElement('summaryMembership', `ðŸ‘‘ ${membershipPass.name || 'Membership Pass'}`);
            
            // Show date information (membership passes have specific start dates)
            if (bookingState.selectedDate) {
                const formattedDate = new Date(bookingState.selectedDate).toLocaleDateString('en-US', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                updateSummaryElement('summaryDate', formattedDate);
            }
            
            // Show relevant rows
            toggleSummaryRow('slotsRow', true);
            toggleSummaryRow('durationRow', true);
            toggleSummaryRow('membershipRow', true);
        } else {
            // No slots selected
            updateSummaryElement('summarySlots', 'No slots selected');
            updateSummaryElement('summaryDuration', '0 hours');
            toggleSummaryRow('slotsRow', false);
            toggleSummaryRow('durationRow', false);
            toggleSummaryRow('membershipRow', false);
        }
        
        // ðŸŽ¯ PROFESSIONAL SELECTED SLOTS DISPLAY
        updateSelectedSlotsDisplay();
        
        // Update amenities display (without calculation - backend will handle pricing)
        if (bookingState.selectedAmenities && bookingState.selectedAmenities.length > 0) {
            const amenityNames = bookingState.selectedAmenities.map(a => a.name).join(', ');
            updateSummaryElement('summaryAmenities', `âœ¨ ${amenityNames}`);
            
            // FORCE show amenity row with direct DOM manipulation
            const amenitiesRow = document.getElementById('amenitiesRow');
            if (amenitiesRow) {
                amenitiesRow.style.display = 'flex';
                amenitiesRow.style.visibility = 'visible';
            }
            
            console.log('ðŸ‘ï¸ âœ… SHOWING amenities row with:', amenityNames);
            console.log('ðŸ‘ï¸ Selected amenities count:', bookingState.selectedAmenities.length);
            console.log('ðŸ‘ï¸ Amenity details:', bookingState.selectedAmenities);
        } else {
            updateSummaryElement('summaryAmenities', 'None selected');
            
            // Hide amenity rows
            const amenitiesRow = document.getElementById('amenitiesRow');
            if (amenitiesRow) {
                amenitiesRow.style.display = 'none';
            }
            toggleSummaryRow('amenityFeeRow', false);
            
            console.log('ðŸ‘ï¸ Hiding amenities row - no amenities selected');
        }
        
        // âœ… FIXED: Use backend calculated values directly - NO MORE MIXING OF FRONTEND/BACKEND
        // Backend API handles ALL pricing: base price, amenities, custom slots, membership passes
        
        console.log('ðŸ“Š Backend API Response Details:', {
            subtotal: result.subtotal,
            total_amount: result.total_amount,
            amenity_fees: result.amenity_fees,
            breakdown: result.breakdown
        });
        
        // ðŸŽ¯ CRITICAL FIX: Extract values from API response properly
        console.log('ðŸ” Raw API Response Full Object:', result);
        console.log('ðŸ” All API Response Keys:', Object.keys(result));
        console.log('ðŸ” Raw API Response Values:', Object.values(result));
        
        // ðŸš¨ CRITICAL FIX: Use ACTUAL SLOT PRICE, not backend calculation
        // The slot shows MYR 1176.00 but API returns 1201 - IGNORE API, USE SLOT PRICE!
        
        let subtotalValue = 0;
        let totalValue = 0;
        let amenityFeesValue = 0;
        
        // ðŸŽ¯ STRATEGY 1: Use actual selected slot price from frontend
        if (bookingState.selectedMembershipPass && bookingState.selectedMembershipPass.price) {
            subtotalValue = parseFloat(bookingState.selectedMembershipPass.price);
            console.log('âœ… Using ACTUAL membership pass price from slot:', subtotalValue);
        } else if (bookingState.customSlot && bookingState.customSlot.price) {
            subtotalValue = parseFloat(bookingState.customSlot.price);
            console.log('âœ… Using ACTUAL custom slot price:', subtotalValue);
        } else if (result.subtotal !== undefined) {
            subtotalValue = parseFloat(result.subtotal) || 0;
            console.log('âš ï¸ Fallback to API subtotal:', subtotalValue);
        }
        
        // ðŸŽ¯ STRATEGY 2: Get amenity fees from API (this is usually correct)
        if (result.amenity_fees !== undefined) {
            amenityFeesValue = parseFloat(result.amenity_fees) || 0;
            console.log('âœ… Using API amenity fees:', amenityFeesValue);
        } else if (result.breakdown && result.breakdown.amenities !== undefined) {
            amenityFeesValue = parseFloat(result.breakdown.amenities) || 0;
            console.log('âœ… Using breakdown amenity fees:', amenityFeesValue);
        }
        
        // ðŸŽ¯ STRATEGY 3: Calculate total from ACTUAL slot price + amenities
        totalValue = subtotalValue + amenityFeesValue;
        console.log('âœ… CALCULATED correct total from actual slot price:', totalValue);
        
        console.log('ðŸ”§ CORRECTED VALUES (using actual slot price):', {
            actualSlotPrice: subtotalValue,
            apiAmenityFees: amenityFeesValue, 
            correctedTotal: totalValue,
            apiWasWrong: `API said ${result.subtotal}, but slot shows ${subtotalValue}`
        });
        
        // Use corrected values - SLOT PRICE + API AMENITIES
        const correctSubtotal = subtotalValue;
        const correctAmenityFees = amenityFeesValue;
        const correctTotal = totalValue;
        
        console.log('ðŸ’° VALUES TO DISPLAY:', {
            subtotal: correctSubtotal,
            amenityFees: correctAmenityFees,
            total: correctTotal,
            verification: `${correctSubtotal} + ${correctAmenityFees} = ${correctTotal}`,
            slotDisplayedPrice: document.querySelector('.professional-slot .slot-price')?.textContent || 'not found',
            membershipPassData: bookingState.selectedMembershipPass
        });
        
        // Update the already declared backendAmenityFees variable
        backendAmenityFees = correctAmenityFees;
        
        // Update amenity fee display with API calculation
        console.log('ðŸ’° Backend amenity fees from API:', backendAmenityFees);
        console.log('ðŸ” Looking for existing amenity fee row...');
        
        if (backendAmenityFees > 0) {
            console.log('ðŸ’¸ Creating/updating amenity fee row...');
            
            // Create amenity fee row if it doesn't exist
            let amenityFeeRow = document.getElementById('amenityFeeRow');
            console.log('ðŸ” Existing amenity fee row found:', !!amenityFeeRow);
            
            if (!amenityFeeRow) {
                console.log('ðŸ†• Creating new amenity fee row');
                const amenityRowHtml = `
                    <div class="summary-item" id="amenityFeeRow" style="display: flex !important; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,0.1); margin: 0.5rem 0;">
                        <span style="color: rgba(255,255,255,0.8);"><i class="fas fa-plus-circle" style="margin-right: 0.5rem; color: #10B981;"></i> Amenity Fees</span>
                        <span style="color: #10B981; font-weight: 600;">+${dynamicCurrencySymbol} ${backendAmenityFees.toFixed(2)}</span>
                    </div>
                `;
                
                // Insert after subtotal row
                const subtotalRowElement = document.querySelector('#summarySubtotal')?.closest('.summary-item');
                if (subtotalRowElement) {
                    subtotalRowElement.insertAdjacentHTML('afterend', amenityRowHtml);
                    console.log('âœ… Amenity fee row inserted after subtotal');
                } else {
                    // Fallback: add to booking summary
                    const bookingSummary = document.querySelector('.booking-summary');
                    if (bookingSummary) {
                        bookingSummary.insertAdjacentHTML('beforeend', amenityRowHtml);
                        console.log('âœ… Amenity fee row inserted in booking summary');
                    }
                }
            } else {
                console.log('ðŸ”„ Updating existing amenity fee row');
                // Update existing amenity fee row
                const amenityFeeAmount = amenityFeeRow.querySelector('span:last-child');
                if (amenityFeeAmount) {
                    amenityFeeAmount.textContent = `+${dynamicCurrencySymbol} ${backendAmenityFees.toFixed(2)}`;
                    console.log('âœ… Updated amenity fee amount:', amenityFeeAmount.textContent);
                }
                amenityFeeRow.style.display = 'flex';
            }
        } else {
            console.log('ðŸš« No amenity fees to display, hiding amenity fee row');
            const amenityFeeRow = document.getElementById('amenityFeeRow');
            if (amenityFeeRow) {
                amenityFeeRow.style.display = 'none';
                console.log('ðŸ™ˆ Hidden amenity fee row');
            }
        }
        
        // FORCE UPDATE WITH API VALUES ONLY
        updateSummaryElement('summarySubtotal', `${dynamicCurrencySymbol} ${correctSubtotal.toFixed(2)}`);
        updateSummaryElement('summaryTotal', `${dynamicCurrencySymbol} ${correctTotal.toFixed(2)}`);
        
        console.log('ðŸ“Š SUMMARY ELEMENTS UPDATED WITH API VALUES:', {
            subtotalElement: document.getElementById('summarySubtotal')?.textContent,
            totalElement: document.getElementById('summaryTotal')?.textContent
        });
        
        // Update booking state with API values BEFORE other functions
        bookingState.totalAmount = correctTotal;
        bookingState.subtotal = correctSubtotal;
        bookingState.amenityFees = correctAmenityFees;
        
        console.log('ðŸ“Š BOOKING STATE UPDATED WITH API VALUES:', {
            totalAmount: bookingState.totalAmount,
            subtotal: bookingState.subtotal,
            amenityFees: bookingState.amenityFees
        });
        
        // IMMEDIATE PAYMENT BUTTON UPDATE
        const paymentButtons = document.querySelectorAll('#submitBtn, .btn-payment, .payment-btn');
        paymentButtons.forEach(btn => {
            if (btn && correctTotal > 0) {
                const newButtonText = `<i class="fas fa-credit-card"></i> Proceed to Payment - ${dynamicCurrencySymbol} ${correctTotal.toFixed(2)}`;
                btn.innerHTML = newButtonText;
                btn.disabled = false;
                console.log('ðŸ’³ IMMEDIATE button update:', newButtonText);
            }
        });
        
        // Update hidden form fields with API values
        updateHiddenFormFields();
        
        // Update submit button state with API values
        updateSubmitButton();
        
        console.log('âœ… ALL UPDATES COMPLETED WITH API VALUES');
        
        console.log('ðŸ“Š Professional booking summary updated via backend API:', {
            slotType: currentSlotType,
            selectedSlots: bookingState.selectedSlots.length,
            selectedAmenities: bookingState.selectedAmenities.length,
            totalAmount: bookingState.totalAmount,
            subtotal: bookingState.subtotal
        });
        
    } catch (error) {
        console.error('âŒ Error updating booking summary:', error);
        
        // Enhanced fallback with better error handling
        let fallbackSubtotal = 0;
        let fallbackAmenityFees = 0;
        
        // Calculate fallback pricing
        try {
            // Fallback calculation for custom slots
            if (bookingState.customSlot && bookingState.customSlot.price) {
                fallbackSubtotal = parseFloat(bookingState.customSlot.price);
                console.log('ðŸ”„ Using custom slot fallback price:', fallbackSubtotal);
            }
            // Fallback calculation for membership passes
            else if (bookingState.selectedMembershipPass && bookingState.selectedMembershipPass.price) {
                fallbackSubtotal = parseFloat(bookingState.selectedMembershipPass.price);
                console.log('ðŸ”„ Using membership pass fallback price:', fallbackSubtotal);
            }
            // Fallback calculation for regular slots
            else if (bookingState.selectedSlots && bookingState.selectedSlots.length > 0) {
                const playgroundPrice = parseFloat(bookingState.playgroundData?.price_per_hour || 50);
                fallbackSubtotal = playgroundPrice * bookingState.selectedSlots.length;
                console.log('ðŸ”„ Using regular slots fallback price:', fallbackSubtotal);
            }
            
            // Calculate amenity fees
            if (bookingState.selectedAmenities && bookingState.selectedAmenities.length > 0) {
                fallbackAmenityFees = bookingState.selectedAmenities.reduce((total, amenity) => {
                    return total + (parseFloat(amenity.price) || 0);
                }, 0);
                console.log('ðŸ”„ Using amenities fallback price:', fallbackAmenityFees);
            }
            
            const fallbackTotal = fallbackSubtotal + fallbackAmenityFees;
            const currencySymbol = getCurrencySymbol(bookingState.playgroundData?.currency || 'MYR');
            
            // Update UI with fallback values
            updateSummaryElement('summarySubtotal', `${currencySymbol} ${fallbackSubtotal.toFixed(2)}`);
            updateSummaryElement('summaryTotal', `${currencySymbol} ${fallbackTotal.toFixed(2)}`);
            
            // Update booking state
            bookingState.totalAmount = fallbackTotal;
            bookingState.subtotal = fallbackSubtotal;
            bookingState.amenityFees = fallbackAmenityFees;
            
            console.log('âœ… Fallback calculation applied:', {
                subtotal: fallbackSubtotal,
                amenityFees: fallbackAmenityFees,
                total: fallbackTotal
            });
            
        } catch (fallbackError) {
            console.error('âŒ Fallback calculation also failed:', fallbackError);
            updateSummaryElement('summarySubtotal', 'Calculation Error');
            updateSummaryElement('summaryTotal', 'Calculation Error');
        }
        
        // Show user-friendly error message
        showNotification('Calculation Error', 'Unable to calculate exact pricing. Using estimated values. Please refresh if needed.', 'warning');
    }
}

// ðŸŽ¯ PROFESSIONAL COMBINED SLOTS DISPLAY - Shows all selected slot types
function updateSelectedSlotsDisplay() {
    const selectedSlotsContainer = document.getElementById('selectedSlotsDisplay');
    if (!selectedSlotsContainer) {
        // Create container if it doesn't exist
        const summaryContainer = document.querySelector('.booking-summary');
        if (summaryContainer) {
            const displayContainer = document.createElement('div');
            displayContainer.id = 'selectedSlotsDisplay';
            displayContainer.style.cssText = `
                margin: 1rem 0;
                padding: 1.5rem;
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(245, 158, 11, 0.05));
                border: 2px solid rgba(16, 185, 129, 0.2);
                border-radius: 16px;
                transition: all 0.3s ease;
                box-shadow: 0 8px 25px rgba(16, 185, 129, 0.1);
            `;
            
            // Insert after the summary title
            const summaryTitle = summaryContainer.querySelector('h3');
            if (summaryTitle) {
                summaryTitle.insertAdjacentElement('afterend', displayContainer);
            } else {
                summaryContainer.appendChild(displayContainer);
            }
        }
    }
    
    const container = document.getElementById('selectedSlotsDisplay');
    if (!container) return;
    
    // Check if any slots are selected
    const hasRegularSlots = bookingState.selectedSlots && bookingState.selectedSlots.length > 0;
    const hasCustomSlot = bookingState.customSlot !== null;
    const hasMembershipSlot = bookingState.selectedMembership !== null;
    
    if (!hasRegularSlots && !hasCustomSlot && !hasMembershipSlot) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'block';
    
    let slotsHTML = `
        <div style="
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(16, 185, 129, 0.15);
        ">
            <div style="
                width: 40px;
                height: 40px;
                background: linear-gradient(135deg, var(--primary-color), #059669);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 18px;
                box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            ">
                <i class="fas fa-calendar-check"></i>
            </div>
            <div>
                <h4 style="margin: 0; color: var(--text-primary); font-size: 1.1rem; font-weight: 600;">
                    ðŸŽ¯ Selected Bookings
                </h4>
                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">
                    Individual & Combined Selection
                </p>
            </div>
        </div>
        <div style="display: grid; gap: 1rem;">
    `;
    
    // ðŸŽ¯ REGULAR SLOTS
    if (hasRegularSlots) {
        slotsHTML += `
            <div style="
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
                border: 1px solid rgba(16, 185, 129, 0.3);
                border-radius: 12px;
                padding: 1rem;
            ">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                    <span style="
                        background: var(--primary-color);
                        color: white;
                        padding: 0.25rem 0.75rem;
                        border-radius: 20px;
                        font-size: 0.8rem;
                        font-weight: 600;
                    ">âš¡ REGULAR</span>
                    <span style="color: var(--text-primary); font-weight: 600;">
                        ${bookingState.selectedSlots.length} Slot${bookingState.selectedSlots.length !== 1 ? 's' : ''}
                    </span>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    ${bookingState.selectedSlots.map(slot => `
                        <span style="
                            background: rgba(16, 185, 129, 0.15);
                            color: var(--primary-color);
                            padding: 0.5rem 1rem;
                            border-radius: 8px;
                            font-size: 0.9rem;
                            font-weight: 500;
                            border: 1px solid rgba(16, 185, 129, 0.3);
                        ">
                            ðŸ• ${slot.start_time || 'N/A'} - ${slot.end_time || 'N/A'}
                        </span>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // ðŸŒŸ CUSTOM SLOT
    if (hasCustomSlot) {
        slotsHTML += `
            <div style="
                background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
                border: 1px solid rgba(245, 158, 11, 0.3);
                border-radius: 12px;
                padding: 1rem;
            ">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                    <span style="
                        background: linear-gradient(135deg, #f59e0b, #d97706);
                        color: white;
                        padding: 0.25rem 0.75rem;
                        border-radius: 20px;
                        font-size: 0.8rem;
                        font-weight: 600;
                    ">â­ CUSTOM</span>
                    <span style="color: var(--text-primary); font-weight: 600;">
                        Individual Selection
                    </span>
                </div>
                <span style="
                    background: rgba(245, 158, 11, 0.15);
                    color: #d97706;
                    padding: 0.5rem 1rem;
                    border-radius: 8px;
                    font-size: 0.9rem;
                    font-weight: 500;
                    border: 1px solid rgba(245, 158, 11, 0.3);
                    display: inline-block;
                ">
                    ðŸ• ${bookingState.customSlot.time || 'N/A'}
                </span>
            </div>
        `;
    }
    
    // ðŸ‘‘ MEMBERSHIP SLOT
    if (hasMembershipSlot) {
        slotsHTML += `
            <div style="
                background: linear-gradient(135deg, rgba(147, 51, 234, 0.1), rgba(147, 51, 234, 0.05));
                border: 1px solid rgba(147, 51, 234, 0.3);
                border-radius: 12px;
                padding: 1rem;
            ">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                    <span style="
                        background: linear-gradient(135deg, #9333ea, #7c3aed);
                        color: white;
                        padding: 0.25rem 0.75rem;
                        border-radius: 20px;
                        font-size: 0.8rem;
                        font-weight: 600;
                    ">ðŸ‘‘ MEMBERSHIP</span>
                    <span style="color: var(--text-primary); font-weight: 600;">
                        Premium Selection
                    </span>
                </div>
                <span style="
                    background: rgba(147, 51, 234, 0.15);
                    color: #7c3aed;
                    padding: 0.5rem 1rem;
                    border-radius: 8px;
                    font-size: 0.9rem;
                    font-weight: 500;
                    border: 1px solid rgba(147, 51, 234, 0.3);
                    display: inline-block;
                ">
                    ðŸ• ${bookingState.selectedMembership.start_time || 'N/A'} - ${bookingState.selectedMembership.end_time || 'N/A'}
                </span>
            </div>
        `;
    }
    
    slotsHTML += '</div>';
    container.innerHTML = slotsHTML;
}

// ðŸ”§ Helper functions for summary updates
function updateSummaryElement(elementId, value) {
    try {
        const element = document.getElementById(elementId);
        if (element) element.textContent = value;
    } catch (error) {
        console.error(`âŒ Error updating element ${elementId}:`, error);
    }
}

function toggleSummaryRow(rowId, show) {
    try {
        const row = document.getElementById(rowId);
        if (row) row.style.display = show ? 'flex' : 'none';
    } catch (error) {
        console.error(`âŒ Error toggling row ${rowId}:`, error);
    }
}

function updateHiddenFormFields() {
    try {
        // Update amenities
        const selectedAmenitiesField = document.getElementById('selectedAmenities');
        if (selectedAmenitiesField) {
            selectedAmenitiesField.value = JSON.stringify(bookingState.selectedAmenities || []);
        }
        
        // Update membership pass selection
        const membershipPassField = document.getElementById('selectedMembershipPass');
        if (membershipPassField) {
            membershipPassField.value = bookingState.selectedMembershipPass ? 
                JSON.stringify(bookingState.selectedMembershipPass) : '';
        }
        
        // Update custom slot selection
        let customSlotField = document.getElementById('selectedCustomSlot');
        if (!customSlotField) {
            customSlotField = document.createElement('input');
            customSlotField.type = 'hidden';
            customSlotField.name = 'selected_custom_slot';
            customSlotField.id = 'selectedCustomSlot';
            document.getElementById('checkoutForm').appendChild(customSlotField);
        }
        customSlotField.value = bookingState.customSlot ? JSON.stringify(bookingState.customSlot) : '';
        
        // Update membership slot selection
        let membershipSlotField = document.getElementById('selectedMembershipSlot');
        if (!membershipSlotField) {
            membershipSlotField = document.createElement('input');
            membershipSlotField.type = 'hidden';
            membershipSlotField.name = 'selected_membership_slot';
            membershipSlotField.id = 'selectedMembershipSlot';
            document.getElementById('checkoutForm').appendChild(membershipSlotField);
        }
        membershipSlotField.value = bookingState.selectedMembership ? JSON.stringify(bookingState.selectedMembership) : '';
        
        // Update regular slots
        let slotsField = document.getElementById('selectedSlots');
        if (!slotsField) {
            slotsField = document.createElement('input');
            slotsField.type = 'hidden';
            slotsField.name = 'selected_slots';
            slotsField.id = 'selectedSlots';
            document.getElementById('checkoutForm').appendChild(slotsField);
        }
        slotsField.value = JSON.stringify(bookingState.selectedSlots || []);
        
        // Update total amount
        let totalField = document.getElementById('hiddenTotalAmount');
        if (!totalField) {
            totalField = document.createElement('input');
            totalField.type = 'hidden';
            totalField.name = 'total_amount';
            totalField.id = 'hiddenTotalAmount';
            document.getElementById('checkoutForm').appendChild(totalField);
        }
        totalField.value = bookingState.totalAmount || 0;
        
        // Update slot IDs for backwards compatibility
        if (bookingState.selectedSlots && bookingState.selectedSlots.length > 0) {
            const slotIds = bookingState.selectedSlots.map(s => s.id);
            let slotIdsField = document.getElementById('selectedSlotIds');
            if (!slotIdsField) {
                slotIdsField = document.createElement('input');
                slotIdsField.type = 'hidden';
                slotIdsField.name = 'selected_slot_ids';
                slotIdsField.id = 'selectedSlotIds';
                document.getElementById('checkoutForm').appendChild(slotIdsField);
            }
            slotIdsField.value = JSON.stringify(slotIds);
        }
        
        // CRITICAL: Update basic start_time and end_time fields for backend
        const startTimeField = document.getElementById('startTime');
        const endTimeField = document.getElementById('endTime');
        
        if (bookingState.selectedSlots && bookingState.selectedSlots.length > 0) {
            // For regular slots
            const firstSlot = bookingState.selectedSlots[0];
            const lastSlot = bookingState.selectedSlots[bookingState.selectedSlots.length - 1];
            
            if (startTimeField) startTimeField.value = convertTo24Hour(firstSlot.start_time) || '09:00';
            if (endTimeField) endTimeField.value = convertTo24Hour(lastSlot.end_time) || '10:00';
            
        } else if (bookingState.customSlot) {
            // For custom slots
            const timeString = bookingState.customSlot.time || '09:00 - 10:00';
            const timeParts = timeString.split(' - ');
            
            if (startTimeField) startTimeField.value = convertTo24Hour(timeParts[0]) || '09:00';
            if (endTimeField) endTimeField.value = convertTo24Hour(timeParts[1]) || '10:00';
            
        } else {
            // Default fallback
            if (startTimeField) startTimeField.value = '09:00';
            if (endTimeField) endTimeField.value = '10:00';
        }
        
        console.log('ðŸ• Time fields updated:', {
            start_time: startTimeField?.value,
            end_time: endTimeField?.value
        });
        
        console.log('âœ… Hidden form fields updated:', {
            regularSlots: bookingState.selectedSlots?.length || 0,
            customSlot: !!bookingState.customSlot,
            membershipSlot: !!bookingState.selectedMembership,
            membershipPass: !!bookingState.selectedMembershipPass,
            totalAmount: bookingState.totalAmount
        });
        
    } catch (error) {
        console.error('âŒ Error updating hidden form fields:', error);
    }
}

// ðŸ”§ ADVANCED Submit Button with Real-Time Dynamic Updates
function updateSubmitButton() {
    try {
        const submitBtn = document.getElementById('submitBtn');
        if (!submitBtn) return;
        
        let canSubmit = false;
        let buttonText = '';
        let displayAmount = 0; // DECLARE AT TOP TO AVOID SCOPE ISSUES
        
        // Check if any selections are made (individual slot booking support)
        const hasRegularSlots = bookingState.selectedSlots && bookingState.selectedSlots.length > 0;
        const hasCustomSlot = bookingState.customSlot;
        const hasMembershipSlot = bookingState.selectedMembership;
        const hasMembershipPass = bookingState.selectedMembershipPass;
        const hasAnySelection = hasRegularSlots || hasCustomSlot || hasMembershipSlot || hasMembershipPass;
        
        // Get real-time currency and amount
        const currency = bookingState.playgroundData?.currency || 'MYR';
        const currencySymbol = getCurrencySymbol(currency);
        
        if (!bookingState.selectedDate) {
            buttonText = '<i class="fas fa-calendar"></i> Select Date First';
        } else if (hasAnySelection) {
            // Enable payment for any individual or combined booking
            canSubmit = true;
            
            // REAL-TIME AMOUNT CALCULATION - IMMEDIATE UPDATE
            // Priority 1: Use API calculated total if available (includes amenities)
            if (bookingState.totalAmount && bookingState.totalAmount > 0) {
                displayAmount = bookingState.totalAmount;
                console.log('ðŸ’° Using API total amount:', displayAmount);
            }
            // Priority 2: Calculate based on selection type for fallback
            else if (hasMembershipPass && !hasRegularSlots && !hasCustomSlot && !hasMembershipSlot) {
                // Pure membership pass booking
                displayAmount = bookingState.selectedMembershipPass.price || 0;
                console.log('ðŸ’° Using membership pass price:', displayAmount);
            } else if (hasCustomSlot && !hasRegularSlots && !hasMembershipSlot && !hasMembershipPass) {
                // Pure custom slot booking
                displayAmount = bookingState.customSlot.price || 0;
                console.log('ðŸ’° Using custom slot price:', displayAmount);
            } else {
                // Fallback calculation
                displayAmount = bookingState.totalAmount || 0;
                console.log('ðŸ’° Using fallback total amount:', displayAmount);
            }
            
            buttonText = `<i class="fas fa-credit-card"></i> Proceed to Payment - ${currencySymbol} ${displayAmount.toFixed(2)}`;
            
            console.log('ðŸ’° Real-time payment button update:', {
                hasMembershipPass,
                hasCustomSlot,
                hasRegularSlots,
                displayAmount,
                currency: currencySymbol
            });
            
        } else {
            // No selections made
            buttonText = '<i class="fas fa-clock"></i> Select Time Slots or Membership';
        }
        
        // IMMEDIATE VISUAL UPDATE
        submitBtn.disabled = !canSubmit;
        submitBtn.innerHTML = buttonText;
        submitBtn.style.cursor = canSubmit ? 'pointer' : 'not-allowed';
        submitBtn.style.opacity = canSubmit ? '1' : '0.6';
        
        // Add professional button animation for state changes
        if (canSubmit) {
            submitBtn.style.background = 'linear-gradient(135deg, var(--primary-color), var(--primary-hover))';
            submitBtn.style.boxShadow = '0 8px 32px rgba(16, 185, 129, 0.3)';
            submitBtn.style.transform = 'translateY(-2px)';
        } else {
            submitBtn.style.background = 'var(--bg-secondary)';
            submitBtn.style.boxShadow = 'none';
            submitBtn.style.transform = 'translateY(0)';
        }
        
        console.log('ðŸ”„ Submit button REAL-TIME update:', { 
            canSubmit, 
            hasRegularSlots, 
            hasCustomSlot, 
            hasMembershipSlot, 
            hasMembershipPass,
            totalAmount: bookingState.totalAmount,
            finalDisplayAmount: displayAmount
        });
        
    } catch (error) {
        console.error('âŒ Error updating submit button:', error);
    }
}

// ðŸŽ¨ Helper functions for empty states
function showEmptyAmenities() {
    try {
        const freeContainer = document.getElementById('freeAmenitiesContainer');
        const paidContainer = document.getElementById('paidAmenitiesContainer');
        
        if (freeContainer) {
            freeContainer.innerHTML = '<p class="text-center py-4 text-secondary">No free amenities available</p>';
        }
        if (paidContainer) {
            paidContainer.innerHTML = '<p class="text-center py-4 text-secondary">No paid amenities available</p>';
        }
    } catch (error) {
        console.error('âŒ Error showing empty amenities:', error);
    }
}

function showSlotSelectionMessage() {
    try {
        const container = document.getElementById('regular-slots-grid');
        if (container) {
            container.innerHTML = `
                <div class="text-center py-12" style="color: var(--text-secondary);">
                    <i class="fas fa-calendar-day" style="color: var(--primary-color); font-size: 3rem; margin-bottom: 1rem; opacity: 0.7;"></i>
                    <h3 style="color: var(--text-primary); margin-bottom: 0.5rem; font-size: 1.2rem;">Select a Date</h3>
                    <p style="margin: 0; font-size: 0.9rem;">Choose your preferred booking date to see available time slots</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('âŒ Error showing slot selection message:', error);
    }
}

function showNoSlotsMessage(type, message) {
    try {
        const container = document.getElementById(`${type}-slots-grid`) || document.getElementById('regular-slots-grid');
        if (container) {
            container.innerHTML = `
                <div class="text-center py-12" style="color: var(--text-secondary);">
                    <i class="fas fa-calendar-times" style="color: var(--error-color); font-size: 3rem; margin-bottom: 1rem; opacity: 0.7;"></i>
                    <h3 style="color: var(--text-primary); margin-bottom: 0.5rem; font-size: 1.2rem;">No Available Slots</h3>
                    <p style="margin: 0; font-size: 0.9rem;">${message}</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('âŒ Error showing no slots message:', error);
    }
}

function updateSelectedDateDisplay(selectedDate) {
    try {
        const element = document.getElementById('summaryDate');
        if (element && selectedDate) {
            const date = new Date(selectedDate);
            element.textContent = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }
    } catch (error) {
        console.error('âŒ Error updating date display:', error);
    }
}

function showSystemError(message) {
    try {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'system-error';
        errorDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--error-color);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            z-index: 10000;
        `;
        errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
        document.body.appendChild(errorDiv);
        
        setTimeout(() => errorDiv.remove(), 5000);
    } catch (error) {
        console.error('âŒ Error showing system error:', error);
    }
}

// ðŸ§¹ Simple form submission handler for phone number copying
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('checkoutForm');
    if (form) {
        // Only handle phone number copying, main submission handled elsewhere
        form.addEventListener('submit', function(e) {
            console.log('ï¿½ Copying phone number to contact_phone field');
            
            // Copy phone number to contact_phone field
            const phoneNumber = document.querySelector('[name="phone_number"]');
            const contactPhone = document.getElementById('contactPhone');
            if (phoneNumber && contactPhone) {
                contactPhone.value = phoneNumber.value;
            }
            
            console.log('ðŸ“Š Final booking state:', bookingState);
        });
    }
});

// ðŸš€ PROFESSIONAL DYNAMIC CHECKOUT SYSTEM - CONSOLIDATED SINGLE SCRIPT
// All backend data integration in one clean implementation
function showBookingType(type) {
    console.log('ðŸ“‹ Switching booking type to:', type);
    
    bookingState.type = type;
    
    // Update tabs
    document.querySelectorAll('.slot-type-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Show/hide sections
    const slotsSection = document.getElementById('slotsSection');
    const membershipSection = document.getElementById('membershipSection');
    
    if (type === 'slots') {
        slotsSection.style.display = 'block';
        membershipSection.style.display = 'none';
        document.getElementById('summaryBookingType').textContent = 'Time Slots';
        
        // Show slot-related summary rows
        document.getElementById('slotsRow').style.display = 'flex';
        document.getElementById('durationRow').style.display = 'flex';
        document.getElementById('pricePerHourRow').style.display = 'flex';
        document.getElementById('membershipRow').style.display = 'none';
    } else {
        slotsSection.style.display = 'none';
        membershipSection.style.display = 'block';
        document.getElementById('summaryBookingType').textContent = 'Membership Pass';
        
        // Show membership-related summary rows
        document.getElementById('slotsRow').style.display = 'none';
        document.getElementById('durationRow').style.display = 'none';
        document.getElementById('pricePerHourRow').style.display = 'none';
        document.getElementById('membershipRow').style.display = 'flex';
    }
    
    updateBookingSummaryAsync();
}

// Professional Slot Management - Rewritten
let currentSlotType = 'regular';

// Professional Slot Type Management - SAFE VERSION WITH NULL CHECKS
function showSlotType(type) {
    console.log('â° Switching to slot type:', type);
    
    try {
        currentSlotType = type;
        bookingState.slotType = type;
        
        // Force immediate slot type update in summary
        const slotTypeText = type.charAt(0).toUpperCase() + type.slice(1);
        updateSummaryElement('summarySlotType', slotTypeText);
        console.log('ðŸ“‹ Slot type updated to:', slotTypeText);
        
        // Update tab styling - WITH NULL CHECKS
        document.querySelectorAll('.tab-button').forEach(tab => {
            if (tab) {
                tab.classList.remove('active');
                tab.style.background = 'none';
                tab.style.color = 'var(--text-secondary)';
                tab.style.borderBottom = '3px solid transparent';
            }
        });
        
        const activeTab = document.getElementById(`${type}-tab`);
        if (activeTab) {
            activeTab.classList.add('active');
            activeTab.style.background = 'rgba(16, 185, 129, 0.1)';
            activeTab.style.color = 'var(--primary-color)';
            activeTab.style.borderBottom = '3px solid var(--primary-color)';
        }
        
        // Hide all slot contents - WITH NULL CHECKS
        document.querySelectorAll('.slot-content').forEach(content => {
            if (content) {
                content.style.display = 'none';
            }
        });
        
        // Show selected content - WITH NULL CHECKS
        const targetContent = document.getElementById(`${type}-slots`);
        if (targetContent) {
            targetContent.style.display = 'block';
        }
        
        // Load appropriate content - WITH NULL CHECKS
        if (type === 'regular') {
            // For regular slots, check if date is selected and load accordingly
            const dateInput = document.getElementById('bookingDate');
            const selectedDate = dateInput ? dateInput.value : null;
            
            if (selectedDate) {
                console.log('ðŸŽ¯ Regular slots tab selected - loading for date:', selectedDate);
                loadRegularSlots(selectedDate);
            } else {
                console.log('ðŸŽ¯ Regular slots tab selected - showing "Select Date First" message');
                showSlotSelectionMessage();
            }
            
            // Clear other selections
            bookingState.selectedMembership = null;
            bookingState.customSlot = null;
        } else if (type === 'custom') {
            loadCustomSlots();
            // Clear other selections
            bookingState.selectedSlots = [];
            bookingState.selectedMembership = null;
        } else if (type === 'membership') {
            loadMembershipPasses();
            // Clear other selections
            bookingState.selectedSlots = [];
            bookingState.customSlot = null;
        }
        
        updateBookingSummaryAsync();
    } catch (error) {
        console.log('Error in showSlotType:', error);
    }
}

// Load Regular Slots - NO LOADING STATES
async function loadRegularSlots(date) {
    console.log('ðŸ“… Loading regular slots for date:', date);
    
    // Show loading indicator
    const container = document.getElementById('regular-slots-grid');
    if (container) {
        container.innerHTML = `
            <div class="text-center py-8" style="color: var(--text-secondary);">
                <i class="fas fa-spinner fa-spin" style="color: var(--primary-color); font-size: 2rem; margin-bottom: 1rem;"></i>
                <h3 style="color: var(--text-primary); margin-bottom: 0.5rem; font-size: 1.1rem;">Loading Slots...</h3>
                <p style="margin: 0; font-size: 0.9rem;">Please wait while we fetch available time slots</p>
            </div>
        `;
    }
    
    try {
        const response = await fetch(`/api/today-slots/${PLAYGROUND_ID}/?date=${date}`);
        console.log('ðŸ“¡ API Response status:', response.status);
        
        const data = await response.json();
        console.log('ðŸ“Š API Response data:', data);
        
        if (data.success) {
            const slots = data.regular_slots || data.slots || [];
            console.log('ðŸŽ° Rendering', slots.length, 'slots');
            renderRegularSlots(slots);
            updateSelectedDateDisplay(date);
            console.log('âœ… Regular slots loaded successfully');
        } else {
            console.log('âš ï¸ No regular slots found:', data.message);
            showNoSlotsMessage('regular', data.message || 'No slots available for this date');
        }
    } catch (error) {
        console.error('âŒ Error loading regular slots:', error);
        showNoSlotsMessage('regular', 'Failed to load slots');
    } finally {
        hideAllLoadingStates();
    }
}

// Load Custom Slots - Enhanced with Professional Feedback
async function loadCustomSlots() {
    console.log('â­ Loading custom slots professionally');
    
    try {
        // Include selected date to check for booking conflicts
        const selectedDate = window.bookingState?.selectedDate || document.getElementById('booking-date')?.value || new Date().toISOString().split('T')[0];
        const response = await fetch(`/api/custom-slots/${playgroundId}/?date=${selectedDate}`);
        const data = await response.json();
        
        if (data.success && data.custom_slots && data.custom_slots.length > 0) {
            // Store data for re-rendering
            sessionStorage.setItem('customSlotsData', JSON.stringify(data.custom_slots));
            renderCustomSlots(data.custom_slots);
            console.log('âœ… Custom slots loaded successfully:', data.custom_slots.length);
        } else {
            showNoSlots('custom', 'No custom slots available');
            console.log('âš ï¸ No custom slots found');
        }
    } catch (error) {
        console.error('âŒ Error loading custom slots:', error);
        showNoSlots('custom', 'Custom slots not available');
    } finally {
        hideAllLoadingStates();
    }
}

// Render Custom Slots
function renderCustomSlots(slots) {
    const container = document.getElementById('custom-slots-grid');
    const noSlotsDiv = document.getElementById('custom-no-slots');
    
    if (!container) {
        console.error('âŒ Custom slots container not found');
        return;
    }
    
    if (!slots || slots.length === 0) {
        container.style.display = 'none';
        if (noSlotsDiv) {
            noSlotsDiv.style.display = 'block';
        }
        return;
    }
    
    // Hide no-slots message
    if (noSlotsDiv) {
        noSlotsDiv.style.display = 'none';
    }
    
    // Get dynamic currency from API response
    const currency = slots.length > 0 && slots[0].currency ? slots[0].currency : 'BDT';
    const currencySymbol = slots.length > 0 && slots[0].currency_symbol ? slots[0].currency_symbol : '$';
    
    container.style.display = 'grid';
    container.innerHTML = slots.map(slot => {
        const isSelected = bookingState.customSlot && bookingState.customSlot.id === slot.id;
        const isBooked = slot.is_booked || !slot.can_book;
        return `
        <div class="premium-slot-card professional-slot-item ${isSelected ? 'selected' : ''} ${isBooked ? 'booked' : ''}" 
             ${isBooked ? '' : `onclick="selectCustomSlot('${slot.id}', '${slot.start_time} - ${slot.end_time}', ${slot.price})"`}
             data-slot-id="${slot.id}"
             style="
                border: 2px solid ${isBooked ? '#ef4444' : isSelected ? 'var(--primary-color)' : 'var(--border-color)'};
                border-radius: 16px;
                padding: 1.5rem;
                background: ${isBooked ? 'linear-gradient(135deg, #ef4444, #dc2626)' : isSelected ? 'linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(245, 158, 11, 0.05))' : 'linear-gradient(135deg, var(--bg-secondary), rgba(245, 158, 11, 0.05))'};
                cursor: ${isBooked ? 'not-allowed' : 'pointer'};
                opacity: ${isBooked ? '0.8' : '1'};
                color: ${isBooked ? 'white' : 'inherit'};
                transition: all 0.3s ease;
                text-align: center;
                position: relative;
                overflow: hidden;
                transform: ${isSelected ? 'translateY(-4px) scale(1.02)' : 'translateY(0) scale(1)'};
                box-shadow: ${isSelected ? '0 20px 50px rgba(16, 185, 129, 0.3), 0 0 0 3px rgba(16, 185, 129, 0.15)' : '0 4px 15px rgba(0, 0, 0, 0.1)'};
             ">
                    
                    <!-- Selection Indicator -->
                    ${isSelected && !isBooked ? `
                    <div class="custom-selected-indicator" style="
                        position: absolute;
                        top: -8px;
                        right: -8px;
                        background: linear-gradient(135deg, var(--primary-color), #059669);
                        color: white;
                        border-radius: 50%;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 14px;
                        font-weight: bold;
                        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
                        animation: selectedPulse 0.8s ease-out;
                        border: 3px solid white;
                        z-index: 15;
                    ">
                        <i class="fas fa-check"></i>
                    </div>
                    ` : ''}
                    
                    <!-- Booked Indicator -->
                    ${isBooked ? `
                    <div class="custom-booked-indicator" style="
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        background: rgba(255, 255, 255, 0.2);
                        color: white;
                        padding: 5px 10px;
                        border-radius: 12px;
                        font-size: 0.8rem;
                        font-weight: 600;
                        z-index: 15;
                        backdrop-filter: blur(5px);
                        border: 1px solid rgba(255, 255, 255, 0.3);
                    ">
                        <i class="fas fa-lock"></i> BOOKED
                    </div>
                    ` : ''}
                    
                    <!-- Premium Badge -->
                    <div style="
                        position: absolute;
                        top: 10px;
                        left: 10px;
                        background: linear-gradient(135deg, #f59e0b, #d97706);
                        color: white;
                        padding: 0.3rem 0.8rem;
                        border-radius: 15px;
                        font-size: 0.75rem;
                        font-weight: 600;
                    ">
                        <i class="fas fa-star"></i> ${slot.slot_type || 'Custom'}
                    </div>
                    
                    <!-- Day Display -->
                    <div style="
                        font-size: 0.9rem;
                        color: var(--text-secondary);
                        margin-bottom: 0.5rem;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        margin-top: 1rem;
                    ">
                        ${slot.day}
                    </div>
                    
                    <!-- Time Display -->
                    <div style="
                        font-size: 1.4rem;
                        font-weight: 700;
                        color: ${isSelected ? 'var(--primary-color)' : 'var(--text-primary)'};
                        margin-bottom: 1rem;
                        letter-spacing: 0.5px;
                    ">
                        ${slot.start_time} - ${slot.end_time}
                    </div>
                    
                    <!-- Duration -->
                    <div style="
                        font-size: 0.9rem;
                        color: var(--text-secondary);
                        margin-bottom: 1rem;
                    ">
                        ${slot.duration_hours || '2'} hours â€¢ Max ${slot.max_capacity || '8'} people
                    </div>
                    
                    <!-- Price Display -->
                    <div style="
                        font-size: 1.3rem;
                        font-weight: 700;
                        color: ${isSelected ? 'var(--primary-color)' : 'var(--accent-color)'};
                        margin-bottom: 1rem;
                    ">
                        ${slot.currency} ${parseFloat(slot.price || 0).toFixed(2)}
                    </div>
                    
                    <!-- Select Button -->
                    <div style="
                        display: inline-flex;
                        align-items: center;
                        gap: 0.5rem;
                        padding: 0.75rem 1.5rem;
                        background: ${isSelected ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, var(--primary-color), var(--success-color))'};
                        color: white;
                        border: none;
                        border-radius: 25px;
                        font-size: 0.9rem;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        opacity: ${isSelected ? '0.9' : '1'};
                    ">
                        <i class="fas ${isSelected ? 'fa-check-circle' : 'fa-plus-circle'}"></i>
                        <span>${isSelected ? 'Selected' : 'Select Slot'}</span>
                    </div>
                </div>
        </div>
    `}).join('');
}

// ðŸŒŸ ADVANCED Professional Custom Slot Selection with Real-Time Dynamic Updates
function selectCustomSlot(slotId, slotTime, price) {
    console.log('ðŸŒŸ ADVANCED custom slot selection:', { slotId, slotTime, price });
    
    const slotElement = document.querySelector(`[data-slot-id="${slotId}"]`);
    
    if (bookingState.customSlot && bookingState.customSlot.id === slotId) {
        // DESELECT CUSTOM SLOT - IMMEDIATE STATE CLEARING
        bookingState.customSlot = null;
        console.log('ðŸ”„ Custom slot DESELECTED - clearing all states:', slotTime);
        
        // Remove visual selection with enhanced animation
        if (slotElement) {
            slotElement.classList.remove('selected');
            slotElement.style.borderColor = 'var(--border-color)';
            slotElement.style.background = 'linear-gradient(135deg, var(--bg-secondary), rgba(245, 158, 11, 0.05))';
            slotElement.style.transform = 'translateY(0) scale(1)';
            slotElement.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.1)';
            
            // Remove selection indicator with animation
            const indicator = slotElement.querySelector('.custom-selected-indicator');
            if (indicator) {
                indicator.style.animation = 'counterPulse 0.3s ease-out';
                setTimeout(() => indicator.remove(), 300);
            }
            
            // Add professional deselection ripple effect
            createRippleEffect(slotElement, 'rgba(239, 68, 68, 0.3)');
        }
        
        // IMMEDIATE PAYMENT BUTTON UPDATE - REAL-TIME WITH FORCED SUMMARY RESET
        console.log('ðŸ”„ FORCING immediate summary reset for custom slot deselection');
        resetBookingSummary(); // Reset summary to default state
        updateHiddenFormFields();
        updateSelectedSlotsDisplay(); // Ensure display updates immediately
        
        // Professional deselection feedback
        showSlotFeedback('deselected', slotTime.split(' - ')[0], slotTime.split(' - ')[1]);
        
    } else {
        // Clear all previous custom slot selections (only one custom slot allowed)
        document.querySelectorAll('.professional-slot-item[data-slot-id]').forEach(slot => {
            // Only clear custom slots, not regular or membership slots
            if (slot.onclick && slot.onclick.toString().includes('selectCustomSlot')) {
                slot.classList.remove('selected');
                slot.style.borderColor = 'var(--border-color)';
                slot.style.background = 'linear-gradient(135deg, var(--bg-secondary), rgba(245, 158, 11, 0.05))';
                slot.style.transform = 'translateY(0) scale(1)';
                slot.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.1)';
                
                // Remove existing indicators
                const existingIndicator = slot.querySelector('.custom-selected-indicator');
                if (existingIndicator) {
                    existingIndicator.remove();
                }
            }
        });
        
        // SELECT CUSTOM SLOT - PROPER PRICING INTEGRATION
        bookingState.customSlot = {
            id: slotId,
            time: slotTime,
            price: parseFloat(price),
            type: 'custom'
        };
        console.log('âœ… Custom slot SELECTED with accurate pricing:', {
            slot: slotTime,
            price: parseFloat(price),
            currency: bookingState.playgroundData?.currency || 'MYR'
        });
        
        // Apply enhanced visual selection
        if (slotElement) {
            slotElement.classList.add('selected');
            slotElement.style.borderColor = 'var(--primary-color)';
            slotElement.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05))';
            slotElement.style.transform = 'translateY(-3px) scale(1.02)';
            slotElement.style.boxShadow = '0 15px 40px rgba(16, 185, 129, 0.25), 0 0 0 3px rgba(16, 185, 129, 0.15)';
            
            // Add professional selection indicator
            if (!slotElement.querySelector('.custom-selected-indicator')) {
                const indicator = document.createElement('div');
                indicator.className = 'custom-selected-indicator';
                indicator.style.cssText = `
                    position: absolute;
                    top: -8px;
                    right: -8px;
                    background: linear-gradient(135deg, var(--primary-color), #059669);
                    color: white;
                    border-radius: 50%;
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 14px;
                    font-weight: bold;
                    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
                    animation: selectedPulse 0.8s ease-out;
                    border: 3px solid white;
                    z-index: 15;
                `;
                indicator.innerHTML = '<i class="fas fa-check"></i>';
                slotElement.appendChild(indicator);
            }
            
            // Add selection ripple effect
            createRippleEffect(slotElement, 'rgba(16, 185, 129, 0.4)');
        }
        
        // Professional selection feedback
        showSlotFeedback('selected', slotTime.split(' - ')[0], slotTime.split(' - ')[1]);
    }
    
    // CRITICAL: IMMEDIATE REAL-TIME UPDATES
    console.log('ðŸš€ Triggering IMMEDIATE real-time updates...');
    
    // Use advanced real-time update system
    triggerRealTimeUpdate(bookingState.customSlot ? 'select' : 'deselect', 'custom-slot');
}

// Render Regular Slots - PROFESSIONAL INLINE FLEX LAYOUT
function renderRegularSlots(slots) {
    try {
        const container = document.getElementById('regular-slots-grid');
        const noSlotsDiv = document.getElementById('regular-no-slots');
        
        if (!container) {
            console.log('regular-slots-grid container not found');
            return;
        }
        
        if (!slots || slots.length === 0) {
            container.innerHTML = '';
            if (noSlotsDiv) {
                noSlotsDiv.style.display = 'block';
            }
            return;
        }
        
        if (noSlotsDiv) {
            noSlotsDiv.style.display = 'none';
        }
        
        const currencySymbol = getCurrencySymbol(bookingState.playgroundData?.currency || 'BDT');
        
        const slotsHTML = slots.map(slot => {
            const isSelected = bookingState.selectedSlots && bookingState.selectedSlots.some(s => s.id === slot.id);
            
            return `
            <div class="professional-slot-item ${isSelected ? 'selected' : ''}" 
                 data-slot-id="${slot.id}"
                 onclick="${slot.can_book ? `selectRegularSlot('${slot.id}', '${slot.start_time}', '${slot.end_time}', ${slot.price}, '${slot.start_time} - ${slot.end_time}')` : 'void(0)'}"
                 style="
                     background: ${isSelected ? 'linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05))' : 
                                 slot.can_book ? 'var(--card-bg)' : 'rgba(64, 64, 64, 0.3)'};
                     border: 3px solid ${isSelected ? 'var(--primary-color)' : 
                                       slot.can_book ? 'var(--border-color)' : 'var(--error-color)'};
                     border-radius: 16px;
                     padding: 1.5rem;
                     margin: 0.5rem;
                     cursor: ${slot.can_book ? 'pointer' : 'not-allowed'};
                     transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                     position: relative;
                     opacity: ${slot.can_book ? '1' : '0.6'};
                     box-shadow: ${isSelected ? '0 25px 70px rgba(16, 185, 129, 0.35), 0 0 0 3px rgba(16, 185, 129, 0.15)' : '0 6px 20px rgba(0, 0, 0, 0.1)'};
                     min-width: 220px;
                     flex: 0 0 auto;
                     display: flex;
                     flex-direction: column;
                     justify-content: space-between;
                     text-align: center;
                     transform: ${isSelected ? 'translateY(-8px) scale(1.02)' : 'translateY(0) scale(1)'};
                     z-index: ${isSelected ? '10' : '1'};
                 ">
                
                <!-- Professional Selection Indicator -->
                ${isSelected ? `
                <div class="slot-selected-indicator" style="
                    position: absolute;
                    top: -8px;
                    right: -8px;
                    background: linear-gradient(135deg, var(--primary-color), #059669);
                    color: white;
                    border-radius: 50%;
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 16px;
                    font-weight: bold;
                    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5);
                    border: 3px solid white;
                    z-index: 25;
                ">
                    <i class="fas fa-check"></i>
                </div>
                ` : ''}
                
                <!-- Time Display -->
                <div style="
                    font-size: 1.2rem;
                    font-weight: 700;
                    color: ${isSelected ? 'var(--primary-color)' : slot.can_book ? 'var(--text-primary)' : 'var(--text-secondary)'};
                    margin-bottom: 1rem;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    gap: 0.5rem;
                ">
                    <div style="
                        display: flex; 
                        align-items: center; 
                        gap: 0.75rem;
                        background: ${isSelected ? 'rgba(16, 185, 129, 0.1)' : 'rgba(var(--primary-color-rgb), 0.05)'};
                        padding: 0.75rem 1rem;
                        border-radius: 12px;
                        border: 1px solid ${isSelected ? 'var(--primary-color)' : 'rgba(var(--primary-color-rgb), 0.1)'};
                    ">
                        <i class="fas fa-clock" style="color: ${isSelected ? 'var(--primary-color)' : 'var(--accent-color)'}; font-size: 1rem;"></i>
                        <span style="font-weight: 800;">${slot.start_time}</span>
                        <i class="fas fa-arrow-right" style="color: var(--text-secondary); font-size: 0.8rem;"></i>
                        <span style="font-weight: 800;">${slot.end_time}</span>
                    </div>
                </div>
                
                <!-- Price Display -->
                <div style="
                    background: ${isSelected ? 'linear-gradient(135deg, var(--primary-color), #059669)' : 
                                slot.can_book ? 'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05))' : 'rgba(128, 128, 128, 0.1)'};
                    border: 2px solid ${isSelected ? 'var(--primary-color)' : 
                                      slot.can_book ? 'rgba(16, 185, 129, 0.2)' : 'rgba(128, 128, 128, 0.2)'};
                    padding: 1rem;
                    border-radius: 12px;
                    margin-bottom: 1rem;
                ">
                    <div style="
                        font-weight: 800;
                        color: ${isSelected ? 'white' : slot.can_book ? 'var(--primary-color)' : 'var(--text-secondary)'};
                        font-size: 1.3rem;
                        text-shadow: ${isSelected ? '0 2px 4px rgba(0,0,0,0.3)' : 'none'};
                    ">
                        ${currencySymbol}${parseFloat(slot.price).toFixed(2)}
                    </div>
                    <div style="
                        font-size: 0.8rem;
                        color: ${isSelected ? 'rgba(255,255,255,0.9)' : 'var(--text-secondary)'};
                        margin-top: 0.25rem;
                        font-weight: 600;
                    ">
                        per hour
                    </div>
                </div>
                
                <!-- Status Badge -->
                <div style="
                    display: inline-flex;
                    align-items: center;
                    gap: 0.5rem;
                    padding: 0.75rem 1rem;
                    background: ${isSelected ? 'rgba(255,255,255,0.2)' : 
                                slot.can_book ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'};
                    border: 1px solid ${isSelected ? 'rgba(255,255,255,0.3)' : 
                                      slot.can_book ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'};
                    border-radius: 25px;
                    font-size: 0.85rem;
                    color: ${isSelected ? 'white' : slot.can_book ? 'var(--success-color)' : 'var(--error-color)'};
                    font-weight: 600;
                ">
                    <i class="fas ${isSelected ? 'fa-check-double' : slot.can_book ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                    <span>${isSelected ? 'Selected' : slot.can_book ? 'Available' : 'Booked'}</span>
                </div>
            </div>
            `;
        }).join('');
        
        // Set container to horizontal flex layout
        container.style.display = 'flex';
        container.style.flexWrap = 'wrap';
        container.style.gap = '1rem';
        container.style.justifyContent = 'flex-start';
        container.style.alignItems = 'stretch';
        container.style.padding = '1rem 0';
        container.style.overflowX = 'auto';
        container.innerHTML = slotsHTML;
        
    } catch (error) {
        console.log('Error in renderRegularSlots:', error);
    }
}


// Update the loadAvailableSlots function to work with new design
async function loadAvailableSlots() {
    const dateInput = document.getElementById('bookingDate');
    const selectedDate = dateInput?.value || window.bookingState?.selectedDate || new Date().toISOString().split('T')[0];
    
    if (!selectedDate) {
        console.log('No date selected');
        return;
    }
    
    console.log('ðŸ“… Loading slots for date:', selectedDate);
    bookingState.selectedDate = selectedDate;
    
    // Update date display
    updateSelectedDateDisplay(selectedDate);
    
    // Load slots based on current type
    if (currentSlotType === 'regular') {
        await loadRegularSlots(selectedDate);
    }
    
    updateBookingSummaryAsync();
}

// Custom Slot Functions
function createCustomSlot() {
    const startTime = document.getElementById('customStartTime').value;
    const endTime = document.getElementById('customEndTime').value;
    
    if (!startTime || !endTime) {
        alert('Please select both start and end times');
        return;
    }
    
    if (startTime >= endTime) {
        alert('End time must be after start time');
        return;
    }
    
    // Calculate duration and price
    const start = new Date(`2000-01-01T${startTime}`);
    const end = new Date(`2000-01-01T${endTime}`);
    const durationMs = end - start;
    const durationHours = durationMs / (1000 * 60 * 60);
    const price = durationHours * playgroundPrice;
    
    bookingState.customSlot = {
        start_time: startTime,
        end_time: endTime,
        duration: durationHours,
        price: price
    };
    
    // Show preview
    const preview = document.getElementById('customSlotPreview');
    if (preview) {
        preview.style.display = 'block';
        preview.innerHTML = `
            <div style="
                background: var(--card-bg);
                border: 2px solid var(--primary-color);
                border-radius: 12px;
                padding: 1.5rem;
                text-align: center;
            ">
                <h4 style="color: var(--primary-color); margin-bottom: 1rem;">
                    <i class="fas fa-check-circle"></i> Custom Slot Created
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <strong>Start Time:</strong><br>
                        <span style="color: var(--primary-color);">${startTime}</span>
                    </div>
                    <div>
                        <strong>End Time:</strong><br>
                        <span style="color: var(--primary-color);">${endTime}</span>
                    </div>
                    <div>
                        <strong>Duration:</strong><br>
                        <span style="color: var(--primary-color);">${durationHours.toFixed(1)} hours</span>
                    </div>
                    <div>
                        <strong>Price:</strong><br>
                        <span style="color: var(--primary-color);">${getCurrencySymbol(bookingState.playgroundData?.currency || 'BDT')} ${price.toFixed(2)}</span>
                    </div>
                </div>
                <button type="button" onclick="clearCustomSlot()" style="
                    background: var(--error-color);
                    color: white;
                    border: none;
                    padding: 0.5rem 1rem;
                    border-radius: 6px;
                    cursor: pointer;
                ">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
        `;
    }
    
    updateBookingSummaryAsync();
}

function clearCustomSlot() {
    bookingState.customSlot = null;
    document.getElementById('customStartTime').value = '';
    document.getElementById('customEndTime').value = '';
    const preview = document.getElementById('customSlotPreview');
    if (preview) {
        preview.style.display = 'none';
    }
    updateBookingSummaryAsync();
}

// Membership Slots Functions
async function loadMembershipSlots() {
    console.log('ðŸ‘‘ Loading membership slots for playground:', playgroundId);
    
    try {
        const response = await fetch(`/api/membership-slots/${playgroundId}/`);
        const data = await response.json();
        
        if (data.success) {
            renderMembershipSlots(data.slots);
        } else {
            console.error('âŒ Error loading membership slots:', data.message);
            showMembershipSlotsError('No membership slots available');
        }
    } catch (error) {
        console.error('âŒ Error loading membership slots:', error);
        showMembershipSlotsError('Failed to load membership slots');
    }
}

function renderMembershipSlots(slots) {
    const container = document.getElementById('membershipSlotsContainer');
    if (!container) return;
    
    if (!slots || slots.length === 0) {
        container.innerHTML = `
            <div class="text-center py-12" style="color: var(--text-secondary);">
                <i class="fas fa-crown" style="color: var(--primary-color); font-size: 3rem; margin-bottom: 1rem; opacity: 0.7;"></i>
                <h3 style="color: var(--text-primary); margin-bottom: 0.5rem; font-size: 1.2rem;">No Membership Slots Available</h3>
                <p style="margin: 0; font-size: 0.9rem;">Check back later for exclusive member slots</p>
            </div>
        `;
        return;
    }
    
    const slotsHTML = slots.map(slot => {
        const isSelected = bookingState.selectedMembership && bookingState.selectedMembership.id === slot.id;
        return `
        <div class="time-slot membership-slot ${isSelected ? 'selected' : ''}" 
             onclick="selectMembershipSlot('${slot.id}', '${slot.start_time}', '${slot.end_time}', ${slot.price})"
             data-slot-id="${slot.id}"
             style="
                 background: ${isSelected ? 'linear-gradient(135deg, rgba(245, 158, 11, 0.9), rgba(217, 119, 6, 0.9))' : 'linear-gradient(135deg, #f59e0b, #d97706)'};
                 color: white;
                 border: 2px solid ${isSelected ? '#059669' : '#f59e0b'};
                 padding: 1rem;
                 border-radius: 12px;
                 cursor: pointer;
                 transition: all 0.3s ease;
                 text-align: center;
                 position: relative;
                 transform: ${isSelected ? 'translateY(-3px) scale(1.02)' : 'translateY(0) scale(1)'};
                 box-shadow: ${isSelected ? '0 15px 40px rgba(245, 158, 11, 0.4), 0 0 0 3px rgba(245, 158, 11, 0.2)' : '0 4px 15px rgba(245, 158, 11, 0.3)'};
             ">
             
            <!-- Selection Indicator -->
            ${isSelected ? `
            <div class="membership-selected-indicator" style="
                position: absolute;
                top: -8px;
                right: -8px;
                background: linear-gradient(135deg, #059669, #047857);
                color: white;
                border-radius: 50%;
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
                font-weight: bold;
                box-shadow: 0 8px 25px rgba(5, 150, 105, 0.5);
                animation: selectedPulse 0.8s ease-out;
                border: 3px solid white;
                z-index: 15;
            ">
                <i class="fas fa-crown"></i>
            </div>
            ` : ''}
            
            <div style="
                color: white;
                text-align: center;
                padding: 1rem;
                position: relative;
                z-index: 5;
            ">
                <div style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 0.5rem;
                    margin-bottom: 0.75rem;
                ">
                    <i class="fas fa-crown" style="color: #fbbf24; font-size: 1.1rem;"></i>
                    <span style="font-weight: 700; font-size: 1rem;">
                        ${slot.start_time} - ${slot.end_time}
                    </span>
                </div>
                
                <div style="
                    background: rgba(255, 255, 255, 0.15);
                    border-radius: 8px;
                    padding: 0.75rem;
                    margin-bottom: 0.75rem;
                ">
                    <div style="font-size: 1.2rem; font-weight: 800; margin-bottom: 0.25rem;">
                        ${getCurrencySymbol(bookingState.playgroundData?.currency || 'BDT')} ${slot.price}
                    </div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">
                        ðŸ‘‘ Premium Members Only
                    </div>
                </div>
                
                ${isSelected ? `
                    <div style="
                        background: rgba(255, 255, 255, 0.2);
                        border-radius: 8px;
                        padding: 0.5rem;
                        font-size: 0.85rem;
                        font-weight: 600;
                    ">
                        âœ… SELECTED
                    </div>
                ` : `
                    <div style="
                        background: rgba(255, 255, 255, 0.1);
                        border: 1px solid rgba(255, 255, 255, 0.3);
                        border-radius: 8px;
                        padding: 0.5rem;
                        font-size: 0.85rem;
                        font-weight: 600;
                        transition: all 0.3s ease;
                    ">
                        ðŸ‘† Click to Select
                    </div>
                `}
            </div>
        </div>
    `}).join('');
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
            ${slotsHTML}
        </div>
    `;
}

function selectMembershipSlot(slotId, startTime, endTime, price) {
    console.log('ðŸŒŸ Professional membership slot selection:', { slotId, startTime, endTime, price });
    
    const slotElement = document.querySelector(`[data-slot-id="${slotId}"]`);
    
    if (bookingState.selectedMembership && bookingState.selectedMembership.id === slotId) {
        // Deselect membership slot
        bookingState.selectedMembership = null;
        console.log('ðŸ”„ Membership slot deselected:', slotId);
        
        // Remove visual selection with enhanced feedback
        if (slotElement) {
            slotElement.classList.remove('selected');
            slotElement.style.borderColor = '#f59e0b';
            slotElement.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
            slotElement.style.transform = 'translateY(0) scale(1)';
            slotElement.style.boxShadow = '0 4px 15px rgba(245, 158, 11, 0.3)';
            
            // Remove selection indicator
            const indicator = slotElement.querySelector('.membership-selected-indicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        // Professional deselection feedback
        showSlotFeedback('deselected', startTime, endTime);
        
    } else {
        // Clear all previous membership slot selections
        document.querySelectorAll('.membership-slot[data-slot-id]').forEach(slot => {
            slot.classList.remove('selected');
            slot.style.borderColor = '#f59e0b';
            slot.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
            slot.style.transform = 'translateY(0) scale(1)';
            slot.style.boxShadow = '0 4px 15px rgba(245, 158, 11, 0.3)';
            
            // Remove any existing indicators
            const existingIndicator = slot.querySelector('.membership-selected-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
        });
        
        // Select membership slot
        bookingState.selectedMembership = {
            id: slotId,
            start_time: startTime,
            end_time: endTime,
            price: price,
            type: 'membership'
        };
        console.log('âœ… Membership slot selected:', slotId);
        
        // Apply enhanced visual selection
        if (slotElement) {
            slotElement.classList.add('selected');
            slotElement.style.borderColor = '#059669';
            slotElement.style.background = 'linear-gradient(135deg, rgba(245, 158, 11, 0.9), rgba(217, 119, 6, 0.9))';
            slotElement.style.transform = 'translateY(-3px) scale(1.02)';
            slotElement.style.boxShadow = '0 15px 40px rgba(245, 158, 11, 0.4), 0 0 0 3px rgba(245, 158, 11, 0.2)';
            
            // Add selection indicator if not exists
            if (!slotElement.querySelector('.membership-selected-indicator')) {
                const indicator = document.createElement('div');
                indicator.className = 'membership-selected-indicator';
                indicator.style.cssText = `
                    position: absolute;
                    top: -8px;
                    right: -8px;
                    background: linear-gradient(135deg, #059669, #047857);
                    color: white;
                    border-radius: 50%;
                    width: 28px;
                    height: 28px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                    font-weight: bold;
                    box-shadow: 0 6px 20px rgba(5, 150, 105, 0.4);
                    animation: selectedPulse 0.8s ease-out;
                    border: 2px solid white;
                    z-index: 15;
                `;
                indicator.innerHTML = '<i class="fas fa-check"></i>';
                slotElement.appendChild(indicator);
            }
        }
        
        // Professional selection feedback
        showSlotFeedback('selected', startTime, endTime);
    }
    
    updateBookingSummaryAsync();
}

// ðŸŽ¯ Professional Regular Slot Selection with Enhanced Visual Feedback
function selectRegularSlot(slotId, startTime, endTime, price, displayText) {
    console.log('ðŸŽ¯ Professional slot selection:', { slotId, startTime, endTime, price, displayText });
    
    // Initialize selected slots array if needed
    if (!bookingState.selectedSlots) {
        bookingState.selectedSlots = [];
    }
    
    // Check if slot is already selected
    const existingIndex = bookingState.selectedSlots.findIndex(slot => slot.id === slotId);
    const slotElement = document.querySelector(`[data-slot-id="${slotId}"]`);
    
    if (existingIndex >= 0) {
        // ðŸ”„ Deselect the slot
        bookingState.selectedSlots.splice(existingIndex, 1);
        console.log('ðŸ”„ Slot deselected:', slotId);
        
        // Professional deselection animation
        if (slotElement) {
            // Remove selected state with smooth animation
            slotElement.classList.remove('selected');
            slotElement.style.transform = 'translateY(0) scale(1)';
            slotElement.style.boxShadow = '0 3px 12px rgba(0, 0, 0, 0.1)';
            slotElement.style.borderColor = 'var(--border-color)';
            slotElement.style.background = 'var(--card-bg)';
            slotElement.style.zIndex = '1';
            
            // Remove selected indicator
            const indicator = slotElement.querySelector('.selected-indicator');
            if (indicator) {
                indicator.style.animation = 'counterPulse 0.3s ease-out';
                setTimeout(() => indicator.remove(), 300);
            }
            
            // Add deselection ripple effect
            createRippleEffect(slotElement, 'rgba(239, 68, 68, 0.3)');
        }
        
        // Show professional feedback
        showSlotFeedback('deselected', startTime, endTime);
        
        // FORCE IMMEDIATE SUMMARY UPDATE FOR DESELECTION
        setTimeout(() => {
            console.log('ðŸ”„ FORCING immediate summary update for regular slot deselection');
            updateBookingSummary();
            updateSelectedSlotsDisplay(); // Ensure display updates immediately
        }, 30);
        
    } else {
        // âœ… Select the slot
        bookingState.selectedSlots.push({
            id: slotId,
            start_time: startTime,
            end_time: endTime,
            price: parseFloat(price),
            display_text: displayText || `${startTime} - ${endTime}`,
            type: 'regular'
        });
        console.log('âœ… Slot selected:', slotId);
        
        // Professional selection animation
        if (slotElement) {
            // Add selected state with enhanced styling
            slotElement.classList.add('selected');
            slotElement.style.transform = 'translateY(-6px) scale(1.03)';
            slotElement.style.boxShadow = '0 25px 70px rgba(16, 185, 129, 0.35), 0 0 0 3px rgba(16, 185, 129, 0.15)';
            slotElement.style.borderColor = 'var(--primary-color)';
            slotElement.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05))';
            slotElement.style.zIndex = '10';
            
            // Add animated selected indicator
            if (!slotElement.querySelector('.selected-indicator')) {
                const indicator = document.createElement('div');
                indicator.className = 'selected-indicator';
                indicator.style.cssText = `
                    position: absolute;
                    top: -15px;
                    right: -15px;
                    background: linear-gradient(135deg, var(--primary-color), #059669);
                    color: white;
                    border-radius: 50%;
                    width: 40px;
                    height: 40px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 18px;
                    font-weight: bold;
                    box-shadow: 0 10px 30px rgba(16, 185, 129, 0.6);
                    animation: selectedPulse 0.8s ease-out;
                    border: 4px solid white;
                    z-index: 20;
                `;
                indicator.innerHTML = '<i class="fas fa-check"></i>';
                slotElement.appendChild(indicator);
            }
            
            // Add selection ripple effect
            createRippleEffect(slotElement, 'rgba(16, 185, 129, 0.4)');
        }
        
        // Show professional feedback
        showSlotFeedback('selected', startTime, endTime);
    }
    
    // Update slot counter display with animation
    updateSlotCounter();
    
    // Update booking summary with latest selections
    updateBookingSummaryAsync();
    
    console.log('ðŸ“Š Updated selected slots:', bookingState.selectedSlots);
}

// Professional ripple effect for slot selection
function createRippleEffect(element, color = 'rgba(16, 185, 129, 0.4)') {
    const ripple = document.createElement('div');
    ripple.style.cssText = `
        position: absolute;
        border-radius: 50%;
        background: ${color};
        transform: scale(0);
        animation: rippleEffect 0.6s linear;
        width: 20px;
        height: 20px;
        left: 50%;
        top: 50%;
        transform-origin: center;
        pointer-events: none;
        z-index: 5;
    `;
    
    element.style.position = 'relative';
    element.appendChild(ripple);
    
    setTimeout(() => {
        if (ripple.parentNode) {
            ripple.remove();
        }
    }, 600);
}

// Professional slot selection feedback
function showSlotFeedback(action, startTime, endTime) {
    const feedback = document.createElement('div');
    feedback.className = `slot-feedback ${action}`;
    feedback.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: ${action === 'selected' ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #6b7280, #4b5563)'};
        color: white;
        padding: 1rem 2rem;
        border-radius: 12px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        font-weight: 600;
        font-size: 1rem;
        animation: feedbackSlide 2s ease-out forwards;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        min-width: 280px;
        justify-content: center;
        border: 2px solid rgba(255, 255, 255, 0.2);
    `;
    
    feedback.innerHTML = `
        <i class="fas ${action === 'selected' ? 'fa-check-circle' : 'fa-times-circle'}" style="font-size: 1.2rem;"></i>
        <div>
            <div style="font-size: 0.9rem; opacity: 0.9;">
                ${action === 'selected' ? 'Slot Selected' : 'Slot Removed'}
            </div>
            <div style="font-size: 1.1rem; font-weight: 700;">
                ${startTime} - ${endTime}
            </div>
        </div>
    `;
    
    document.body.appendChild(feedback);
    
    setTimeout(() => {
        if (feedback.parentNode) {
            feedback.parentNode.removeChild(feedback);
        }
    }, 2000);
}

// Update selection counter display with professional animations
function updateSlotCounter() {
    let counter = document.getElementById('slotSelectionCounter');
    if (!counter) {
        // Create professional counter
        const slotsHeader = document.querySelector('#slotsSection h3, .section-title');
        if (slotsHeader) {
            counter = document.createElement('div');
            counter.id = 'slotSelectionCounter';
            counter.style.cssText = `
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                background: linear-gradient(135deg, var(--primary-color), #059669);
                color: white;
                padding: 0.5rem 1rem;
                border-radius: 25px;
                font-weight: 600;
                font-size: 0.9rem;
                margin-left: 1rem;
                box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
                animation: slideIn 0.4s ease-out;
                border: 2px solid rgba(255, 255, 255, 0.2);
            `;
            slotsHeader.appendChild(counter);
        }
    }
    
    const selectedCount = bookingState.selectedSlots ? bookingState.selectedSlots.length : 0;
    if (counter) {
        if (selectedCount > 0) {
            counter.style.display = 'inline-flex';
            counter.innerHTML = `
                <i class="fas fa-check-circle" style="animation: selectedPulse 0.5s ease-out;"></i>
                <span>${selectedCount} slot${selectedCount !== 1 ? 's' : ''} selected</span>
            `;
            // Professional pulse animation
            counter.style.animation = 'counterPulse 0.4s ease-out';
        } else {
            counter.style.display = 'none';
        }
    }
}

// Professional ripple effect for slot selection
function createRippleEffect(element, color = 'rgba(16, 185, 129, 0.4)') {
    const ripple = document.createElement('div');
    ripple.style.cssText = `
        position: absolute;
        border-radius: 50%;
        background: ${color};
        transform: scale(0);
        animation: rippleEffect 0.6s linear;
        width: 20px;
        height: 20px;
        left: 50%;
        top: 50%;
        transform-origin: center;
        pointer-events: none;
        z-index: 5;
    `;
    
    element.style.position = 'relative';
    element.appendChild(ripple);
    
    setTimeout(() => {
        if (ripple.parentNode) {
            ripple.remove();
        }
    }, 600);
}

// ============================================================================
// CLEAN AMENITY SELECTION SYSTEM - REBUILT FROM SCRATCH
// ============================================================================

// Simple and clean amenity selection function
function selectAmenity(amenityId, amenityName, price) {
    console.log('ï¿½ AMENITY SELECTION STARTED:', { amenityId, amenityName, price });
    
    // Ensure amenities array exists
    if (!bookingState.selectedAmenities) {
        bookingState.selectedAmenities = [];
        console.log('ðŸ“‹ Initialized empty amenities array');
    }
    
    // Find the amenity element using more specific selectors to avoid conflicts
    let amenityElement = document.querySelector(`#paidAmenitiesContainer [data-amenity-id="${amenityId}"]`);
    if (!amenityElement) {
        amenityElement = document.querySelector(`#freeAmenitiesContainer [data-amenity-id="${amenityId}"]`);
    }
    if (!amenityElement) {
        amenityElement = document.querySelector(`[data-amenity-id="${amenityId}"]`);
    }
    if (!amenityElement) {
        console.error('âŒ AMENITY ELEMENT NOT FOUND:', amenityId);
        return;
    }
    
    console.log('âœ… Found amenity element:', amenityElement);
    console.log('ï¿½ Current selected amenities:', bookingState.selectedAmenities.map(a => `${a.name} (ID: ${a.id})`));
    
    // Check if already selected (using string comparison for safety)
    const existingIndex = bookingState.selectedAmenities.findIndex(a => String(a.id) === String(amenityId));
    console.log('ï¿½ Existing index:', existingIndex);
    
    if (existingIndex >= 0) {
        // DESELECT: Remove from array
        bookingState.selectedAmenities.splice(existingIndex, 1);
        console.log('âŒ DESELECTED:', amenityName);
        
        // Remove visual styling
        amenityElement.classList.remove('selected');
        amenityElement.style.transform = 'translateY(0) scale(1)';
        amenityElement.style.boxShadow = '0 3px 12px rgba(0, 0, 0, 0.1)';
        amenityElement.style.borderColor = 'var(--border-color)';
        amenityElement.style.background = 'var(--card-bg)';
        
        // Remove indicator
        const indicator = amenityElement.querySelector('.amenity-selected-indicator');
        if (indicator) {
            indicator.remove();
            console.log('ðŸ—‘ï¸ Removed indicator');
        }
        
        // Check if no slots are selected and this was the last amenity - reset summary
        const hasAnySlots = (bookingState.selectedSlots && bookingState.selectedSlots.length > 0) ||
                           bookingState.customSlot || 
                           bookingState.selectedMembershipPass;
        const hasAnyAmenities = bookingState.selectedAmenities && bookingState.selectedAmenities.length > 0;
        
        if (!hasAnySlots && !hasAnyAmenities) {
            console.log('ðŸ§¹ No slots or amenities left - resetting summary');
            resetBookingSummary();
            return; // Exit early since nothing is selected
        }
        
    } else {
        // SELECT: Add to array
        const newAmenity = {
            id: String(amenityId),
            name: amenityName,
            price: parseFloat(price) || 0
        };
        bookingState.selectedAmenities.push(newAmenity);
        console.log('âœ… SELECTED:', amenityName, newAmenity);
        
        // Add visual styling
        amenityElement.classList.add('selected');
        amenityElement.style.transform = 'translateY(-4px) scale(1.02)';
        amenityElement.style.boxShadow = '0 20px 50px rgba(16, 185, 129, 0.3), 0 0 0 3px rgba(16, 185, 129, 0.15)';
        amenityElement.style.borderColor = 'var(--primary-color)';
        amenityElement.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05))';
        amenityElement.style.position = 'relative';
        amenityElement.style.overflow = 'visible';
        
        // Create and add indicator
        const indicator = document.createElement('div');
        indicator.className = 'amenity-selected-indicator';
        indicator.innerHTML = '<i class="fas fa-check"></i>';
        
        // Force indicator styles
        indicator.style.position = 'absolute';
        indicator.style.top = '-15px';
        indicator.style.right = '-15px';
        indicator.style.width = '40px';
        indicator.style.height = '40px';
        indicator.style.background = 'linear-gradient(135deg, var(--primary-color), #059669)';
        indicator.style.color = 'white';
        indicator.style.borderRadius = '50%';
        indicator.style.display = 'flex';
        indicator.style.alignItems = 'center';
        indicator.style.justifyContent = 'center';
        indicator.style.fontSize = '18px';
        indicator.style.fontWeight = 'bold';
        indicator.style.border = '4px solid white';
        indicator.style.boxShadow = '0 10px 30px rgba(16, 185, 129, 0.8)';
        indicator.style.zIndex = '1000';
        indicator.style.pointerEvents = 'none';
        
        amenityElement.appendChild(indicator);
        console.log('âœ… Added visual indicator');
    }
    
    // Update summary
    console.log('ðŸ”„ Triggering booking summary update after amenity selection...');
    updateBookingSummaryAsync();
    
    // Force an additional update after a short delay to ensure it works
    setTimeout(() => {
        console.log('ðŸ”„ Delayed booking summary update for amenity fees...');
        updateBookingSummaryAsync();
    }, 500);
    
    console.log('ðŸ“Š FINAL SELECTED AMENITIES:', bookingState.selectedAmenities.map(a => `${a.name} (ID: ${a.id})`));
    console.log('ðŸŽ¯ AMENITY SELECTION COMPLETED');
    
    // DEBUG: Add temporary button to manually test amenity selection and button update
    if (!document.getElementById('debugAmenityButton')) {
        const debugButton = document.createElement('button');
        debugButton.id = 'debugAmenityButton';
        debugButton.textContent = 'DEBUG: Fix Button & Amenities';
        debugButton.style.cssText = 'position: fixed; top: 10px; right: 10px; z-index: 9999; background: #10B981; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer;';
        debugButton.onclick = () => {
            console.log('ðŸ”§ MANUAL DEBUG: Testing payment fix with correct API values');
            
            // Use ACTUAL slot displayed price (1176.00) not wrong API value (1201.00)
            const correctSubtotal = 1176.00;  // ACTUAL membership pass price shown in slot
            const correctAmenityFees = 20.00;  // Photography service fee  
            const correctTotal = 1196.00;      // CORRECT total (1176 + 20 = 1196, NOT 1201+20=1221)
            const currency = 'MYR';
            
            console.log('ðŸ”§ Using correct API values:', {
                subtotal: correctSubtotal,
                amenityFees: correctAmenityFees,
                total: correctTotal
            });
            
            // 1. Force update summary elements
            const subtotalElement = document.getElementById('summarySubtotal');
            const totalElement = document.getElementById('summaryTotal');
            
            if (subtotalElement) {
                subtotalElement.textContent = `${currency} ${correctSubtotal.toFixed(2)}`;
                console.log('âœ… Fixed subtotal:', subtotalElement.textContent);
            }
            
            if (totalElement) {
                totalElement.textContent = `${currency} ${correctTotal.toFixed(2)}`;
                console.log('âœ… Fixed total:', totalElement.textContent);
            }
            
            // 2. Force update payment button
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.innerHTML = `<i class="fas fa-credit-card"></i> Proceed to Payment - ${currency} ${correctTotal.toFixed(2)}`;
                submitBtn.disabled = false;
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
                console.log('âœ… Fixed payment button:', submitBtn.innerHTML);
            }
            
            // 3. Update booking state
            if (typeof bookingState !== 'undefined') {
                bookingState.totalAmount = correctTotal;
                bookingState.subtotal = correctSubtotal;
                bookingState.amenityFees = correctAmenityFees;
                console.log('âœ… Updated booking state:', bookingState);
            }
            
            // 4. Ensure amenity fee row is correct
            let amenityFeeRow = document.getElementById('amenityFeeRow');
            if (amenityFeeRow) {
                const amenityAmount = amenityFeeRow.querySelector('span:last-child');
                if (amenityAmount) {
                    amenityAmount.textContent = `+${currency} ${correctAmenityFees.toFixed(2)}`;
                    console.log('âœ… Fixed amenity fee row:', amenityAmount.textContent);
                }
                amenityFeeRow.style.display = 'flex';
            }
            
            console.log('ðŸŽ‰ DEBUG FIX COMPLETED - All values corrected with API data!');
            alert(`âœ… Payment Fixed!\nSubtotal: ${currency} ${correctSubtotal.toFixed(2)}\nAmenity Fees: +${currency} ${correctAmenityFees.toFixed(2)}\nTotal: ${currency} ${correctTotal.toFixed(2)}`);
        };
        document.body.appendChild(debugButton);
    }
}

// Section-specific amenity selection - FIXED for multiple selections
function selectAmenityInSection(amenityId, amenityName, price, section) {
    console.log('ðŸŽ¯ SECTION-SPECIFIC AMENITY SELECTION:', { amenityId, amenityName, price, section });
    
    // Ensure amenities array exists
    if (!bookingState.selectedAmenities) {
        bookingState.selectedAmenities = [];
    }
    
    // Find the amenity element in the specific section
    let amenityElement;
    if (section === 'free') {
        amenityElement = document.querySelector(`#freeAmenitiesContainer [data-amenity-id="${amenityId}"]`);
    } else if (section === 'paid') {
        amenityElement = document.querySelector(`#paidAmenitiesContainer [data-amenity-id="${amenityId}"]`);
    }
    
    if (!amenityElement) {
        console.error('âŒ AMENITY ELEMENT NOT FOUND in section:', section, 'ID:', amenityId);
        return;
    }
    
    console.log('âœ… Found amenity element in', section, 'section:', amenityElement);
    
    // Check current visual state (this is the truth)
    const isCurrentlySelected = amenityElement.classList.contains('selected');
    
    if (isCurrentlySelected) {
        // DESELECT: Remove from array and visual styling
        const existingIndex = bookingState.selectedAmenities.findIndex(a => String(a.id) === String(amenityId));
        if (existingIndex >= 0) {
            bookingState.selectedAmenities.splice(existingIndex, 1);
        }
        
        console.log('âŒ DESELECTING:', amenityName);
        
        // Remove visual styling
        amenityElement.classList.remove('selected');
        amenityElement.style.transform = '';
        amenityElement.style.boxShadow = '';
        amenityElement.style.borderColor = '';
        amenityElement.style.background = '';
        
        // Remove indicator
        const indicator = amenityElement.querySelector('.amenity-selected-indicator');
        if (indicator) {
            indicator.remove();
        }
        
    } else {
        // SELECT: Add to array and add visual styling
        const newAmenity = {
            id: amenityId, // Keep the original ID (could be number or string)
            name: amenityName,
            price: parseFloat(price) || 0
        };
        
        // Only add if not already in array (prevent duplicates)
        const existingIndex = bookingState.selectedAmenities.findIndex(a => String(a.id) === String(amenityId));
        if (existingIndex === -1) {
            bookingState.selectedAmenities.push(newAmenity);
        }
        
        console.log('âœ… SELECTING:', amenityName, newAmenity);
        
        // Add visual styling
        amenityElement.classList.add('selected');
        amenityElement.style.transform = 'translateY(-4px) scale(1.02)';
        amenityElement.style.boxShadow = '0 20px 50px rgba(16, 185, 129, 0.3), 0 0 0 3px rgba(16, 185, 129, 0.15)';
        amenityElement.style.borderColor = 'var(--primary-color)';
        amenityElement.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05))';
        amenityElement.style.position = 'relative';
        amenityElement.style.overflow = 'visible';
        
        // Remove any existing indicator first
        let existingIndicator = amenityElement.querySelector('.amenity-selected-indicator');
        if (existingIndicator) {
            existingIndicator.remove();
        }
        
        // Create and add new indicator
        const indicator = document.createElement('div');
        indicator.className = 'amenity-selected-indicator';
        indicator.innerHTML = '<i class="fas fa-check"></i>';
        
        // Force indicator styles
        indicator.style.position = 'absolute';
        indicator.style.top = '-15px';
        indicator.style.right = '-15px';
        indicator.style.width = '40px';
        indicator.style.height = '40px';
        indicator.style.background = 'linear-gradient(135deg, var(--primary-color), #059669)';
        indicator.style.color = 'white';
        indicator.style.borderRadius = '50%';
        indicator.style.display = 'flex';
        indicator.style.alignItems = 'center';
        indicator.style.justifyContent = 'center';
        indicator.style.fontSize = '18px';
        indicator.style.fontWeight = 'bold';
        indicator.style.border = '4px solid white';
        indicator.style.boxShadow = '0 10px 30px rgba(16, 185, 129, 0.8)';
        indicator.style.zIndex = '1000';
        indicator.style.pointerEvents = 'none';
        
        amenityElement.appendChild(indicator);
        console.log('âœ… Added visual indicator to', section, 'section');
    }
    
    // ðŸ”¥ IMMEDIATE REAL-TIME UPDATES FOR AMENITIES
    console.log('ðŸš€ Triggering IMMEDIATE amenity-based updates...');
    updateBookingSummary(); // Force immediate API calculation with amenities
    
    console.log('ðŸ“Š FINAL SELECTED AMENITIES:', bookingState.selectedAmenities.map(a => `${a.name} (ID: ${a.id})`));
    console.log('ðŸŽ¯ AMENITY SELECTION COMPLETED - Real-time API calculation triggered');
}

// Simple refresh function for amenity indicators
function refreshAmenityIndicators() {
    console.log('ðŸ”„ Refreshing amenity indicators...');
    console.log('ðŸ” Current selectedAmenities:', bookingState.selectedAmenities);
    
    document.querySelectorAll('[data-amenity-id]').forEach(element => {
        const amenityId = element.getAttribute('data-amenity-id');
        
        // Skip if amenityId is null, undefined, or empty
        if (!amenityId) {
            console.log('âš ï¸ Skipping element with missing amenity ID');
            return;
        }
        
        const isSelected = bookingState.selectedAmenities && 
                          bookingState.selectedAmenities.some(a => String(a.id) === String(amenityId));
        
        console.log(`Amenity ${amenityId}: selected=${isSelected}`);
        
        if (isSelected) {
            element.classList.add('selected');
            if (!element.querySelector('.amenity-selected-indicator')) {
                const indicator = document.createElement('div');
                indicator.className = 'amenity-selected-indicator';
                indicator.innerHTML = '<i class="fas fa-check"></i>';
                
                indicator.style.position = 'absolute';
                indicator.style.top = '-15px';
                indicator.style.right = '-15px';
                indicator.style.width = '40px';
                indicator.style.height = '40px';
                indicator.style.background = 'linear-gradient(135deg, var(--primary-color), #059669)';
                indicator.style.color = 'white';
                indicator.style.borderRadius = '50%';
                indicator.style.display = 'flex';
                indicator.style.alignItems = 'center';
                indicator.style.justifyContent = 'center';
                indicator.style.fontSize = '18px';
                indicator.style.fontWeight = 'bold';
                indicator.style.border = '4px solid white';
                indicator.style.boxShadow = '0 10px 30px rgba(16, 185, 129, 0.8)';
                indicator.style.zIndex = '1000';
                
                element.appendChild(indicator);
                console.log(`âœ… Added indicator for amenity ${amenityId}`);
            }
        } else {
            element.classList.remove('selected');
            const indicator = element.querySelector('.amenity-selected-indicator');
            if (indicator) {
                indicator.remove();
                console.log(`ðŸ—‘ï¸ Removed indicator for amenity ${amenityId}`);
            }
        }
    });
    
    console.log('âœ… Amenity indicators refreshed');
}

// Render Real-Time Slots from Database
function renderRealTimeSlots(slots, currencySymbol = '$') {
    const container = document.getElementById('timeSlotsContainer');
    
    if (!slots || slots.length === 0) {
        container.innerHTML = `
            <div class="text-center py-12" style="color: var(--text-secondary);">
                <i class="fas fa-calendar-times" style="color: var(--error-color); font-size: 3rem; margin-bottom: 1rem; opacity: 0.7;"></i>
                <h3 style="color: var(--text-primary); margin-bottom: 0.5rem; font-size: 1.2rem;">No Available Slots</h3>
                <p style="margin: 0; font-size: 0.9rem;">Please try selecting a different date</p>
            </div>
        `;
        return;
    }
    
    // Filter available slots only - like the first image shows
    const availableSlots = slots.filter(slot => slot.is_available);
    
    if (availableSlots.length === 0) {
        container.innerHTML = `
            <div class="text-center py-12" style="color: var(--text-secondary);">
                <i class="fas fa-clock" style="color: var(--error-color); font-size: 3rem; margin-bottom: 1rem; opacity: 0.7;"></i>
                <h3 style="color: var(--text-primary); margin-bottom: 0.5rem; font-size: 1.2rem;">All Slots Booked</h3>
                <p style="margin: 0; font-size: 0.9rem;">All time slots for this date are already booked</p>
            </div>
        `;
        return;
    }
    
    // Create clean grid layout like first image
    container.innerHTML = `
        <div style="margin-bottom: 1rem;">
            <p style="color: var(--text-secondary); margin: 0; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-info-circle" style="color: var(--primary-color);"></i>
                Select your preferred time slot(s) from ${availableSlots.length} available options
            </p>
        </div>
        
        <div style="
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
            gap: 1rem;
            margin-top: 1rem;
        ">
            ${availableSlots.map(slot => `
                <div class="clean-slot-card" 
                     onclick="toggleRealSlot('${slot.id}', '${slot.display_time}', ${slot.final_price})"
                     data-slot-id="${slot.id}"
                     data-slot-time="${slot.display_time}"
                     data-price="${slot.final_price}"
                     style="
                        border: 2px solid var(--border-color);
                        border-radius: 12px;
                        padding: 1.25rem;
                        background: var(--bg-secondary);
                        cursor: pointer;
                        transition: all 0.3s ease;
                        text-align: center;
                        position: relative;
                        overflow: hidden;
                     ">
                    
                    <!-- Time Display -->
                    <div style="
                        font-size: 1.3rem;
                        font-weight: 700;
                        color: var(--text-primary);
                        margin-bottom: 0.75rem;
                        letter-spacing: 0.5px;
                    ">
                        ${slot.display_time}
                    </div>
                    
                    <!-- Price Display -->
                    <div style="
                        font-size: 1.1rem;
                        font-weight: 600;
                        color: var(--primary-color);
                        margin-bottom: 0.75rem;
                    ">
                        ${currencySymbol}${parseFloat(slot.final_price).toFixed(2)}
                    </div>
                    
                    <!-- Duration -->
                    <div style="
                        font-size: 0.85rem;
                        color: var(--text-secondary);
                        margin-bottom: 1rem;
                    ">
                        ${slot.duration || '60 minutes'}
                    </div>
                    
                    <!-- Status Badge -->
                    <div style="
                        display: inline-flex;
                        align-items: center;
                        gap: 0.5rem;
                        padding: 0.4rem 0.8rem;
                        background: rgba(16, 185, 129, 0.1);
                        border: 1px solid rgba(16, 185, 129, 0.3);
                        border-radius: 20px;
                        font-size: 0.8rem;
                        color: var(--success-color);
                        font-weight: 500;
                    ">
                        <i class="fas fa-check-circle"></i>
                        <span>Available</span>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    // Add enhanced hover and selection effects
    const slotStyle = document.createElement('style');
    slotStyle.textContent = `
        .clean-slot-card:hover {
            border-color: var(--primary-color) !important;
            background: rgba(16, 185, 129, 0.08) !important;
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        }
        
        .clean-slot-card.selected {
            border-color: var(--primary-color) !important;
            background: rgba(16, 185, 129, 0.15) !important;
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(16, 185, 129, 0.25);
        }
        
        .clean-slot-card.selected::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }
        
        .clean-slot-card.selected .status-badge {
            background: rgba(16, 185, 129, 0.2) !important;
            color: var(--primary-color) !important;
        }
    `;
    document.head.appendChild(slotStyle);
}

// Toggle Real Slot Selection from Database
function toggleRealSlot(slotId, slotTime, price) {
    const slotElement = document.querySelector(`[data-slot-id="${slotId}"]`);
    
    if (bookingState.selectedSlots.find(s => s.id === slotId)) {
        // Remove slot
        bookingState.selectedSlots = bookingState.selectedSlots.filter(s => s.id !== slotId);
        slotElement.classList.remove('selected');
        console.log('âž– Removed real slot:', slotTime, 'ID:', slotId);
    } else {
        // Add slot
        bookingState.selectedSlots.push({ 
            id: slotId, 
            time: slotTime, 
            price: parseFloat(price) 
        });
        slotElement.classList.add('selected');
        console.log('âž• Added real slot:', slotTime, 'Price:', price, 'ID:', slotId);
    }
    
    updateBookingSummaryAsync();
}

// Custom Slot Management
function updateCustomSlot() {
    const startTime = document.getElementById('customStartTime').value;
    const endTime = document.getElementById('customEndTime').value;
    
    if (startTime && endTime) {
        if (startTime >= endTime) {
            document.getElementById('customSlotPreview').innerHTML = 
                '<div class="p-3 bg-red-900 border border-red-600 rounded text-red-200">End time must be after start time</div>';
            bookingState.customSlot = null;
            return;
        }
        
        const duration = calculateDuration(startTime, endTime);
        const price = duration * playgroundPrice;
        
        bookingState.customSlot = {
            time: `${startTime}-${endTime}`,
            price: price,
            duration: duration
        };
        
        document.getElementById('customSlotPreview').innerHTML = `
            <div class="p-3 bg-green-900 border border-green-600 rounded text-green-200">
                <div class="font-semibold">Custom Slot: ${startTime} - ${endTime}</div>
                <div class="text-sm">Duration: ${duration} hour${duration !== 1 ? 's' : ''}</div>
                <div class="text-sm">Price: $${price.toFixed(2)}</div>
            </div>
        `;
        
        console.log('ðŸ”§ Custom slot created:', bookingState.customSlot);
    } else {
        document.getElementById('customSlotPreview').innerHTML = '';
        bookingState.customSlot = null;
    }
    
    updateBookingSummaryAsync();
}

// Calculate duration between two times
function calculateDuration(startTime, endTime) {
    const start = new Date(`2000-01-01T${startTime}`);
    const end = new Date(`2000-01-01T${endTime}`);
    return (end - start) / (1000 * 60 * 60); // Convert to hours
}

// Load Amenities
async function loadAmenities() {
    console.log('ðŸŒŸ Loading amenities for playground:', PLAYGROUND_ID);
    console.log('ðŸ”§ DEBUG: loadAmenities function called');
    
    try {
        // Get amenities from playground details
        const response = await fetch(`/api/playground/${PLAYGROUND_ID}/`);
        console.log('ðŸ”§ DEBUG: Amenities API response:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            let amenitiesData = data.amenities || [];
            console.log('ðŸ“¦ Raw amenities data loaded:', amenitiesData);
            console.log('ðŸ”§ DEBUG: Number of amenities found:', amenitiesData.length);
            
            // Add stable IDs to amenities that don't have them
            amenitiesData = amenitiesData.map((amenity, index) => {
                if (!amenity.id) {
                    // Create ID using the same format the backend expects: p_name_index
                    const nameHash = amenity.name.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
                    amenity.id = `p_${nameHash}_${index}`;
                    console.log(`ðŸ”§ Generated backend-compatible ID for "${amenity.name}": ${amenity.id} (index: ${index})`);
                }
                return amenity;
            });
            
            console.log('ðŸ“¦ Processed amenities with IDs:', amenitiesData);
            
            // Process and render amenities
            if (amenitiesData.length > 0) {
                renderAmenities(amenitiesData);
            } else {
                showEmptyAmenities();
            }
        } else {
            console.log('âš ï¸ No amenities found');
            showEmptyAmenities();
        }
    } catch (error) {
        console.error('âŒ Error loading amenities:', error);
        showEmptyAmenities();
    }
}
        
        // Helper function to get appropriate icon for amenity
        function getAmenityIcon(amenityName) {
            const iconMap = {
                'parking': 'fas fa-parking',
                'wifi': 'fas fa-wifi',
                'restroom': 'fas fa-restroom',
                'washroom': 'fas fa-restroom',
                'drinking water': 'fas fa-tint',
                'water fountain': 'fas fa-tint',
                'security': 'fas fa-shield-alt',
                'changing room': 'fas fa-door-open',
                'equipment rental': 'fas fa-futbol',
                'locker': 'fas fa-lock',
                'towel': 'fas fa-spa',
                'refreshments': 'fas fa-coffee',
                'food': 'fas fa-utensils',
                'first aid': 'fas fa-first-aid',
                'lighting': 'fas fa-lightbulb'
            };
            
            const normalizedName = amenityName.toLowerCase();
            for (const [key, icon] of Object.entries(iconMap)) {
                if (normalizedName.includes(key)) {
                    return icon;
                }
            }
            return 'fas fa-star'; // Default icon
        }
        
        // Use template data from window object
        let amenitiesFromTemplate = window.playgroundAmenities || [];
        
        // Categorize amenities properly
        const categorizedAmenities = {
            free: [],
            paid: [],
            special: []
        };
        
        amenitiesFromTemplate.forEach(amenity => {
            const price = parseFloat(amenity.price || 0);
            const type = amenity.amenity_type || (price > 0 ? 'paid' : 'free');
            
            const amenityObj = {
                id: amenity.id,
                name: amenity.name,
                description: amenity.description || `${amenity.name} service`,
                price: price,
                type: type,
                icon: amenity.icon || getAmenityIcon(amenity.name)
            };
            
            if (type === 'special') {
                categorizedAmenities.special.push(amenityObj);
            } else if (price > 0 || type === 'paid') {
                categorizedAmenities.paid.push(amenityObj);
            } else {
                categorizedAmenities.free.push(amenityObj);
            }
        });
        
        console.log('âœ… Loaded amenities from template:', categorizedAmenities);
        renderAmenities(categorizedAmenities);
    


// Render Amenities - Unified function that handles both categorized and uncategorized data
function renderAmenities(amenities) {
    console.log('ðŸŽ¨ Rendering amenities:', amenities);
    
    // Handle uncategorized array (from API) - categorize it first
    if (Array.isArray(amenities)) {
        const categorized = {
            free: amenities.filter(a => parseFloat(a.price || 0) === 0),
            paid: amenities.filter(a => parseFloat(a.price || 0) > 0)
        };
        amenities = categorized;
        console.log('ðŸ”„ Categorized amenities:', amenities);
    }
    
    // Render free amenities
    const freeContainer = document.getElementById('freeAmenitiesContainer');
    if (amenities.free && amenities.free.length > 0) {
        freeContainer.innerHTML = `
            <div class="mb-4 p-4 rounded-lg" style="background: rgba(16, 185, 129, 0.1); border-left: 4px solid var(--primary-color);">
                <p style="color: var(--text-secondary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-gift" style="color: var(--primary-color);"></i> 
                    These amenities are included free with your booking
                </p>
            </div>
            <div class="slot-container">
                ${amenities.free.map((amenity, index) => {
                    // Generate ID for JSON amenities using index since they don't have database IDs
                    const amenityId = amenity.id || `p_${amenity.name.toLowerCase().replace(/[^\w]/g, '')}_${index}`;
                    console.log(`ðŸ“‹ Free amenity ID: ${amenityId} for ${amenity.name}`);
                    
                    return `
                    <div class="amenity-item free free-amenity" data-amenity-id="${amenityId}" onclick="selectAmenityInSection('${amenityId}', '${amenity.name}', 0, 'free')" style="cursor: pointer; position: relative; overflow: visible;">
                        <div class="amenity-info">
                            <div class="amenity-icon">
                                <i class="${amenity.icon}"></i>
                            </div>
                            <div class="amenity-details">
                                <h4>${amenity.name}</h4>
                                <p>${amenity.description}</p>
                            </div>
                        </div>
                        <div class="amenity-price">
                            <span style="color: var(--success-color); font-weight: 600; display: flex; align-items: center; gap: 0.25rem;">
                                <i class="fas fa-check"></i> FREE
                            </span>
                        </div>
                    </div>
                    `;
                }).join('')}
            </div>
        `;
        
        // DO NOT auto-select free amenities - let user choose
        console.log('âœ… Free amenities rendered - user can select manually');
    } else {
        freeContainer.innerHTML = '<p class="text-center py-4 text-secondary">No free amenities available</p>';
    }
    
    // Render paid amenities
    const paidContainer = document.getElementById('paidAmenitiesContainer');
    if (amenities.paid && amenities.paid.length > 0) {
        paidContainer.innerHTML = `
            <div class="mb-4 p-4 rounded-lg" style="background: rgba(245, 158, 11, 0.1); border-left: 4px solid var(--accent-color);">
                <p style="color: var(--text-secondary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-dollar-sign" style="color: var(--accent-color);"></i> 
                    Optional premium amenities to enhance your experience
                </p>
            </div>
            <div class="slot-container">
                ${amenities.paid.map((amenity, index) => {
                    // Generate ID for JSON amenities using index since they don't have database IDs
                    const amenityId = amenity.id || `p_${amenity.name.toLowerCase().replace(/[^\w]/g, '')}_${index}`;
                    console.log(`ðŸ’° Paid amenity ID: ${amenityId} for ${amenity.name} (price: ${amenity.price})`);
                    
                    const isSelected = bookingState.selectedAmenities.some(a => String(a.id) === String(amenityId));
                    return `
                    <div class="amenity-item paid-amenity ${isSelected ? 'selected' : ''}" 
                         data-amenity-id="${amenityId}" 
                         onclick="selectAmenityInSection('${amenityId}', '${amenity.name}', ${amenity.price}, 'paid')"
                         style="position: relative; cursor: pointer; overflow: visible;">
                        
                        <!-- Selection Indicator -->
                        ${isSelected ? `
                        <div class="amenity-selected-indicator" style="
                            position: absolute;
                            top: -12px;
                            right: -12px;
                            background: linear-gradient(135deg, var(--primary-color), #059669);
                            color: white;
                            border-radius: 50%;
                            width: 36px;
                            height: 36px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 16px;
                            font-weight: bold;
                            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.6);
                            animation: selectedPulse 0.6s ease-out;
                            border: 3px solid white;
                            z-index: 15;
                        ">
                            <i class="fas fa-check"></i>
                        </div>
                        ` : ''}
                        
                        <div class="amenity-info">
                            <div class="amenity-icon" style="
                                background: ${isSelected ? 'var(--primary-color)' : 'var(--accent-color)'};
                                transform: ${isSelected ? 'scale(1.1)' : 'scale(1)'};
                                transition: all 0.3s ease;
                            ">
                                <i class="${amenity.icon}"></i>
                            </div>
                            <div class="amenity-details">
                                <h4 style="color: ${isSelected ? 'var(--primary-color)' : 'var(--text-primary)'}; font-weight: ${isSelected ? '700' : '600'};">
                                    ${amenity.name}
                                </h4>
                                <p>${amenity.description}</p>
                            </div>
                        </div>
                        <div class="amenity-price">
                            <span style="color: ${isSelected ? 'var(--primary-color)' : 'var(--accent-color)'}; font-weight: 600; font-size: 1.1rem;">
                                ${getCurrencySymbol(bookingState.playgroundData?.currency || 'BDT')}${parseFloat(amenity.price || 0).toFixed(2)}
                            </span>
                        </div>
                        <div class="slot-status ${isSelected ? 'selected' : 'available'}" style="
                            margin-top: 0.5rem; 
                            padding: 0.5rem; 
                            border-top: 1px solid var(--border-color);
                            background: ${isSelected ? 'rgba(16, 185, 129, 0.1)' : 'transparent'};
                            border-radius: 0 0 8px 8px;
                            color: ${isSelected ? 'var(--primary-color)' : 'var(--text-secondary)'};
                            font-weight: ${isSelected ? '600' : '500'};
                            transition: all 0.3s ease;
                        ">
                            <i class="fas ${isSelected ? 'fa-check-circle' : 'fa-plus-circle'}"></i>
                            <span>${isSelected ? 'Added to booking' : 'Click to add'}</span>
                        </div>
                    </div>
                `}).join('')}
            </div>
        `;
    } else {
        paidContainer.innerHTML = '<p class="text-center py-4 text-secondary">No paid amenities available</p>';
    }
    
    updateBookingSummaryAsync();
    
    // Visual states are handled individually by selectAmenity function
    console.log('ðŸ”„ Amenity rendering completed');
}

// Professional Amenity Toggle - Enhanced Visual Feedback
// ðŸŽ¯ REMOVED DUPLICATE FUNCTION - Using selectAmenity instead

// Load Real Membership Passes from Database - Enhanced
async function loadMembershipPasses() {
    console.log('ðŸŽ« Loading REAL membership passes professionally for playground:', PLAYGROUND_ID);
    
    const container = document.getElementById('membership-slots-grid');
    if (container) {
        container.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-primary"></i> Loading membership passes from database...</div>';
    }
    
    try {
        // Include selected date to check for booking conflicts
        const selectedDate = window.bookingState?.selectedDate || document.getElementById('booking-date')?.value || new Date().toISOString().split('T')[0];
        const response = await fetch(`/api/membership-passes/${PLAYGROUND_ID}/?date=${selectedDate}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        const data = await response.json();
        console.log('ðŸ”¥ Real membership passes received:', data);
        
        if (data.success && data.passes && data.passes.length > 0) {
            // Store data for re-rendering
            sessionStorage.setItem('membershipPassesData', JSON.stringify(data.passes));
            renderMembershipPassesInSlots(data.passes);
            console.log('âœ… Membership passes loaded successfully:', data.passes.length);
        } else {
            container.innerHTML = '<p class="text-center py-4 text-secondary">No membership passes available for this playground</p>';
            console.log('âš ï¸ No membership passes found');
        }
    } catch (error) {
        console.error('âŒ Error loading real membership passes:', error);
        container.innerHTML = '<p class="text-center py-4 text-error-color">Failed to load membership passes. Please try again.</p>';
    }
}

// Render Real Membership Passes from Database
function renderRealMembershipPasses(passes) {
    const container = document.getElementById('membershipPassesContainer');
    
    if (!passes || passes.length === 0) {
        container.innerHTML = '<p class="text-center py-4 text-secondary">No membership passes available</p>';
        return;
    }
    
    container.innerHTML = `
        <div class="mb-4 p-4 rounded-lg" style="background: rgba(245, 158, 11, 0.1); border-left: 4px solid var(--accent-color);">
            <p style="color: var(--text-secondary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-id-card" style="color: var(--accent-color);"></i> 
                Choose a membership pass for unlimited access and exclusive benefits
            </p>
        </div>
        <div class="membership-container">
            ${passes.map(pass => `
                <div class="membership-pass" data-pass-id="${pass.id}" onclick="selectRealMembershipPass(${pass.id}, '${pass.name}', ${pass.price}, '${pass.duration_type}', ${pass.duration_days})">
                    <div class="pass-header">
                        <div class="pass-title">
                            <i class="fas fa-crown" style="color: var(--accent-color); margin-right: 0.5rem;"></i>
                            ${pass.name}
                        </div>
                        <div class="pass-price">${getCurrencySymbol(pass.currency || bookingState.playgroundData?.currency || 'BDT')} ${parseFloat(pass.price).toFixed(2)}</div>
                    </div>
                    <p class="text-secondary mb-3">${pass.description || `${pass.duration_days} days unlimited access to this playground`}</p>
                    <div class="slot-details mb-3">
                        <span class="slot-detail-tag">
                            <i class="fas fa-clock"></i> ${pass.duration_days} days
                        </span>
                        ${pass.duration_type ? `<span class="slot-detail-tag"><i class="fas fa-tag"></i> ${pass.duration_type}</span>` : ''}
                        <span class="slot-detail-tag">
                            <i class="fas fa-infinity"></i> Unlimited Access
                        </span>
                    </div>
                    <ul class="pass-features">
                        <li><i class="fas fa-check"></i> Unlimited slot bookings</li>
                        <li><i class="fas fa-check"></i> Priority booking system</li>
                        <li><i class="fas fa-check"></i> All free amenities included</li>
                        ${pass.duration_days >= 30 ? '<li><i class="fas fa-check"></i> Guest passes included</li>' : ''}
                        ${pass.duration_days >= 90 ? '<li><i class="fas fa-check"></i> Exclusive member events</li>' : ''}
                        ${pass.duration_days >= 365 ? '<li><i class="fas fa-check"></i> Personal trainer consultation</li>' : ''}
                    </ul>
                    <div class="slot-status available" style="margin-top: 1rem;">
                        <i class="fas fa-star"></i>
                        <span>Premium Membership</span>
                    </div>
                    <input type="radio" name="membership_pass" value="${pass.id}" style="display: none;">
                </div>
            `).join('')}
        </div>
    `;
}

// Select Real Membership Pass from Database
function selectRealMembershipPass(id, name, price, durationType, durationDays) {
    // Remove previous selection
    document.querySelectorAll('.membership-pass').forEach(pass => {
        pass.classList.remove('selected');
    });
    
    // Select new pass
    const passElement = document.querySelector(`[data-pass-id="${id}"]`);
    passElement.classList.add('selected');
    passElement.querySelector('input[type="radio"]').checked = true;
    
    bookingState.selectedMembershipPass = { 
        id, 
        name, 
        price: parseFloat(price),
        duration_type: durationType,
        duration_days: durationDays
    };
    document.getElementById('selectedMembershipPass').value = id;
    
    console.log('ðŸŽ« Selected real membership pass:', name, 'Price:', price, 'Duration:', durationDays, 'days');
    updateBookingSummaryAsync();
}

// Update Hidden Form Fields
function updateHiddenFields() {
    if (bookingState.type === 'slots') {
        if (bookingState.slotType === 'regular') {
            document.getElementById('selectedSlots').value = JSON.stringify(bookingState.selectedSlots);
            
            if (bookingState.selectedSlots.length > 0) {
                const times = bookingState.selectedSlots.map(slot => slot.time.split('-'));
                const startTimes = times.map(t => t[0]);
                const endTimes = times.map(t => t[1]);
                
                const earliestStart = startTimes.sort()[0];
                const latestEnd = endTimes.sort().reverse()[0];
                
                document.getElementById('startTime').value = earliestStart;
                document.getElementById('endTime').value = latestEnd;
            }
        } else if (bookingState.slotType === 'custom' && bookingState.customSlot) {
            document.getElementById('selectedSlots').value = JSON.stringify([{
                type: 'custom',
                start_time: bookingState.customSlot.start_time,
                end_time: bookingState.customSlot.end_time,
                duration: bookingState.customSlot.duration,
                price: bookingState.customSlot.price
            }]);
            document.getElementById('startTime').value = bookingState.customSlot.start_time;
            document.getElementById('endTime').value = bookingState.customSlot.end_time;
        } else if (bookingState.slotType === 'membership' && bookingState.selectedMembership) {
            document.getElementById('selectedSlots').value = JSON.stringify([{
                type: 'membership',
                id: bookingState.selectedMembership.id,
                start_time: bookingState.selectedMembership.start_time,
                end_time: bookingState.selectedMembership.end_time,
                price: bookingState.selectedMembership.price
            }]);
            document.getElementById('startTime').value = bookingState.selectedMembership.start_time;
            document.getElementById('endTime').value = bookingState.selectedMembership.end_time;
        }
    }
    
    document.getElementById('selectedAmenities').value = JSON.stringify(bookingState.selectedAmenities);
}

// Payment Method Selection - REMOVED DUPLICATE (API version below handles element parameter)

// Form submission
document.getElementById('checkoutForm').addEventListener('submit', function(e) {
    e.preventDefault(); // Prevent default form submission
    console.log('ðŸ”¥ ENHANCED CHECKOUT FORM SUBMIT TRIGGERED!');
    
    // Copy phone number to contact_phone field
    const phoneNumber = document.querySelector('[name="phone_number"]').value;
    document.getElementById('contactPhone').value = phoneNumber;
    
    // Debug log all form fields
    const formData = new FormData(this);
    console.log('ðŸ“ Form data being submitted:');
    for (let [key, value] of formData.entries()) {
        console.log(`  ${key}: ${value}`);
    }
    
    // Log booking state
    console.log('ðŸ“Š Booking state:', bookingState);
    
    // Validate form (removed payment_method since we use separate payment page)
    const requiredFields = ['booking_date', 'first_name', 'last_name', 'email', 'phone_number', 'number_of_players'];
    let isValid = true;
    let missingFields = [];
    
    requiredFields.forEach(field => {
        const input = document.querySelector(`[name="${field}"]`);
        if (!input || !input.value) {
            isValid = false;
            missingFields.push(field);
            if (input) input.style.borderColor = '#dc2626';
        } else {
            input.style.borderColor = '';
        }
    });
    
    console.log('ðŸ“‹ Missing fields:', missingFields);
    console.log('âœ… Terms checked:', document.getElementById('terms').checked);
    
    // Validate booking type specific requirements
    // Validation based on booking type
    if (bookingState.type === 'slots') {
        const hasRegularSlots = bookingState.selectedSlots && bookingState.selectedSlots.length > 0;
        const hasCustomSlot = bookingState.customSlot !== null;
        
        if (!hasRegularSlots && !hasCustomSlot) {
            e.preventDefault();
            alert('â° Please select at least one time slot first!');
            return;
        }
    } else if (bookingState.type === 'membership') {
        if (!bookingState.selectedMembershipPass) {
            e.preventDefault();
            alert('ðŸŽ« Please select a membership pass first!');
            return;
        }
    } else {
        // Auto-detect booking type if not set
        const hasMembershipPass = bookingState.selectedMembershipPass !== null && bookingState.selectedMembershipPass !== undefined;
        const hasSlots = (bookingState.selectedSlots && bookingState.selectedSlots.length > 0) || bookingState.customSlot !== null;
        
        if (hasMembershipPass) {
            // Membership booking - no slots required
            console.log('âœ… Membership booking detected, proceeding without time slots');
        } else if (hasSlots) {
            // Regular slot booking
            console.log('âœ… Slot booking detected, proceeding with selected slots');
        } else {
            // No valid booking data
            e.preventDefault();
            alert('â° Please select at least one time slot or membership pass first!');
            return;
        }
    }
    
    if (!document.getElementById('terms').checked) {
        e.preventDefault();
        alert('ðŸ“‹ Please accept the terms and conditions to continue.');
        document.getElementById('terms').focus();
        return;
    }
    
    if (!isValid) {
        e.preventDefault();
        alert('ðŸ“ Please fill in all required fields to complete your booking.');
        return;
    }
    
    // Show loading state
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    submitBtn.disabled = true;
    
    // Instead of creating booking immediately, show payment section first
    console.log('ï¿½ Proceeding to payment page...');
    
    // Store form data for later booking creation after payment
    window.pendingBookingData = new FormData(this);
    
    // Define slot status variables for payment summary
    const hasRegularSlots = bookingState.selectedSlots && bookingState.selectedSlots.length > 0;
    const hasCustomSlot = bookingState.customSlot !== null;
    
    // Add dynamic slot data to pending booking data
    if (bookingState.type === 'slots') {
        if (hasRegularSlots) {
            // For regular slots, get start and end times from slot objects
            const firstSlot = bookingState.selectedSlots[0];
            const lastSlot = bookingState.selectedSlots[bookingState.selectedSlots.length - 1];
            
            // Convert 12-hour format to 24-hour format
            const startTime24 = convertTo24Hour(firstSlot.start_time) || '09:00';
            const endTime24 = convertTo24Hour(lastSlot.end_time) || '10:00';
            
            window.pendingBookingData.append('start_time', startTime24);
            window.pendingBookingData.append('end_time', endTime24);
        } else if (hasCustomSlot) {
            // For custom slots, extract times from the time string
            const timeString = bookingState.customSlot.time || '09:00 - 10:00';
            const timeParts = timeString.split(' - ');
            
            const startTime24 = convertTo24Hour(timeParts[0]) || '09:00';
            const endTime24 = convertTo24Hour(timeParts[1]) || '10:00';
            
            window.pendingBookingData.append('start_time', startTime24);
            window.pendingBookingData.append('end_time', endTime24);
        } else {
            // Fallback times
            window.pendingBookingData.append('start_time', '09:00');
            window.pendingBookingData.append('end_time', '10:00');
        }
    } else if (bookingState.type === 'membership' && bookingState.selectedMembershipPass) {
        // For membership passes, set default time range
        window.pendingBookingData.append('start_time', '09:00');
        window.pendingBookingData.append('end_time', '21:00');
        window.pendingBookingData.append('special_requests', `Membership Pass: ${bookingState.selectedMembershipPass.name}`);
    } else {
        // Default fallback times
        window.pendingBookingData.append('start_time', '09:00');
        window.pendingBookingData.append('end_time', '10:00');
    }
    
    // Add total amount
    window.pendingBookingData.append('total_amount', bookingState.totalAmount.toFixed(2));
    
    // Debug: Log form data that will be sent after payment
    console.log('ðŸ“‹ Booking data prepared for after payment:');
    for (let [key, value] of window.pendingBookingData.entries()) {
        console.log(`  ${key}: ${value}`);
    }
    
    // CRITICAL: Debug time format prepared
    console.log('ðŸ• Time format debug:', {
        originalStartTime: hasRegularSlots ? bookingState.selectedSlots[0].start_time : 'N/A',
        originalEndTime: hasRegularSlots ? bookingState.selectedSlots[0].end_time : 'N/A',
        convertedStartTime: hasRegularSlots ? convertTo24Hour(bookingState.selectedSlots[0].start_time) : 'N/A',
        convertedEndTime: hasRegularSlots ? convertTo24Hour(bookingState.selectedSlots[0].end_time) : 'N/A'
    });
    
    // Create multi-step booking flow: Booking Details â†’ Payment â†’ Confirmation
    proceedToPaymentStep();
});

// Utility Functions
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// DEBUGGING FUNCTION - Check if all required elements exist
function debugMultiStepElements() {
    console.log('ðŸ” Debugging multi-step elements...');
    
    const elements = {
        mainContainer: document.querySelector('.container'),
        multiStepContainer: document.getElementById('multiStepContainer'),
        step1: document.getElementById('step1'),
        step2: document.getElementById('step2'),
        step3: document.getElementById('step3'),
        paymentStepContent: document.getElementById('paymentStepContent'),
        confirmationStepContent: document.getElementById('confirmationStepContent'),
        submitBtn: document.getElementById('submitBtn')
    };
    
    Object.entries(elements).forEach(([name, element]) => {
        if (element) {
            console.log(`âœ… ${name}: Found`);
        } else {
            console.error(`âŒ ${name}: NOT FOUND`);
        }
    });
    
    return elements;
}

// MULTI-STEP BOOKING FLOW FUNCTIONS
function proceedToPaymentStep() {
    console.log('ðŸŽ¯ Proceeding to payment step via API...');
    
    const submitBtn = document.getElementById('submitBtn');
    
    try {
        // Validate form data first
        if (!validateBookingForm()) {
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-credit-card"></i> Proceed to Payment';
                submitBtn.disabled = false;
            }
            return;
        }
        
        // Show loading state
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading Payment...';
            submitBtn.disabled = true;
        }
        
        // âœ… CRITICAL: Update hidden form fields with amenities BEFORE creating FormData
        updateHiddenFormFields();
        console.log('âœ… Hidden form fields updated with amenities:', bookingState.selectedAmenities);
        
        // Store form data
        window.bookingFormData = new FormData(document.getElementById('checkoutForm'));
        
        // âœ… CRITICAL FIX: Explicitly set amenities as JSON string to override any form value
        const amenitiesJSON = JSON.stringify(bookingState.selectedAmenities || []);
        window.bookingFormData.set('selected_amenities', amenitiesJSON);
        console.log('âœ… VERSION: 2025-10-02-AMENITY-FIX-V2');
        console.log('âœ… Explicitly set amenities in FormData:', amenitiesJSON);
        console.log('âœ… Number of amenities:', (bookingState.selectedAmenities || []).length);
        
        addSlotDataToForm(window.bookingFormData);
        
        // Fetch payment page data from API
        fetch(`/bookings/api/payment-page/${PLAYGROUND_ID}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('âœ… Payment API response received:', data);
            if (data.success) {
                console.log('âœ… Payment API response:', data);
                showAPIPaymentPage(data);
            } else {
                console.error('âŒ API returned error:', data.error);
                throw new Error(data.error || 'Failed to load payment page');
            }
        })
        .catch(error => {
            console.error('âŒ Payment API error:', error);
            alert('Failed to load payment page. Please try again.');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-credit-card"></i> Proceed to Payment';
                submitBtn.disabled = false;
            }
        });
        
    } catch (error) {
        console.error('âŒ Error in proceedToPaymentStep:', error);
        alert('An error occurred. Please try again.');
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-credit-card"></i> Proceed to Payment';
            submitBtn.disabled = false;
        }
    }
}

// Show API-based payment page
function showAPIPaymentPage(paymentData) {
    console.log('ðŸŽ¨ Creating API-based payment page...');
    console.log('Payment data received:', paymentData);
    
    // Store payment data globally for functions to access
    window.paymentData = paymentData;
    console.log('ðŸŒ Payment data stored globally');
    
    // Update booking state type based on current selections
    window.updateBookingStateType();
    
    try {
        const mainContainer = document.querySelector('.checkout-container');
        if (!mainContainer) {
            console.error('âŒ Main container (.checkout-container) not found!');
            console.log('ðŸ” Available containers:', document.querySelectorAll('[class*="container"]'));
            throw new Error('Main container not found');
        }
        
        // Check if bookingState exists
        if (!window.bookingState) {
            console.error('âŒ bookingState not found, using fallback values');
            window.bookingState = {
                selectedDate: document.querySelector('[name="booking_date"]')?.value || 'Not selected',
                selectedSlots: [{ start_time: '11:30 AM', end_time: '12:30 PM' }],
                totalAmount: 25.00
            };
        }
        
        // Check if bookingFormData exists
        if (!window.bookingFormData) {
            console.error('âŒ bookingFormData not found, creating fallback');
            window.bookingFormData = new FormData(document.getElementById('checkoutForm'));
        }
        
        console.log('BookingState:', window.bookingState);
        console.log('BookingFormData player count:', window.bookingFormData.get('number_of_players'));
    
        // Create payment page HTML with base template structure
        const paymentHTML = `
            <!-- Main Content (No duplicate navbar - using global navbar from base.html) -->
            <div style="min-height: calc(100vh - 140px); background: linear-gradient(135deg, #1f2937 0%, #111827 100%); padding: 40px 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin-top: 0;">
                <div style="max-width: 1200px; margin: 0 auto;">
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #374151 0%, #1f2937 100%); padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center; border: 1px solid #4b5563; box-shadow: 0 10px 25px rgba(0,0,0,0.3);">
                        <h1 style="color: #f9fafb; margin-bottom: 10px; font-size: 2.2em; font-weight: 700;">ðŸ’³ Complete Your Payment</h1>
                        <p style="color: #d1d5db; font-size: 1.1em;">Secure payment for ${paymentData.playground.name}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                        <!-- Booking Summary -->
                        <div style="background: linear-gradient(135deg, #374151 0%, #1f2937 100%); padding: 30px; border-radius: 15px; border: 1px solid #4b5563; box-shadow: 0 10px 25px rgba(0,0,0,0.3);">
                            <h3 style="color: #f9fafb; margin-bottom: 25px; font-size: 1.3em; font-weight: 600;"><i class="fas fa-receipt" style="color: #10b981; margin-right: 10px;"></i> Booking Summary</h3>
                            
                            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #4b5563;">
                                <span style="color: #d1d5db;"><i class="fas fa-calendar" style="color: #10b981; margin-right: 8px;"></i> Date:</span>
                                <span style="color: #f9fafb; font-weight: bold;">${window.bookingState.selectedDate}</span>
                            </div>
                            
                            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #4b5563;">
                                <span style="color: #d1d5db;"><i class="fas fa-clock" style="color: #10b981; margin-right: 8px;"></i> Time:</span>
                                <span style="color: #f9fafb; font-weight: bold;">${getBookingTimeDisplay()}</span>
                            </div>
                            
                            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #4b5563;">
                                <span style="color: #d1d5db;"><i class="fas fa-users" style="color: #10b981; margin-right: 8px;"></i> Players:</span>
                                <span style="color: #f9fafb; font-weight: bold;">${window.bookingFormData.get('number_of_players')}</span>
                            </div>
                            
                            <div style="margin-top: 30px; padding: 20px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; border: 1px solid #10b981;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: #f9fafb; font-weight: bold; font-size: 1.2em;">Total Amount:</span>
                                    <span style="color: #10b981; font-weight: bold; font-size: 1.8em;">${paymentData.playground.currency} ${window.bookingState.totalAmount.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Payment Methods -->
                        <div style="background: linear-gradient(135deg, #374151 0%, #1f2937 100%); padding: 30px; border-radius: 15px; border: 1px solid #4b5563; box-shadow: 0 10px 25px rgba(0,0,0,0.3);">
                            <h3 style="color: #f9fafb; margin-bottom: 25px; font-size: 1.3em; font-weight: 600;"><i class="fas fa-credit-card" style="color: #10b981; margin-right: 10px;"></i> Choose Payment Method</h3>
                            
                            <div id="paymentMethodsContainer">
                                ${paymentData.payment_methods.map(method => `
                                    <label style="display: block; margin-bottom: 15px; padding: 18px; border: 2px solid #4b5563; border-radius: 12px; cursor: pointer; transition: all 0.3s; background: rgba(55, 65, 81, 0.3);" 
                                           onmouseover="this.style.borderColor='#10b981'; this.style.background='rgba(16, 185, 129, 0.1)'" 
                                           onmouseout="this.querySelector('input:checked') ? (this.style.borderColor='#10b981', this.style.background='rgba(16, 185, 129, 0.1)') : (this.style.borderColor='#4b5563', this.style.background='rgba(55, 65, 81, 0.3)')"
                                           onclick="selectPaymentMethod('${method.id}', this)">
                                        <input type="radio" name="final_payment_method" value="${method.id}" style="margin-right: 12px; accent-color: #10b981;" ${method.id === 'bank_transfer' ? 'checked' : ''}>
                                        <i class="${method.icon}" style="margin-right: 12px; color: #10b981; font-size: 1.1em;"></i>
                                        <span style="color: #f9fafb; font-weight: 500; font-size: 1.05em;">${method.name}</span>
                                    </label>
                                `).join('')}
                            </div>
                            
                            ${paymentData.bank_details ? `
                            <div id="bankDetails" style="background: rgba(251, 191, 36, 0.1); padding: 20px; border-radius: 12px; margin-top: 25px; border: 1px solid #f59e0b;">
                                <h4 style="color: #f9fafb; margin-bottom: 15px; font-size: 1.1em;"><i class="fas fa-university" style="color: #f59e0b; margin-right: 8px;"></i> Bank Details:</h4>
                                <p style="color: #d1d5db; margin: 8px 0;"><strong style="color: #f9fafb;">Bank:</strong> ${paymentData.bank_details.bank_name}</p>
                                <p style="color: #d1d5db; margin: 8px 0;"><strong style="color: #f9fafb;">Account:</strong> ${paymentData.bank_details.account_number}</p>
                                <p style="color: #d1d5db; margin: 8px 0;"><strong style="color: #f9fafb;">Name:</strong> ${paymentData.bank_details.account_name}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="text-align: center; padding: 30px;">
                        <button onclick="goBackToBooking()" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; padding: 15px 30px; border: none; border-radius: 12px; margin-right: 20px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)'" onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'">
                            <i class="fas fa-arrow-left"></i> Back to Booking
                        </button>
                        <button onclick="confirmPaymentAndBooking()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px 40px; border: none; border-radius: 12px; font-size: 1.2em; cursor: pointer; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(16, 185, 129, 0.3)'">
                            <i class="fas fa-check"></i> Confirm Booking & Pay
                        </button>
                    </div>
                </div>
            </div>
    `;
    
    // Hide main container and replace it with payment content
    console.log('ðŸ” Hiding main container and creating payment overlay...');
    console.log('ðŸ” Main container found:', mainContainer);
    console.log('ðŸ” Main container ID:', mainContainer?.id);
    console.log('ðŸ” Main container classes:', mainContainer?.className);
    console.log('ðŸ” Main container parent:', mainContainer?.parentElement);
    
    // IMPORTANT: Save CSRF token before replacing content
    const csrfToken = getCsrfToken();
    console.log('ðŸ” Preserving CSRF token:', csrfToken ? csrfToken.substring(0, 10) + '...' : 'NOT FOUND');
    
    // Remove any existing payment overlays
    const existingOverlay = document.getElementById('paymentOverlay');
    if (existingOverlay) {
        existingOverlay.remove();
    }
    
    // Helper function to get booking time display
    function getBookingTimeDisplay() {
        // Regular slots
        if (window.bookingState.selectedSlots && window.bookingState.selectedSlots.length > 0) {
            const slot = window.bookingState.selectedSlots[0];
            return `${slot.start_time} - ${slot.end_time}`;
        }
        // Custom slots
        else if (window.bookingState.customSlot) {
            // Custom slots have a "time" field like "07:00 PM - 09:00 PM"
            return window.bookingState.customSlot.time || 'Custom slot time';
        }
        // Membership passes
        else if (window.bookingState.selectedMembershipPass) {
            // For membership passes, show slot type and pass name
            return `Membership - ${window.bookingState.selectedMembershipPass.name || 'Membership Pass'}`;
        }
        // Membership slots (if using the old selectedMembership)
        else if (window.bookingState.selectedMembership) {
            return `${window.bookingState.selectedMembership.start_time} - ${window.bookingState.selectedMembership.end_time}`;
        }
        
        return 'Time not selected';
    }
    
    // Helper function to get booking extras display
    function getBookingExtrasDisplay() {
        let extrasHTML = '';
        
        // Show selected amenities
        if (window.bookingState.selectedAmenities && window.bookingState.selectedAmenities.length > 0) {
            extrasHTML += `
                <div style="margin-bottom: 20px; padding: 15px 0; border-bottom: 1px solid #4b5563;">
                    <div style="color: #d1d5db; margin-bottom: 10px;"><i class="fas fa-star" style="color: #10b981; margin-right: 8px;"></i> Selected Amenities:</div>
                    ${window.bookingState.selectedAmenities.map(amenity => `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="color: #f9fafb;">â€¢ ${amenity.name}</span>
                            <span style="color: #10b981; font-weight: bold;">+${paymentData.playground.currency} ${amenity.price}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Show selected membership pass
        if (window.bookingState.selectedMembershipPass) {
            extrasHTML += `
                <div style="margin-bottom: 20px; padding: 15px 0; border-bottom: 1px solid #4b5563;">
                    <div style="color: #d1d5db; margin-bottom: 10px;"><i class="fas fa-crown" style="color: #f59e0b; margin-right: 8px;"></i> Membership Pass:</div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #f9fafb; font-weight: bold;">${window.bookingState.selectedMembershipPass.name}</span>
                        <span style="color: #f59e0b; font-weight: bold;">${paymentData.playground.currency} ${window.bookingState.selectedMembershipPass.price}</span>
                    </div>
                </div>
            `;
        }
        
        return extrasHTML;
    }
    
    // Create payment content (just the payment form, no nav/footer)
    const paymentContent = `
        <form style="display: none;" id="hiddenCSRFForm">
            <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
        </form>
        <div style="min-height: calc(100vh - 200px); background: linear-gradient(135deg, #1f2937 0%, #111827 100%); padding: 40px 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
            <div style="max-width: 1200px; margin: 0 auto;">
                <!-- Header -->
                <div style="background: linear-gradient(135deg, #374151 0%, #1f2937 100%); padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center; border: 1px solid #4b5563; box-shadow: 0 10px 25px rgba(0,0,0,0.3);">
                    <h1 style="color: #f9fafb; margin-bottom: 10px; font-size: 2.2em; font-weight: 700;">ðŸ’³ Complete Your Payment</h1>
                    <p style="color: #d1d5db; font-size: 1.1em;">Secure payment for ${paymentData.playground.name}</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <!-- Booking Summary -->
                    <div style="background: linear-gradient(135deg, #374151 0%, #1f2937 100%); padding: 30px; border-radius: 15px; border: 1px solid #4b5563; box-shadow: 0 10px 25px rgba(0,0,0,0.3);">
                        <h3 style="color: #f9fafb; margin-bottom: 25px; font-size: 1.3em; font-weight: 600;"><i class="fas fa-receipt" style="color: #10b981; margin-right: 10px;"></i> Booking Summary</h3>
                        
                        <div style="margin-bottom: 20px; display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #4b5563;">
                            <span style="color: #d1d5db;"><i class="fas fa-calendar" style="color: #10b981; margin-right: 8px;"></i> Date:</span>
                            <span style="color: #f9fafb; font-weight: bold;">${window.bookingState.selectedDate}</span>
                        </div>
                        
                        <div style="margin-bottom: 20px; display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #4b5563;">
                            <span style="color: #d1d5db;"><i class="fas fa-clock" style="color: #10b981; margin-right: 8px;"></i> Time:</span>
                            <span style="color: #f9fafb; font-weight: bold;">${getBookingTimeDisplay()}</span>
                        </div>
                        
                        <div style="margin-bottom: 20px; display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #4b5563;">
                            <span style="color: #d1d5db;"><i class="fas fa-users" style="color: #10b981; margin-right: 8px;"></i> Players:</span>
                            <span style="color: #f9fafb; font-weight: bold;">${window.bookingFormData.get('number_of_players')}</span>
                        </div>
                        
                        ${getBookingExtrasDisplay()}
                        
                        <div style="margin-top: 30px; padding: 20px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; border: 1px solid #10b981;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #f9fafb; font-weight: bold; font-size: 1.2em;">Total Amount:</span>
                                <span style="color: #10b981; font-weight: bold; font-size: 1.8em;">${paymentData.playground.currency} ${window.bookingState.totalAmount.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Methods -->
                    <div style="background: linear-gradient(135deg, #374151 0%, #1f2937 100%); padding: 30px; border-radius: 15px; border: 1px solid #4b5563; box-shadow: 0 10px 25px rgba(0,0,0,0.3);">
                        <h3 style="color: #f9fafb; margin-bottom: 25px; font-size: 1.3em; font-weight: 600;"><i class="fas fa-credit-card" style="color: #10b981; margin-right: 10px;"></i> Choose Payment Method</h3>
                        
                        <div id="paymentMethodsContainer">
                            ${paymentData.payment_methods.map(method => `
                                <label style="display: block; margin-bottom: 15px; padding: 18px; border: 2px solid #4b5563; border-radius: 12px; cursor: pointer; transition: all 0.3s; background: rgba(55, 65, 81, 0.3);" 
                                       onmouseover="this.style.borderColor='#10b981'; this.style.background='rgba(16, 185, 129, 0.1)'" 
                                       onmouseout="this.querySelector('input:checked') ? (this.style.borderColor='#10b981', this.style.background='rgba(16, 185, 129, 0.1)') : (this.style.borderColor='#4b5563', this.style.background='rgba(55, 65, 81, 0.3)')"
                                       onclick="selectPaymentMethod('${method.id}', this)">
                                    <input type="radio" name="final_payment_method" value="${method.id}" style="margin-right: 12px; accent-color: #10b981;" ${method.id === 'bank_transfer' ? 'checked' : ''}>
                                    <i class="${method.icon}" style="margin-right: 12px; color: #10b981; font-size: 1.1em;"></i>
                                    <span style="color: #f9fafb; font-weight: 500; font-size: 1.05em;">${method.name}</span>
                                </label>
                            `).join('')}
                        </div>
                        
                        ${paymentData.bank_details ? `
                        <div id="bankDetails" style="background: rgba(251, 191, 36, 0.1); padding: 25px; border-radius: 12px; margin-top: 25px; border: 1px solid #f59e0b;">
                            <h4 style="color: #f9fafb; margin-bottom: 20px; font-size: 1.2em; display: flex; align-items: center;">
                                <i class="fas fa-university" style="color: #f59e0b; margin-right: 10px;"></i> 
                                Payment Details
                            </h4>
                            
                            <!-- Dynamic Bank Account Info -->
                            <div id="bankAccountInfo">
                                <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 12px; border: 1px solid #10b981;">
                                    <h4 style="color: #10b981; margin-bottom: 15px; display: flex; align-items: center;">
                                        <i class="fas fa-university" style="margin-right: 10px;"></i>
                                        Bank Account Details
                                    </h4>
                                    <div style="grid-template-columns: 1fr 1fr; gap: 15px; display: grid;">
                                        <div>
                                            <div style="color: #d1d5db; font-size: 0.9em; margin-bottom: 5px;">Bank Name:</div>
                                            <div style="color: #f9fafb; font-weight: bold; font-size: 1.1em;">${paymentData.bank_details.bank_name}</div>
                                        </div>
                                        <div>
                                            <div style="color: #d1d5db; font-size: 0.9em; margin-bottom: 5px;">Account Name:</div>
                                            <div style="color: #f9fafb; font-weight: bold; font-size: 1.1em;">${paymentData.bank_details.account_name}</div>
                                        </div>
                                        <div>
                                            <div style="color: #d1d5db; font-size: 0.9em; margin-bottom: 5px;">Account Number:</div>
                                            <div style="color: #10b981; font-weight: bold; font-size: 1.2em; font-family: monospace; letter-spacing: 1px;">${paymentData.bank_details.account_number}</div>
                                        </div>
                                        ${paymentData.bank_details.routing_number ? `
                                        <div>
                                            <div style="color: #d1d5db; font-size: 0.9em; margin-bottom: 5px;">Routing Number:</div>
                                            <div style="color: #f9fafb; font-weight: bold; font-size: 1.1em;">${paymentData.bank_details.routing_number}</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- QR Code Section -->
                            <div id="qrCodeSection" style="text-align: center; margin: 20px 0;">
                                <div style="background: white; padding: 15px; border-radius: 10px; display: inline-block;">
                                    <div style="width: 150px; height: 150px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 0.9em;">
                                        <div>
                                            <i class="fas fa-qrcode" style="font-size: 2em; margin-bottom: 10px; display: block;"></i>
                                            QR Code
                                        </div>
                                    </div>
                                </div>
                                <p style="color: #d1d5db; margin-top: 10px; font-size: 0.9em;">Scan QR code for quick payment</p>
                            </div>
                            
                            <!-- Receipt Upload Section -->
                            <div id="receiptUploadSection" style="background: rgba(239, 68, 68, 0.1); padding: 20px; border-radius: 10px; border: 1px solid #ef4444; margin-top: 20px;">
                                <h5 style="color: #f9fafb; margin-bottom: 15px; display: flex; align-items: center;">
                                    <i class="fas fa-upload" style="color: #ef4444; margin-right: 10px;"></i>
                                    Upload Payment Receipt <span style="color: #ef4444; margin-left: 5px;">*</span>
                                </h5>
                                <p style="color: #d1d5db; margin-bottom: 15px; font-size: 0.9em;">
                                    <strong>Required:</strong> After making the payment, please upload your transfer receipt or screenshot to confirm the booking.
                                </p>
                                
                                <div id="receiptUploadArea" style="border: 2px dashed #6b7280; border-radius: 8px; padding: 20px; text-align: center; background: rgba(0,0,0,0.2);">
                                    <input type="file" id="receiptUpload" accept="image/*" style="display: none;" onchange="handleReceiptUpload(this)">
                                    <label for="receiptUpload" style="cursor: pointer; display: block;">
                                        <i class="fas fa-cloud-upload-alt" style="font-size: 2em; color: #6b7280; margin-bottom: 10px; display: block;"></i>
                                        <span style="color: #d1d5db;">Click to upload receipt</span>
                                        <br>
                                        <span style="color: #9ca3af; font-size: 0.8em;">PNG, JPG, JPEG up to 5MB</span>
                                    </label>
                                </div>
                                
                                <div id="receiptPreview" style="margin-top: 15px; display: none; background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 8px; border: 1px solid #10b981;">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <div style="display: flex; align-items: center;">
                                            <img id="receiptImage" style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover; margin-right: 15px;">
                                            <div>
                                                <p id="receiptName" style="color: #10b981; margin: 0; font-weight: bold; font-size: 1.1em;"></p>
                                                <p style="color: #d1d5db; margin: 5px 0 0 0; font-size: 0.9em;">Receipt uploaded successfully</p>
                                            </div>
                                        </div>
                                        <button onclick="removeReceipt()" style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: all 0.3s; font-size: 0.9em;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                                            <i class="fas fa-trash"></i> Remove
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="text-align: center; padding: 30px;">
                    <button onclick="goBackToBooking()" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; padding: 15px 30px; border: none; border-radius: 12px; margin-right: 20px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)'" onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'">
                        <i class="fas fa-arrow-left"></i> Back to Booking
                    </button>
                    <button onclick="confirmPaymentAndBooking()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px 40px; border: none; border-radius: 12px; font-size: 1.2em; cursor: pointer; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(16, 185, 129, 0.3)'">
                        <i class="fas fa-check"></i> Confirm Booking & Pay
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Replace the innerHTML of the main container instead of creating new element
    mainContainer.innerHTML = paymentContent;
    mainContainer.id = 'paymentOverlay';
    
    // Store CSRF token globally for later use
    window.savedCSRFToken = csrfToken;
    
    console.log('âœ… Payment content replaced main container');
    console.log('ðŸŽ¨ Main container now contains payment form');
    console.log('ðŸ” Main container after replacement:', mainContainer);
    console.log('ðŸ” Main container display style:', window.getComputedStyle(mainContainer).display);
    console.log('ðŸ” Main container visibility:', window.getComputedStyle(mainContainer).visibility);
    console.log('ðŸ” Main container height:', window.getComputedStyle(mainContainer).height);
    console.log('ðŸ” Main container innerHTML length:', mainContainer.innerHTML.length);
    console.log('ðŸ” CSRF token stored globally:', window.savedCSRFToken ? 'YES' : 'NO');
    
    // Make functions globally accessible
    window.handleReceiptUpload = function(input) {
        console.log('ðŸ“¸ Receipt upload triggered');
        
        if (input.files && input.files[0]) {
            const file = input.files[0];
            
            // Validate file size (5MB limit)
            if (file.size > 5 * 1024 * 1024) {
                alert('âš ï¸ File size must be less than 5MB');
                input.value = '';
                return;
            }
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('âš ï¸ Please upload an image file (PNG, JPG, JPEG)');
                input.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                // Show preview
                const uploadArea = document.getElementById('receiptUploadArea');
                const preview = document.getElementById('receiptPreview');
                const image = document.getElementById('receiptImage');
                const name = document.getElementById('receiptName');
                
                if (image && name && preview && uploadArea) {
                    image.src = e.target.result;
                    name.textContent = file.name;
                    
                    // Hide upload area and show preview
                    uploadArea.style.display = 'none';
                    preview.style.display = 'block';
                    
                    // Store file data for later upload
                    window.selectedReceiptFile = file;
                    
                    console.log('âœ… Receipt file selected:', file.name);
                    console.log('ðŸ“ File size:', (file.size / 1024).toFixed(2), 'KB');
                }
            };
            reader.readAsDataURL(file);
        }
    };

    window.removeReceipt = function() {
        console.log('ðŸ—‘ï¸ Removing receipt');
        
        // Clear file input
        const fileInput = document.getElementById('receiptUpload');
        if (fileInput) {
            fileInput.value = '';
        }
        
        // Show upload area and hide preview
        const uploadArea = document.getElementById('receiptUploadArea');
        const preview = document.getElementById('receiptPreview');
        
        if (uploadArea && preview) {
            uploadArea.style.display = 'block';
            preview.style.display = 'none';
        }
        
        // Clear stored file
        window.selectedReceiptFile = null;
        
        console.log('âœ… Receipt removed successfully');
    };
    
    window.selectPaymentMethod = function(methodId, element) {
        console.log('ðŸ’³ Payment method selected:', methodId);
        
        // Update visual selection
        document.querySelectorAll('[name="final_payment_method"]').forEach(radio => {
            const label = radio.closest('label');
            if (label) { // Check if label exists
                if (radio.value === methodId) {
                    label.style.borderColor = '#10b981';
                    label.style.background = 'rgba(16, 185, 129, 0.1)';
                } else {
                    label.style.borderColor = '#4b5563';
                    label.style.background = 'rgba(55, 65, 81, 0.3)';
                }
            }
        });
        
        // Show/hide and update bank details based on payment method
        const bankDetails = document.getElementById('bankDetails');
        if (bankDetails) {
            if (methodId === 'bank_transfer' || methodId === 'mobile_banking') {
                bankDetails.style.display = 'block';
                // Call the update function
                setTimeout(() => {
                    window.updateBankDetailsForMethod(methodId);
                }, 100);
            } else {
                bankDetails.style.display = 'none';
            }
        }
    };

    window.updateBankDetailsForMethod = function(methodId) {
        console.log('ðŸ¦ Updating bank details for method:', methodId);
        
        const bankAccountSection = document.getElementById('bankAccountInfo');
        
        if (!bankAccountSection) {
            console.warn('âŒ Bank account section not found');
            return;
        }
        
        if (!window.paymentData || !window.paymentData.bank_details) {
            console.warn('âŒ Payment data or bank details not available');
            return;
        }
        
        const bankDetails = window.paymentData.bank_details;
        
        if (methodId === 'bank_transfer') {
            // Show bank account details
            bankAccountSection.innerHTML = `
                <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 12px; border: 1px solid #10b981;">
                    <h4 style="color: #10b981; margin-bottom: 15px; display: flex; align-items: center;">
                        <i class="fas fa-university" style="margin-right: 10px;"></i>
                        Bank Account Details
                    </h4>
                    <div style="grid-template-columns: 1fr 1fr; gap: 15px; display: grid;">
                        <div>
                            <div style="color: #d1d5db; font-size: 0.9em; margin-bottom: 5px;">Bank Name:</div>
                            <div style="color: #f9fafb; font-weight: bold; font-size: 1.1em;">${bankDetails.bank_name}</div>
                        </div>
                        <div>
                            <div style="color: #d1d5db; font-size: 0.9em; margin-bottom: 5px;">Account Name:</div>
                            <div style="color: #f9fafb; font-weight: bold; font-size: 1.1em;">${bankDetails.account_name}</div>
                        </div>
                        <div>
                            <div style="color: #d1d5db; font-size: 0.9em; margin-bottom: 5px;">Account Number:</div>
                            <div style="color: #10b981; font-weight: bold; font-size: 1.2em; font-family: monospace; letter-spacing: 1px;">${bankDetails.account_number}</div>
                        </div>
                        ${bankDetails.routing_number ? `
                        <div>
                            <div style="color: #d1d5db; font-size: 0.9em; margin-bottom: 5px;">Routing Number:</div>
                            <div style="color: #f9fafb; font-weight: bold; font-size: 1.1em;">${bankDetails.routing_number}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            console.log('âœ… Bank transfer details updated');
        } else if (methodId === 'mobile_banking') {
            // Show mobile banking details
            bankAccountSection.innerHTML = `
                <div style="background: rgba(251, 146, 60, 0.1); padding: 20px; border-radius: 12px; border: 1px solid #f59e0b;">
                    <h4 style="color: #f59e0b; margin-bottom: 15px; display: flex; align-items: center;">
                        <i class="fas fa-mobile-alt" style="margin-right: 10px;"></i>
                        Mobile Banking Details
                    </h4>
                    <div style="grid-template-columns: 1fr 1fr; gap: 15px; display: grid;">
                        <div>
                            <div style="color: #d1d5db; font-size: 0.9em; margin-bottom: 5px;">Service:</div>
                            <div style="color: #f9fafb; font-weight: bold; font-size: 1.1em;">${bankDetails.mobile_banking_type}</div>
                        </div>
                        <div>
                            <div style="color: #d1d5db; font-size: 0.9em; margin-bottom: 5px;">Account Name:</div>
                            <div style="color: #f9fafb; font-weight: bold; font-size: 1.1em;">${bankDetails.account_name}</div>
                        </div>
                        <div style="grid-column: 1 / -1;">
                            <div style="color: #d1d5db; font-size: 0.9em; margin-bottom: 5px;">Mobile Number:</div>
                            <div style="color: #f59e0b; font-weight: bold; font-size: 1.2em; font-family: monospace; letter-spacing: 1px;">${bankDetails.mobile_banking_number}</div>
                        </div>
                    </div>
                </div>
            `;
            console.log('âœ… Mobile banking details updated');
        }
    };
    
    // Function to update booking state type based on selections
    window.updateBookingStateType = function() {
        if (!window.bookingState) return;
        
        const hasMembershipPass = window.bookingState.selectedMembershipPass !== null && window.bookingState.selectedMembershipPass !== undefined;
        const hasSlots = (window.bookingState.selectedSlots && window.bookingState.selectedSlots.length > 0) || window.bookingState.customSlot !== null;
        
        if (hasMembershipPass) {
            window.bookingState.type = 'membership';
            console.log('ðŸŽ« Booking type set to: membership');
        } else if (hasSlots) {
            window.bookingState.type = 'slots';
            console.log('â° Booking type set to: slots');
        } else {
            window.bookingState.type = 'unknown';
            console.log('â“ Booking type: unknown');
        }
    };
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    console.log('âœ… API payment page displayed successfully');
    
    // Reset the submit button since payment page is now displayed
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        submitBtn.innerHTML = '<i class="fas fa-credit-card"></i> Proceed to Payment';
        submitBtn.disabled = false;
        submitBtn.style.display = 'none'; // Hide it since we're now on payment page
    }
    
    } catch (error) {
        console.error('âŒ Error in showAPIPaymentPage:', error);
        alert('Failed to display payment page: ' + error.message);
        
        // Reset the submit button
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-credit-card"></i> Proceed to Payment';
            submitBtn.disabled = false;
        }
    }
}

// EMERGENCY FINALIZE BOOKING FUNCTION
function finalizeBooking() {
    console.log('ðŸŽ¯ Finalizing booking...');
    
    const selectedPayment = document.querySelector('[name="payment_method"]:checked');
    if (!selectedPayment) {
        alert('Please select a payment method');
        return;
    }
    
    // Add payment method to form data
    window.bookingFormData.set('payment_method', selectedPayment.value);
    
    // Create the booking
    fetch(`/bookings/create/${PLAYGROUND_ID}/`, {
        method: 'POST',
        body: window.bookingFormData,
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('âœ… Booking created successfully!');
            window.location.href = data.redirect_url || '/';
        } else {
            alert('âŒ Error: ' + (data.error || 'Failed to create booking'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('âŒ An error occurred. Please try again.');
    });
}

// API Payment functions
function selectPaymentMethod(methodId, element) {
    // Handle both API payment methods (with element) and static ones (without element)
    if (element) {
        // API-generated payment methods
        document.querySelectorAll('#paymentMethodsContainer label').forEach(label => {
            label.style.borderColor = '#e5e7eb';
            label.style.background = 'white';
        });
        
        element.style.borderColor = '#10b981';
        element.style.background = '#f0f9ff';
    } else {
        // Static payment methods - fallback handling
        document.querySelectorAll('.payment-method').forEach(el => {
            el.classList.remove('selected');
        });
        
        const targetElement = document.querySelector(`input[value="${methodId}"]`);
        if (targetElement) {
            targetElement.checked = true;
            const paymentMethodDiv = targetElement.closest('.payment-method');
            if (paymentMethodDiv) {
                paymentMethodDiv.classList.add('selected');
            }
        }
    }
    
    console.log('ðŸ’³ Selected payment method:', methodId);
}

function goBackToBooking() {
    console.log('ðŸ”™ Going back to booking form...');
    
    // Reload the page to restore the original checkout form
    window.location.reload();
}

function confirmPaymentAndBooking() {
    console.log('ðŸŽ¯ Confirming payment and creating booking...');
    
    // Update booking state type before validation
    window.updateBookingStateType();
    
    const selectedPayment = document.querySelector('[name="final_payment_method"]:checked');
    if (!selectedPayment) {
        alert('âš ï¸ Please select a payment method');
        return;
    }
    
    // Show loading state
    const confirmBtn = document.querySelector('[onclick="confirmPaymentAndBooking()"]');
    const originalText = confirmBtn.innerHTML;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Booking...';
    confirmBtn.disabled = true;
    
    // Prepare booking data
    const bookingData = {
        playground_id: PLAYGROUND_ID,
        booking_date: window.bookingState.selectedDate,
        number_of_players: window.bookingFormData?.get('number_of_players') || 1,
        total_amount: window.bookingState.totalAmount,
        payment_method: selectedPayment.value
    };
    
    // Determine booking type and add appropriate data
    const hasMembershipPass = window.bookingState.selectedMembershipPass !== null && window.bookingState.selectedMembershipPass !== undefined;
    const hasRegularSlots = window.bookingState.selectedSlots && window.bookingState.selectedSlots.length > 0;
    const hasCustomSlot = window.bookingState.customSlot !== null;
    
    if (hasMembershipPass) {
        // Membership pass booking - use unique time slots to avoid conflicts 
        bookingData.booking_type = 'membership_pass';
        bookingData.membership_pass_id = window.bookingState.selectedMembershipPass.id;
        
        // For membership passes, use current timestamp to create unique times
        // This prevents conflicts with regular slots and custom slots
        const now = new Date();
        const uniqueMinutes = (now.getSeconds() + 30) % 60; // Offset from custom slots
        // Use dynamic hours based on playground configuration or system defaults
        const membershipStartHour = window.bookingState?.playgroundData?.configuration?.membership_pass_hour || 22;  // Dynamic membership pass hour
        const membershipEndHour = membershipStartHour;    
        
        bookingData.start_time = `${membershipStartHour}:${uniqueMinutes.toString().padStart(2, '0')}`;
        bookingData.end_time = `${membershipEndHour}:${(uniqueMinutes + 1).toString().padStart(2, '0')}`;
        
        // Store membership pass info for reference
        bookingData.membership_pass_name = window.bookingState.selectedMembershipPass.name;
        bookingData.pass_duration_days = window.bookingState.selectedMembershipPass.duration_days;
        bookingData.pass_duration_type = window.bookingState.selectedMembershipPass.duration_type;
        bookingData.membership_pass_duration = window.bookingState.selectedMembershipPass.duration_days || 1;
        
        // Override duration for membership passes to be proper duration  
        bookingData.duration_hours = window.bookingState.selectedMembershipPass.duration_days || 1;
        
        // Add additional fields that backend might expect for membership passes
        bookingData.selected_membership_pass = JSON.stringify(window.bookingState.selectedMembershipPass);
        bookingData.is_membership_pass = true;
        
        console.log('ðŸŽ« Membership pass using unique time:', bookingData.start_time, 'to', bookingData.end_time, '(pass:', bookingData.membership_pass_name, ')');
        
    } else if (hasCustomSlot) {
        // Custom slot booking - use unique time slots to avoid conflicts
        bookingData.booking_type = 'custom_slot';
        bookingData.custom_slot_id = window.bookingState.customSlot.id;
        
        // For custom slots, use current timestamp in seconds to create unique times
        // This prevents conflicts with regular slots
        const now = new Date();
        const uniqueMinutes = now.getSeconds(); // Use seconds as unique minutes (0-59)
        // Use dynamic hours based on playground configuration or system defaults
        const customStartHour = window.bookingState?.playgroundData?.configuration?.custom_slot_hour || 23;  // Dynamic custom slot hour
        const customEndHour = customStartHour;    // Same hour, different minutes
        
        bookingData.start_time = `${customStartHour}:${uniqueMinutes.toString().padStart(2, '0')}`;
        bookingData.end_time = `${customEndHour}:${(uniqueMinutes + 1).toString().padStart(2, '0')}`;
        
        // Store the actual custom slot time for reference
        const actualTimeString = window.bookingState.customSlot.time || '19:00 - 21:00';
        bookingData.custom_slot_actual_time = actualTimeString;
        bookingData.custom_slot_name = window.bookingState.customSlot.name || 'Custom Slot';
        
        // Override duration for custom slots to be proper duration
        bookingData.duration_hours = window.bookingState.customSlot.duration_hours || 2;
        bookingData.custom_slot_duration = window.bookingState.customSlot.duration_hours || 2;
        
        console.log('ðŸŒŸ Custom slot using unique time:', bookingData.start_time, 'to', bookingData.end_time, '(actual:', actualTimeString, ')');
        
        // Add additional fields that backend might expect for custom slots
        bookingData.selected_custom_slot = JSON.stringify(window.bookingState.customSlot);
        bookingData.is_custom_slot = true;
        
        console.log('ðŸŒŸ Custom slot booking:', actualTimeString, '=>', bookingData.start_time, 'to', bookingData.end_time);
        
    } else if (hasRegularSlots) {
        // Regular slot booking
        bookingData.booking_type = 'regular_slot';  // Be more specific
        
        // Use regular slot times
        const rawStartTime = window.bookingState.selectedSlots[0]?.start_time || '11:30';
        const rawEndTime = window.bookingState.selectedSlots[window.bookingState.selectedSlots.length - 1]?.end_time || '12:30';
        
        bookingData.start_time = convertTo24Hour(rawStartTime);
        bookingData.end_time = convertTo24Hour(rawEndTime);
        
        // Add selected slot IDs for regular slots
        bookingData.slot_ids = window.bookingState.selectedSlots.map(slot => slot.id);
        bookingData.selected_slots = JSON.stringify(window.bookingState.selectedSlots);
        
        console.log('â° Regular slot booking from:', rawStartTime, '=>', bookingData.start_time, 'to:', rawEndTime, '=>', bookingData.end_time);
        
    } else {
        alert('âš ï¸ Invalid booking data - please select time slots, custom slots, or membership pass');
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
        return;
    }
    
    // Add selected amenities if any
    if (window.bookingState.selectedAmenities && window.bookingState.selectedAmenities.length > 0) {
        bookingData.amenities = window.bookingState.selectedAmenities.map(a => a.id);
        bookingData.selected_amenities = window.bookingState.selectedAmenities; // Full amenity objects for backend
        console.log('ðŸŽ¯ Amenities included:', window.bookingState.selectedAmenities.length);
    }
    
    // Handle receipt upload for bank transfers
    const isFormData = (selectedPayment.value === 'bank_transfer' || selectedPayment.value === 'mobile_banking') && window.selectedReceiptFile;
    
    let requestBody;
    let requestHeaders;
    
    if (isFormData) {
        // Use FormData for file upload
        const formData = new FormData();
        Object.keys(bookingData).forEach(key => {
            formData.append(key, bookingData[key]);
        });
        formData.append('receipt', window.selectedReceiptFile);
        
        requestBody = formData;
        requestHeaders = {
            'X-CSRFToken': window.savedCSRFToken || getCsrfToken()
        };
        
        console.log('ðŸ“¸ Including receipt file:', window.selectedReceiptFile.name);
    } else {
        // Use JSON for regular payment
        requestBody = JSON.stringify(bookingData);
        requestHeaders = {
            'Content-Type': 'application/json',
            'X-CSRFToken': window.savedCSRFToken || getCsrfToken()
        };
        
        // Validate receipt requirement for bank transfers
        if (selectedPayment.value === 'bank_transfer' || selectedPayment.value === 'mobile_banking') {
            alert('âš ï¸ Please upload payment receipt for bank transfer');
            confirmBtn.innerHTML = originalText;
            confirmBtn.disabled = false;
            return;
        }
    }
    
    console.log('ðŸ“ Booking data components:');
    console.log('  ðŸŸï¸ playground_id:', PLAYGROUND_ID);
    console.log('  ðŸ“… booking_date:', window.bookingState.selectedDate);
    console.log('  ðŸŽ¯ booking_type:', bookingData.booking_type);
    console.log('  ðŸ• start_time:', bookingData.start_time);
    console.log('  ðŸ•‘ end_time:', bookingData.end_time);
    console.log('  ðŸ‘¥ number_of_players:', window.bookingFormData?.get('number_of_players'));
    console.log('  ðŸ’° total_amount:', window.bookingState.totalAmount);
    console.log('  ðŸ’³ payment_method:', selectedPayment.value);
    
    if (bookingData.booking_type === 'membership') {
        console.log('  ðŸŽ« membership_pass_id:', bookingData.membership_pass_id);
    } else if (bookingData.booking_type === 'custom') {
        console.log('  ðŸŒŸ custom_slot_id:', bookingData.custom_slot_id);
    } else if (bookingData.booking_type === 'regular') {
        console.log('  â° slot_ids:', bookingData.slot_ids);
    }
    
    console.log('ðŸ“ Complete booking data:', bookingData);
    console.log('ðŸ” Booking state debug:', {
        selectedSlots: window.bookingState.selectedSlots,
        customSlot: window.bookingState.customSlot,
        selectedMembershipPass: window.bookingState.selectedMembershipPass,
        type: window.bookingState.type,
        currentSlotType: window.currentSlotType
    });

    // Add fallback compatibility for backends that don't support booking types
    // This forces all bookings to include basic slot information
    if (hasCustomSlot && window.bookingState.customSlot) {
        // Try to create a "fake" slot structure for custom slots
        bookingData.slot_id = -1;  // Use negative ID to indicate custom
        bookingData.is_custom_booking = true;
        bookingData.custom_booking_name = window.bookingState.customSlot.name || 'Custom Slot';
        bookingData.custom_booking_price = window.bookingState.customSlot.price || 0;
        bookingData.slot_type = 'custom';
        
        // Also try common field names backends might expect
        bookingData.time_slot_type = 'custom_slot';
        bookingData.duration_based = false;
        bookingData.custom_time_slot = true;
    } else if (hasMembershipPass && window.bookingState.selectedMembershipPass) {
        // Try to create a "fake" slot structure for membership passes
        bookingData.slot_id = -2;  // Use negative ID to indicate membership
        bookingData.is_membership_booking = true;
        bookingData.membership_booking_name = window.bookingState.selectedMembershipPass.name || 'Membership Pass';
        bookingData.membership_booking_price = window.bookingState.selectedMembershipPass.price || 0;
        bookingData.slot_type = 'membership';
        
        // Also try common field names backends might expect
        bookingData.time_slot_type = 'membership_pass';
        bookingData.duration_based = true;
        bookingData.membership_booking = true;
    } else if (hasRegularSlots && window.bookingState.selectedSlots?.length > 0) {
        bookingData.slot_id = window.bookingState.selectedSlots[0]?.id || 1;
        bookingData.is_regular_booking = true;
        bookingData.slot_type = 'regular';
        
        // Also try common field names backends might expect
        bookingData.time_slot_type = 'regular_slot';
        bookingData.duration_based = false;
        bookingData.regular_booking = true;
    }

    console.log('ðŸŽ¯ Final booking data with fallback compatibility:', JSON.stringify(bookingData, null, 2));

    const csrfTokenToUse = window.savedCSRFToken || getCsrfToken();
    console.log('ðŸ” CSRF token to use:', csrfTokenToUse ? csrfTokenToUse.substring(0, 10) + '...' : 'NOT FOUND');
    
    // Create booking via API
    fetch('/bookings/api/create-booking/', {
        method: 'POST',
        headers: requestHeaders,
        body: requestBody
    })
    .then(response => {
        console.log('ï¿½ Booking API response status:', response.status);
        
        // Handle different response types
        if (response.headers.get('content-type')?.includes('application/json')) {
            return response.json();
        } else {
            // If it's HTML, it might be an error page
            return response.text().then(text => {
                console.warn('âš ï¸ Received HTML instead of JSON:', text.substring(0, 200));
                throw new Error('Server returned HTML instead of JSON. Please check your authentication.');
            });
        }
    })
    .then(data => {
        console.log('âœ… Booking API response:', data);
        
        if (data.success) {
            // Update slot status to show as booked
            updateSlotStatusAfterBooking();
            
            // Show success animation and stay on page
            showBookingSuccess(data);
        } else {
            throw new Error(data.error || 'Booking creation failed');
        }
    })
    .catch(error => {
        console.error('âŒ Booking creation error:', error);
        
        // Reset button
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
        
        // Show user-friendly error
        showBookingError(error.message);
    });
}

// Helper functions for dynamic booking success data
function getDynamicDuration(bookingDetails) {
    // Check for membership pass duration
    if (window.bookingState?.selectedMembershipPass) {
        const pass = window.bookingState.selectedMembershipPass;
        return `${pass.duration_days} days (${pass.duration_type})`;
    }
    
    // Check for custom slot duration
    if (window.bookingState?.customSlot) {
        const slot = window.bookingState.customSlot;
        return `${slot.duration_hours || 2} hour(s)`;
    }
    
    // Regular slot duration from backend or calculate
    if (bookingDetails.duration_hours) {
        return `${bookingDetails.duration_hours} hour(s)`;
    }
    
    // Calculate from start and end time
    if (bookingDetails.start_time && bookingDetails.end_time) {
        const start = new Date(`2000-01-01 ${bookingDetails.start_time}`);
        const end = new Date(`2000-01-01 ${bookingDetails.end_time}`);
        const hours = (end - start) / (1000 * 60 * 60);
        return `${hours} hour(s)`;
    }
    
    return '1 hour(s)'; // fallback
}

function getBookingTypeIcon(bookingDetails) {
    if (window.bookingState?.selectedMembershipPass) return 'fas fa-id-card';
    if (window.bookingState?.customSlot) return 'fas fa-cog';
    return 'fas fa-calendar-check';
}

    function getBookingTypeName(bookingDetails) {
        if (window.bookingState?.selectedMembershipPass) {
            return `Membership Pass - ${window.bookingState.selectedMembershipPass.name}`;
        }
        if (window.bookingState?.customSlot) {
            return `Custom Slot - ${window.bookingState.customSlot.time || 'Custom Time'}`;
        }
        return 'Regular Time Slot';
    }function getSlotDetailsSection(bookingDetails) {
    let slotInfo = '';
    
    if (window.bookingState?.selectedMembershipPass) {
        const pass = window.bookingState.selectedMembershipPass;
        const passName = pass?.name || 'Membership Pass';
        const maxCapacity = pass?.max_capacity || 'Unlimited';
        slotInfo = `
            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
                <div style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">Pass Details</div>
                <div style="color: var(--text-primary); font-weight: 700; font-size: 1.2rem;">
                    <i class="fas fa-star" style="color: var(--accent-color); margin-right: 8px;"></i>
                    ${passName}<br>
                    <small style="font-size: 0.9rem; color: var(--text-light);">Max ${maxCapacity} people</small>
                </div>
            </div>
        `;
    } else if (window.bookingState?.customSlot) {
        const slot = window.bookingState.customSlot;
        const slotName = slot?.name || slot?.slot_type || 'Custom Slot';
        const maxCapacity = slot?.max_capacity || slot?.capacity || 8;
        const slotTime = slot?.time || (slot?.start_time_24h && slot?.end_time_24h ? `${slot.start_time_24h}-${slot.end_time_24h}` : '');
        slotInfo = `
            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
                <div style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">Slot Details</div>
                <div style="color: var(--text-primary); font-weight: 700; font-size: 1.2rem;">
                    <i class="fas fa-cog" style="color: var(--accent-color); margin-right: 8px;"></i>
                    ${slotName}${slotTime ? ` (${slotTime})` : ''}<br>
                    <small style="font-size: 0.9rem; color: var(--text-light);">Max ${maxCapacity} people</small>
                </div>
            </div>
        `;
    }
    
    return slotInfo;
}

function getAmenitiesSection(bookingDetails) {
    const selectedAmenities = window.bookingState?.selectedAmenities || [];
    if (selectedAmenities.length === 0) return '';
    
    const amenitiesList = selectedAmenities.map(amenity => `
        <li style="padding: 8px 0; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between;">
            <span>${amenity.name}</span>
            <span style="font-weight: 600; color: var(--primary-color);">MYR ${amenity.price}</span>
        </li>
    `).join('');
    
    return `
        <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); grid-column: 1 / -1;">
            <div style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">Selected Amenities</div>
            <ul style="list-style: none; padding: 0; margin: 0;">
                ${amenitiesList}
            </ul>
        </div>
    `;
}

function showBookingSuccess(data) {
    console.log('ðŸŽ‰ Showing booking success...');
    
    // Hide the main checkout container to show success content
    const checkoutContainer = document.querySelector('.checkout-container');
    const mainContainer = document.querySelector('.main-content') || document.querySelector('.container');
    
    if (checkoutContainer) {
        checkoutContainer.style.display = 'none';
    }
    
    // Create success content container that respects existing nav/footer
    const successContainer = document.createElement('div');
    successContainer.className = 'success-container';
    successContainer.style.cssText = `
        max-width: 1400px;
        margin: 2rem auto;
        padding: 2rem 1rem;
        background: var(--bg-secondary);
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        animation: successFadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    `;
    
    const bookingDetails = data.booking;
    const paymentStatusMessage = getPaymentStatusMessage(bookingDetails.payment_status, bookingDetails.payment_method);
    
    successContainer.innerHTML = `
        <!-- Success Header with Gradient Background -->
        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%); padding: 60px 40px; border-radius: 20px; text-align: center; margin-bottom: 40px; position: relative; overflow: hidden;">
            <!-- Background Pattern -->
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url('data:image/svg+xml,<svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><g fill="%23ffffff" fill-opacity="0.05"><circle cx="30" cy="30" r="1"/></g></svg>'); opacity: 0.3;"></div>
            
            <!-- Success Icon -->
            <div style="position: relative; z-index: 2;">
                <div style="display: inline-flex; align-items: center; justify-content: center; width: 120px; height: 120px; background: rgba(255, 255, 255, 0.15); border-radius: 50%; margin-bottom: 30px; backdrop-filter: blur(10px); border: 2px solid rgba(255, 255, 255, 0.2); animation: successPulse 2s infinite;">
                    <i class="fas fa-check" style="font-size: 50px; color: white; animation: successCheckmark 0.8s ease-out 0.3s both;"></i>
                </div>
                
                <h1 style="color: white; font-size: 3rem; font-weight: 800; margin-bottom: 20px; text-shadow: 0 4px 20px rgba(0,0,0,0.3); letter-spacing: -0.02em;">
                    ðŸŽ‰ Booking Confirmed!
                </h1>
                
                <p style="color: rgba(255, 255, 255, 0.9); font-size: 1.3rem; line-height: 1.6; max-width: 600px; margin: 0 auto; text-shadow: 0 2px 10px rgba(0,0,0,0.2);">
                    Thank you for choosing <strong style="color: #fbbf24;">${bookingDetails.playground_name}</strong><br>
                    Your reservation is confirmed and ready!
                </p>
            </div>
        </div>

        <!-- Main Content Cards -->
        <div style="display: grid; grid-template-columns: 1fr 400px; gap: 40px; margin-bottom: 40px;">
            
            <!-- Booking Details Card -->
            <div style="background: var(--card-bg); border-radius: 20px; padding: 40px; border: 1px solid var(--border-color); position: relative; overflow: hidden;">
                <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color));"></div>
                
                <h2 style="color: var(--text-primary); font-size: 1.8rem; font-weight: 700; margin-bottom: 30px; display: flex; align-items: center; gap: 12px;">
                    <i class="fas fa-clipboard-list" style="color: var(--primary-color);"></i>
                    Booking Details
                </h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
                        <div style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">Booking ID</div>
                        <div style="color: var(--primary-color); font-weight: 800; font-size: 1.4rem; font-family: 'Courier New', monospace; background: rgba(16, 185, 129, 0.1); padding: 8px 12px; border-radius: 8px; display: inline-block;">
                            #${bookingDetails.booking_id || bookingDetails.id}
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
                        <div style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">Date & Time</div>
                        <div style="color: var(--text-primary); font-weight: 700; font-size: 1.2rem;">
                            <i class="fas fa-calendar-alt" style="color: var(--secondary-color); margin-right: 8px;"></i>
                            ${formatDateTime(bookingDetails.date, bookingDetails.start_time)}
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
                        <div style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">Duration</div>
                        <div style="color: var(--text-primary); font-weight: 700; font-size: 1.2rem;">
                            <i class="fas fa-clock" style="color: var(--accent-color); margin-right: 8px;"></i>
                            ${getDynamicDuration(bookingDetails)}
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
                        <div style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">Players</div>
                        <div style="color: var(--text-primary); font-weight: 700; font-size: 1.2rem;">
                            <i class="fas fa-users" style="color: var(--secondary-color); margin-right: 8px;"></i>
                            ${bookingDetails.number_of_players} player(s)
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
                        <div style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">Booking Type</div>
                        <div style="color: var(--text-primary); font-weight: 700; font-size: 1.2rem;">
                            <i class="${getBookingTypeIcon(bookingDetails)}" style="color: var(--primary-color); margin-right: 8px;"></i>
                            ${getBookingTypeName(bookingDetails)}
                        </div>
                    </div>
                    
                    ${getSlotDetailsSection(bookingDetails)}
                    
                    ${getAmenitiesSection(bookingDetails)}
                </div>
                
                <!-- Total Amount Highlight -->
                <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.15) 100%); padding: 25px; border-radius: 15px; border: 1px solid rgba(16, 185, 129, 0.3); text-align: center; margin-bottom: 25px;">
                    <div style="color: var(--text-light); font-size: 1rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 500;">Total Amount Paid</div>
                    <div style="color: var(--primary-color); font-weight: 900; font-size: 2.5rem; text-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);">
                        MYR ${parseFloat(bookingDetails.amount).toFixed(2)}
                    </div>
                </div>
                
                <!-- Payment Status -->
                <div style="padding: 20px; background: ${paymentStatusMessage.color}; border-radius: 12px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                    <div style="color: white; font-weight: 700; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <i class="${paymentStatusMessage.icon}" style="font-size: 1.4rem;"></i>
                        ${paymentStatusMessage.message}
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions Sidebar -->
            <div style="display: flex; flex-direction: column; gap: 20px;">
                
                <!-- Primary Actions -->
                <div style="background: var(--card-bg); border-radius: 16px; padding: 30px; border: 1px solid var(--border-color);">
                    <h3 style="color: var(--text-primary); font-size: 1.3rem; font-weight: 700; margin-bottom: 25px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-rocket" style="color: var(--primary-color);"></i>
                        Quick Actions
                    </h3>
                    
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <button onclick="navigateToBookingDetail('${data.booking_detail_url || `/bookings/${bookingDetails.id}/`}')" 
                                style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%); 
                                       color: white; padding: 16px 24px; border: none; border-radius: 12px; 
                                       font-size: 1.1rem; font-weight: 600; cursor: pointer; 
                                       transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
                                       box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
                                       display: flex; align-items: center; justify-content: center; gap: 10px;"
                                onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 30px rgba(16, 185, 129, 0.4)'"
                                onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 20px rgba(16, 185, 129, 0.3)'">
                            <i class="fas fa-eye"></i>
                            View Booking Details
                        </button>
                        
                        <button onclick="navigateToBookingDashboard('${data.booking_dashboard_url || '/bookings/'}')" 
                                style="background: linear-gradient(135deg, var(--secondary-color) 0%, var(--secondary-hover) 100%); 
                                       color: white; padding: 16px 24px; border: none; border-radius: 12px; 
                                       font-size: 1.1rem; font-weight: 600; cursor: pointer; 
                                       transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
                                       box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
                                       display: flex; align-items: center; justify-content: center; gap: 10px;"
                                onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 30px rgba(59, 130, 246, 0.4)'"
                                onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 20px rgba(59, 130, 246, 0.3)'">
                            <i class="fas fa-list-alt"></i>
                            My Bookings
                        </button>
                        
                        <button onclick="window.location.href='/'" 
                                style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); 
                                       color: white; padding: 16px 24px; border: none; border-radius: 12px; 
                                       font-size: 1.1rem; font-weight: 600; cursor: pointer; 
                                       transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
                                       box-shadow: 0 4px 20px rgba(107, 114, 128, 0.3);
                                       display: flex; align-items: center; justify-content: center; gap: 10px;"
                                onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 30px rgba(107, 114, 128, 0.4)'"
                                onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 20px rgba(107, 114, 128, 0.3)'">
                            <i class="fas fa-home"></i>
                            Back to Home
                        </button>
                    </div>
                </div>
                
                <!-- What's Next Guide -->
                <div style="background: var(--card-bg); border-radius: 16px; padding: 30px; border: 1px solid var(--border-color);">
                    <h3 style="color: var(--text-primary); font-size: 1.3rem; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-lightbulb" style="color: var(--accent-color);"></i>
                        What's Next?
                    </h3>
                    
                    <div style="space-y: 15px;">
                        <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 15px;">
                            <div style="width: 8px; height: 8px; background: var(--primary-color); border-radius: 50%; margin-top: 8px; flex-shrink: 0;"></div>
                            <p style="color: var(--text-secondary); line-height: 1.6; margin: 0;">You'll receive a confirmation email with all booking details</p>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 15px;">
                            <div style="width: 8px; height: 8px; background: var(--primary-color); border-radius: 50%; margin-top: 8px; flex-shrink: 0;"></div>
                            <p style="color: var(--text-secondary); line-height: 1.6; margin: 0;">Please arrive 10 minutes before your scheduled time</p>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 15px;">
                            <div style="width: 8px; height: 8px; background: var(--primary-color); border-radius: 50%; margin-top: 8px; flex-shrink: 0;"></div>
                            <p style="color: var(--text-secondary); line-height: 1.6; margin: 0;">Bring a valid ID and any required equipment</p>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 0;">
                            <div style="width: 8px; height: 8px; background: var(--primary-color); border-radius: 50%; margin-top: 8px; flex-shrink: 0;"></div>
                            <p style="color: var(--text-secondary); line-height: 1.6; margin: 0;">Contact the playground if you need to make changes</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success Notice -->
        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); padding: 20px; border-radius: 12px; text-align: center; margin-top: 30px;">
            <p style="color: var(--text-secondary); margin: 0; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <i class="fas fa-check-circle" style="color: var(--primary-color);"></i>
                Your booking has been successfully created! Use the buttons above to navigate to your booking details or dashboard.
            </p>
        </div>
    `;
    
    // Add enhanced animations
    const successStyle = document.createElement('style');
    successStyle.textContent = `
        @keyframes successFadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes successPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes successCheckmark {
            from { 
                opacity: 0; 
                transform: scale(0) rotate(-45deg); 
            }
            to { 
                opacity: 1; 
                transform: scale(1) rotate(0deg); 
            }
        }
        
        .success-container {
            animation: successFadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @media (max-width: 1024px) {
            .success-container [style*="grid-template-columns: 1fr 400px"] {
                grid-template-columns: 1fr !important;
            }
        }
        
        @media (max-width: 768px) {
            .success-container [style*="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr))"] {
                grid-template-columns: 1fr !important;
            }
        }
    `;
    document.head.appendChild(successStyle);
    
    // Insert the success container after the checkout container
    if (checkoutContainer && checkoutContainer.parentElement) {
        checkoutContainer.parentElement.insertBefore(successContainer, checkoutContainer.nextSibling);
    } else if (mainContainer) {
        mainContainer.appendChild(successContainer);
    } else {
        document.body.appendChild(successContainer);
    }
    
    // Scroll to top to show success content
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // No auto-redirect - user stays on current page with success modal
}

function getPaymentStatusMessage(paymentStatus, paymentMethod) {
    const statusMessages = {
        'confirmed': {
            color: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
            icon: 'fas fa-check-circle',
            message: 'Payment Confirmed - Booking is Active'
        },
        'pending_cash': {
            color: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
            icon: 'fas fa-clock',
            message: 'Pay at Venue - Please bring exact amount'
        },
        'receipt_uploaded': {
            color: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
            icon: 'fas fa-upload',
            message: 'Receipt Uploaded - Under Verification'
        },
        'pending': {
            color: 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)',
            icon: 'fas fa-hourglass-half',
            message: 'Payment Pending - Please Complete Payment'
        }
    };
    
    return statusMessages[paymentStatus] || statusMessages['pending'];
}

function formatDateTime(date, time) {
    const dateObj = new Date(date);
    const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    };
    return `${dateObj.toLocaleDateString('en-US', options)} at ${time}`;
}

function showBookingError(message) {
    console.log('âŒ Showing booking error:', message);
    
    // Create error modal
    const errorModal = document.createElement('div');
    errorModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease-in;
    `;
    
    errorModal.innerHTML = `
        <div style="background: white; padding: 40px; border-radius: 15px; text-align: center; max-width: 400px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
            <div style="color: #ef4444; font-size: 60px; margin-bottom: 20px;">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 style="color: #1f2937; margin-bottom: 15px;">Booking Failed</h3>
            <p style="color: #6b7280; margin-bottom: 25px;">${message}</p>
            <button onclick="this.parentElement.parentElement.remove()" style="background: #ef4444; color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    `;
    
    document.body.appendChild(errorModal);
    
    // Auto-remove after 8 seconds
    setTimeout(() => {
        if (errorModal.parentElement) {
            errorModal.remove();
        }
    }, 8000);
}

function validateBookingForm() {
    console.log('ðŸ” Validating booking form...');
    console.log('ðŸ“Š Current booking state:', bookingState);
    
    // Check if slots are selected
    const hasSlots = bookingState.selectedSlots && bookingState.selectedSlots.length > 0;
    const hasCustomSlot = bookingState.customSlot !== null;
    const hasMembershipPass = bookingState.selectedMembershipPass !== null;
    
    console.log('ðŸ“‹ Selection status:', { hasSlots, hasCustomSlot, hasMembershipPass });
    
    if (!hasSlots && !hasCustomSlot && !hasMembershipPass) {
        alert('Please select at least one time slot.');
        return false;
    }
    
    // Check required fields
    const requiredFields = ['first_name', 'last_name', 'email', 'phone_number', 'number_of_players'];
    for (let field of requiredFields) {
        const element = document.querySelector(`[name="${field}"]`);
        if (!element) {
            console.error(`âŒ Required field element not found: ${field}`);
            alert(`Form field missing: ${field.replace('_', ' ')}`);
            return false;
        }
        
        if (!element.value || !element.value.trim()) {
            console.log(`âŒ Required field empty: ${field}`);
            alert(`Please fill in the ${field.replace('_', ' ')} field.`);
            element.focus();
            return false;
        }
    }
    
    // Check terms
    const terms = document.getElementById('terms');
    if (!terms) {
        console.error('âŒ Terms checkbox not found');
        alert('Terms and conditions checkbox not found.');
        return false;
    }
    
    if (!terms.checked) {
        console.log('âŒ Terms not accepted');
        alert('Please accept the terms and conditions.');
        terms.focus();
        return false;
    }
    
    console.log('âœ… Form validation passed');
    return true;
}

function addSlotDataToForm(formData) {
    // Define slot status variables
    const hasRegularSlots = bookingState.selectedSlots && bookingState.selectedSlots.length > 0;
    const hasCustomSlot = bookingState.customSlot !== null;
    
    // Add dynamic slot data based on booking type
    if (bookingState.type === 'slots') {
        if (hasRegularSlots) {
            // For regular slots, get start and end times from slot objects
            const firstSlot = bookingState.selectedSlots[0];
            const lastSlot = bookingState.selectedSlots[bookingState.selectedSlots.length - 1];
            
            // Convert 12-hour format to 24-hour format
            const startTime24 = convertTo24Hour(firstSlot.start_time) || '09:00';
            const endTime24 = convertTo24Hour(lastSlot.end_time) || '10:00';
            
            formData.append('start_time', startTime24);
            formData.append('end_time', endTime24);
        } else if (hasCustomSlot) {
            // For custom slots, extract times from the time string
            const timeString = bookingState.customSlot.time || '09:00 - 10:00';
            const timeParts = timeString.split(' - ');
            
            const startTime24 = convertTo24Hour(timeParts[0]) || '09:00';
            const endTime24 = convertTo24Hour(timeParts[1]) || '10:00';
            
            formData.append('start_time', startTime24);
            formData.append('end_time', endTime24);
        } else {
            // Fallback times
            formData.append('start_time', '09:00');
            formData.append('end_time', '10:00');
        }
    } else if (bookingState.type === 'membership' && bookingState.selectedMembershipPass) {
        // For membership passes, set default time range
        formData.append('start_time', '09:00');
        formData.append('end_time', '21:00');
        formData.append('special_requests', `Membership Pass: ${bookingState.selectedMembershipPass.name}`);
    } else {
        // Default fallback times
        formData.append('start_time', '09:00');
        formData.append('end_time', '10:00');
    }
    
    // Add total amount
    formData.append('total_amount', bookingState.totalAmount.toFixed(2));
}

function showStep(stepNumber) {
    console.log(`ðŸ”„ Showing step ${stepNumber}`);
    
    try {
        // Update step indicator
        for (let i = 1; i <= 3; i++) {
            const step = document.getElementById(`step${i}`);
            if (!step) {
                console.error(`âŒ Step element not found: step${i}`);
                continue;
            }
            
            step.classList.remove('active', 'completed');
            
            if (i < stepNumber) {
                step.classList.add('completed');
            } else if (i === stepNumber) {
                step.classList.add('active');
            }
        }
        
        // Show/hide step content with FORCE VISIBLE approach
        const paymentContent = document.getElementById('paymentStepContent');
        const confirmationContent = document.getElementById('confirmationStepContent');
        
        if (!paymentContent || !confirmationContent) {
            console.error('âŒ Step content elements not found');
            console.error('paymentStepContent:', paymentContent);
            console.error('confirmationStepContent:', confirmationContent);
            return;
        }
        
        // Debug current visibility states
        console.log(`ðŸ” Before changing step ${stepNumber}:`);
        console.log(`paymentContent display: ${paymentContent.style.display}`);
        console.log(`confirmationContent display: ${confirmationContent.style.display}`);
        
        // FORCE RESET ALL CONTENT VISIBILITY
        paymentContent.style.display = 'none';
        paymentContent.style.visibility = 'hidden';
        confirmationContent.style.display = 'none';
        confirmationContent.style.visibility = 'hidden';
        
        // FORCE SHOW THE CORRECT STEP
        if (stepNumber === 2) {
            paymentContent.style.display = 'block';
            paymentContent.style.visibility = 'visible';
            paymentContent.style.opacity = '1';
            paymentContent.style.position = 'relative';
            paymentContent.style.zIndex = '1000';
            console.log('ðŸŽ¯ FORCING PAYMENT CONTENT VISIBLE');
        } else if (stepNumber === 3) {
            confirmationContent.style.display = 'block';
            confirmationContent.style.visibility = 'visible';
            confirmationContent.style.opacity = '1';
            confirmationContent.style.position = 'relative';
            confirmationContent.style.zIndex = '1000';
            console.log('ðŸŽ¯ FORCING CONFIRMATION CONTENT VISIBLE');
        }
        
        // Debug after visibility states
        console.log(`ðŸ” After changing step ${stepNumber}:`);
        console.log(`paymentContent display: ${paymentContent.style.display}`);
        console.log(`paymentContent visibility: ${paymentContent.style.visibility}`);
        console.log(`confirmationContent display: ${confirmationContent.style.display}`);
        console.log(`confirmationContent visibility: ${confirmationContent.style.visibility}`);
        
        console.log(`âœ… Step ${stepNumber} displayed successfully`);
        
    } catch (error) {
        console.error('âŒ Error in showStep:', error);
    }
}

function proceedToConfirmation() {
    const selectedMethod = document.querySelector('[name="final_payment_method"]:checked');
    
    if (!selectedMethod) {
        alert('Please select a payment method first!');
        return;
    }
    
    // Store selected payment method
    window.selectedPaymentMethod = selectedMethod.value;
    window.bookingFormData.append('payment_method', selectedMethod.value);
    
    // Populate confirmation details
    populateConfirmationDetails();
    
    // Show confirmation step
    showStep(3);
    
    console.log('âœ… Confirmation step displayed');
}

function backToBookingDetails() {
    // Show main form and hide multi-step container
    document.getElementById('multiStepContainer').style.display = 'none';
    document.querySelector('.container').style.display = 'block';
    
    // Re-enable submit button
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.innerHTML = '<i class="fas fa-credit-card"></i> Proceed to Payment';
    submitBtn.disabled = false;
}

function backToPayment() {
    showStep(2);
}

function finalConfirmBooking() {
    const confirmBtn = document.getElementById('finalConfirmBtn');
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Booking...';
    confirmBtn.disabled = true;
    
    console.log('ï¿½ Creating final booking...');
    
    // Debug: Log final form data
    console.log('ðŸ“‹ Final booking data:');
    for (let [key, value] of window.bookingFormData.entries()) {
        console.log(`  ${key}: ${value}`);
    }
    
    // Create booking via AJAX  
    const createBookingUrl = '/bookings/create/' + PLAYGROUND_ID + '/';
    console.log('ðŸš€ Submitting to URL:', createBookingUrl);
    
    fetch(createBookingUrl, {
        method: 'POST',
        body: window.bookingFormData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => {
        console.log('ðŸ“¡ Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            return response.text().then(text => {
                console.error('âŒ Response text:', text.substring(0, 500));
                throw new Error('Server returned HTML instead of JSON. Check server logs.');
            });
        }
        
        return response.json();
    })
    .then(data => {
        if (data.success) {
            console.log('âœ… Booking created successfully:', data.booking_id);
            
            // Update slot status to show as booked
            updateSlotStatusAfterBooking();
            
            // Reload custom slots and membership passes to reflect updated availability
            const selectedDate = document.getElementById('date-input')?.value;
            if (selectedDate) {
                loadCustomSlots();
                loadMembershipPasses();
            }
            
            // Show professional success message and stay on current page
            showProfessionalSuccessMessage(data.booking_id, window.selectedPaymentMethod);
            
            // No redirection - user stays on checkout page with success modal
        } else {
            console.error('âŒ Booking creation failed:', data.error);
            alert('Booking failed: ' + (data.error || 'Unknown error'));
            // Re-enable confirm button
            confirmBtn.innerHTML = '<i class="fas fa-check-circle"></i> Confirm & Complete Booking';
            confirmBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('âŒ Network error:', error);
        alert('Network error occurred. Please try again.');
        // Re-enable confirm button
        confirmBtn.innerHTML = '<i class="fas fa-check-circle"></i> Confirm & Complete Booking';
        confirmBtn.disabled = false;
    });
}

// UPDATE SLOT STATUS AFTER BOOKING
function updateSlotStatusAfterBooking() {
    console.log('ðŸ”„ Updating slot status after successful booking...');
    console.log('ðŸ” Current booking state:', {
        customSlot: window.bookingState.customSlot,
        selectedMembershipPass: window.bookingState.selectedMembershipPass,
        selectedSlots: window.bookingState.selectedSlots
    });
    
    // Update custom slot status
    if (window.bookingState.customSlot) {
        console.log('ðŸŒŸ Marking custom slot as booked:', window.bookingState.customSlot.id);
        
        // Find and update custom slot by multiple selectors
        let customSlotElement = document.querySelector(`[data-slot-id="${window.bookingState.customSlot.id}"]`);
        
        // Try alternative selectors if not found
        if (!customSlotElement) {
            customSlotElement = document.querySelector(`.premium-slot-card[onclick*="${window.bookingState.customSlot.id}"]`);
        }
        if (!customSlotElement) {
            customSlotElement = document.querySelector(`.professional-slot-item[onclick*="${window.bookingState.customSlot.id}"]`);
        }
        
        console.log('ðŸ” Custom slot element found:', !!customSlotElement, customSlotElement);
        
        if (customSlotElement) {
            // Mark as booked
            customSlotElement.classList.remove('selected');
            customSlotElement.classList.add('booked');
            customSlotElement.style.opacity = '0.7';
            customSlotElement.style.pointerEvents = 'none';
            customSlotElement.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
            customSlotElement.style.border = '2px solid #dc2626';
            customSlotElement.style.color = 'white';
            
            // Add booked indicator
            const bookedBadge = document.createElement('div');
            bookedBadge.innerHTML = '<i class="fas fa-check-circle"></i> BOOKED';
            bookedBadge.style.cssText = `
                position: absolute;
                top: 10px;
                right: 10px;
                background: rgba(255, 255, 255, 0.2);
                color: white;
                padding: 5px 10px;
                border-radius: 12px;
                font-size: 0.8rem;
                font-weight: 600;
                z-index: 10;
                backdrop-filter: blur(5px);
            `;
            customSlotElement.appendChild(bookedBadge);
            
            // Disable onclick
            customSlotElement.onclick = null;
            
            console.log('âœ… Custom slot marked as booked');
        } else {
            console.warn('âš ï¸ Custom slot element not found for ID:', window.bookingState.customSlot.id);
        }
    }
    
    // Update membership pass status
    if (window.bookingState.selectedMembershipPass) {
        console.log('ðŸŽ« Marking membership pass as booked:', window.bookingState.selectedMembershipPass.id);
        
        // Find and update membership pass by multiple selectors (use correct class names)
        let membershipElement = document.querySelector(`[data-pass-id="${window.bookingState.selectedMembershipPass.id}"]`);
        
        // Try with the correct class name used in real API loading
        if (!membershipElement) {
            membershipElement = document.querySelector(`.membership-pass[data-pass-id="${window.bookingState.selectedMembershipPass.id}"]`);
        }
        
        // Try alternative selectors
        if (!membershipElement) {
            membershipElement = document.querySelector(`.membership-pass-card[data-pass-id="${window.bookingState.selectedMembershipPass.id}"]`);
        }
        
        // Try by onclick content (both function names)
        if (!membershipElement) {
            const allPasses = document.querySelectorAll('.membership-pass, .membership-pass-card, .membership-card, [onclick*="selectMembershipPass"], [onclick*="selectRealMembershipPass"]');
            membershipElement = Array.from(allPasses).find(el => {
                const onclickStr = el.getAttribute('onclick') || '';
                return onclickStr.includes(window.bookingState.selectedMembershipPass.id);
            });
        }
        
        console.log('ðŸ” Membership pass element found:', !!membershipElement, membershipElement);
        console.log('ðŸ” Available selectors:', {
            byDataPassId: !!document.querySelector(`[data-pass-id="${window.bookingState.selectedMembershipPass.id}"]`),
            byMembershipPass: !!document.querySelector(`.membership-pass[data-pass-id="${window.bookingState.selectedMembershipPass.id}"]`),
            byMembershipPassCard: !!document.querySelector(`.membership-pass-card[data-pass-id="${window.bookingState.selectedMembershipPass.id}"]`),
            totalPassElements: document.querySelectorAll('[data-pass-id]').length,
            totalMembershipPasses: document.querySelectorAll('.membership-pass').length,
            totalMembershipPassCards: document.querySelectorAll('.membership-pass-card').length
        });
        
        if (membershipElement) {
            // Mark as booked
            membershipElement.classList.remove('selected');
            membershipElement.classList.add('booked');
            membershipElement.style.opacity = '0.7';
            membershipElement.style.pointerEvents = 'none';
            membershipElement.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
            membershipElement.style.border = '2px solid #2563eb';
            membershipElement.style.color = 'white';
            
            // Add booked indicator
            const bookedBadge = document.createElement('div');
            bookedBadge.innerHTML = '<i class="fas fa-check-circle"></i> BOOKED';
            bookedBadge.style.cssText = `
                position: absolute;
                top: 10px;
                right: 10px;
                background: rgba(255, 255, 255, 0.2);
                color: white;
                padding: 5px 10px;
                border-radius: 12px;
                font-size: 0.8rem;
                font-weight: 600;
                z-index: 10;
                backdrop-filter: blur(5px);
            `;
            membershipElement.appendChild(bookedBadge);
            
            // Disable onclick
            membershipElement.onclick = null;
            
            console.log('âœ… Membership pass marked as booked');
        } else {
            console.warn('âš ï¸ Membership pass element not found for ID:', window.bookingState.selectedMembershipPass.id);
        }
    }
    
    // Update regular slots status
    if (window.bookingState.selectedSlots && window.bookingState.selectedSlots.length > 0) {
        console.log('â° Marking regular slots as booked:', window.bookingState.selectedSlots.length, 'slots');
        
        window.bookingState.selectedSlots.forEach(slot => {
            // Try to find by data-slot-time first
            const displayTime = `${slot.start_time} - ${slot.end_time}`;
            let slotElement = document.querySelector(`[data-slot-time="${displayTime}"]`);
            
            // Fallback: find by text content if data attribute doesn't work
            if (!slotElement) {
                const slotElements = document.querySelectorAll('.time-slot, .slot-item, .professional-slot-item');
                slotElements.forEach(element => {
                    const timeText = element.textContent || element.innerText;
                    if (timeText.includes(slot.start_time) && timeText.includes(slot.end_time)) {
                        slotElement = element;
                    }
                });
            }
            
            if (slotElement) {
                // Mark as booked
                slotElement.classList.add('booked');
                slotElement.classList.remove('available', 'selected');
                slotElement.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                slotElement.style.border = '2px solid #dc2626';
                slotElement.style.color = 'white';
                slotElement.style.cursor = 'not-allowed';
                slotElement.style.opacity = '0.8';
                slotElement.style.pointerEvents = 'none';
                
                // Update status text
                const statusSpan = slotElement.querySelector('span');
                if (statusSpan) {
                    statusSpan.textContent = 'Booked';
                }
                
                // Add booked indicator
                const bookedBadge = document.createElement('div');
                bookedBadge.innerHTML = '<i class="fas fa-lock"></i> BOOKED';
                bookedBadge.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: rgba(255, 255, 255, 0.2);
                    color: white;
                    padding: 5px 10px;
                    border-radius: 12px;
                    font-size: 0.8rem;
                    font-weight: 600;
                    z-index: 10;
                    backdrop-filter: blur(5px);
                `;
                slotElement.style.position = 'relative';
                slotElement.appendChild(bookedBadge);
                
                // Disable onclick
                slotElement.onclick = null;
                
                console.log('âœ… Regular slot marked as booked:', displayTime);
            } else {
                console.warn('âš ï¸ Regular slot element not found for:', displayTime);
            }
        });
    }
    
    console.log('âœ… Slot status updated successfully');
    
    // Reload slots from server to get updated availability after 2 seconds
    setTimeout(async () => {
        console.log('ðŸ”„ Reloading slots from server to get updated availability...');
        await reloadSlotsAfterBooking();
    }, 2000);
}

// Reload slots after booking with proper error handling
async function reloadSlotsAfterBooking() {
    try {
        const selectedDate = window.bookingState?.selectedDate || document.getElementById('bookingDate')?.value || new Date().toISOString().split('T')[0];
        
        // Don't reload if we're in success state - just mark existing elements as booked
        console.log('ðŸ”„ Updating slot availability without full reload...');
        
        // Instead of reloading, just update the API data for the specific slot that was booked
        if (window.bookingState.selectedMembershipPass) {
            // Update the membership pass data to mark it as booked
            const passId = window.bookingState.selectedMembershipPass.id;
            const membershipElement = document.querySelector(`[data-pass-id="${passId}"]`);
            if (membershipElement) {
                // Update the pass data in memory
                window.bookingState.selectedMembershipPass.is_booked = true;
                window.bookingState.selectedMembershipPass.can_book = false;
                
                // Update visual state
                membershipElement.style.opacity = '0.6';
                membershipElement.style.pointerEvents = 'none';
                membershipElement.onclick = null;
                
                // Add booked indicator if not already present
                if (!membershipElement.querySelector('.booked-badge')) {
                    const bookedBadge = document.createElement('div');
                    bookedBadge.className = 'booked-badge';
                    bookedBadge.innerHTML = '<i class="fas fa-check-circle"></i> BOOKED';
                    bookedBadge.style.cssText = `
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        background: rgba(34, 197, 94, 0.9);
                        color: white;
                        padding: 5px 10px;
                        border-radius: 12px;
                        font-size: 0.8rem;
                        font-weight: 600;
                        z-index: 10;
                    `;
                    membershipElement.style.position = 'relative';
                    membershipElement.appendChild(bookedBadge);
                }
                
                console.log('âœ… Membership pass marked as booked visually');
            }
        }
        
        // For custom slots
        if (window.bookingState.customSlot) {
            const slotId = window.bookingState.customSlot.id;
            const customElement = document.querySelector(`[data-slot-id="${slotId}"]`);
            if (customElement) {
                customElement.style.opacity = '0.6';
                customElement.style.pointerEvents = 'none';
                customElement.onclick = null;
                console.log('âœ… Custom slot marked as booked visually');
            }
        }
        
        console.log('ðŸ”„ Slots updated successfully without full reload');
    } catch (error) {
        console.error('âŒ Error updating slots:', error);
    }
}

// PAYMENT SECTION FUNCTIONS
function showPaymentSection(bookingId) {
    if (bookingId) {
        console.log('ðŸ’³ Showing payment section for existing booking:', bookingId);
        // Store booking ID for payment processing
        window.currentBookingId = bookingId;
    } else {
        console.log('ðŸ’³ Showing payment section before booking creation');
        // No booking ID yet - booking will be created after payment
        window.currentBookingId = null;
    }
    
    // Hide checkout form
    document.querySelector('.container').style.display = 'none';
    
    // Show payment section
    document.getElementById('paymentSection').style.display = 'block';
    
    // Populate payment summary
    populatePaymentSummary();
    
    // Smooth scroll to payment section
    document.getElementById('paymentSection').scrollIntoView({ 
        behavior: 'smooth' 
    });
}

function populatePaymentSummary() {
    // Populate booking summary
    const bookingDate = document.querySelector('[name="booking_date"]').value;
    const firstName = document.querySelector('[name="first_name"]').value;
    const lastName = document.querySelector('[name="last_name"]').value;
    const email = document.querySelector('[name="email"]').value;
    const players = document.querySelector('[name="number_of_players"]').value;
    
    // Update payment section fields
    document.getElementById('paymentBookingDate').textContent = bookingDate;
    document.getElementById('paymentPlayers').textContent = players + ' players';
    document.getElementById('paymentTotal').textContent = `${bookingState.playgroundData?.currency || '{{ playground.currency }}'} ${bookingState.totalAmount.toFixed(2)}`;
    
    // Build time slot display - FIXED
    let timeSlotText = '';
    
    // Regular slots
    if (bookingState.selectedSlots && bookingState.selectedSlots.length > 0) {
        // Sort slots by start time
        const sortedSlots = bookingState.selectedSlots.sort((a, b) => {
            return a.start_time.localeCompare(b.start_time);
        });
        
        // Get first slot start time and last slot end time
        const firstSlot = sortedSlots[0];
        const lastSlot = sortedSlots[sortedSlots.length - 1];
        
        timeSlotText = `${firstSlot.start_time} - ${lastSlot.end_time} (${sortedSlots.length} slot${sortedSlots.length > 1 ? 's' : ''})`;
    }
    // Custom slots
    else if (bookingState.customSlot) {
        // Custom slots have a "time" field like "07:00 PM - 09:00 PM"
        timeSlotText = bookingState.customSlot.time || 'Custom slot';
    }
    // Membership passes
    else if (bookingState.selectedMembershipPass) {
        timeSlotText = `Membership - ${bookingState.selectedMembershipPass.name || 'Membership Pass'}`;
    }
    // Membership slots (if using the old selectedMembership)
    else if (bookingState.selectedMembership) {
        timeSlotText = `${bookingState.selectedMembership.start_time} - ${bookingState.selectedMembership.end_time}`;
    }
    // Fallback
    else {
        timeSlotText = 'Time not selected';
    }
    
    console.log('ðŸ•’ Setting payment time slot:', timeSlotText);
    document.getElementById('paymentTimeSlot').textContent = timeSlotText;
    
    // Build booking summary content
    const summaryContent = document.getElementById('bookingSummaryContent');
    summaryContent.innerHTML = `
        <div class="booking-summary-details">
            <div class="summary-row">
                <span class="label"><i class="fas fa-user"></i> Customer:</span>
                <span class="value">${firstName} ${lastName}</span>
            </div>
            <div class="summary-row">
                <span class="label"><i class="fas fa-envelope"></i> Email:</span>
                <span class="value">${email}</span>
            </div>
            <div class="summary-row">
                <span class="label"><i class="fas fa-calendar"></i> Date:</span>
                <span class="value">${bookingDate}</span>
            </div>
            <div class="summary-row">
                <span class="label"><i class="fas fa-clock"></i> Time:</span>
                <span class="value">${timeSlotText}</span>
            </div>
            <div class="summary-row">
                <span class="label"><i class="fas fa-users"></i> Players:</span>
                <span class="value">${players}</span>
            </div>
            <div class="summary-row total-row">
                <span class="label"><i class="fas fa-money-check-alt"></i> Total Amount:</span>
                <span class="value">${bookingState.playgroundData?.currency || '{{ playground.currency }}'} ${bookingState.totalAmount.toFixed(2)}</span>
            </div>
        </div>
    `;
}

function selectFinalPaymentMethod(method) {
    console.log('ðŸ’³ Selected final payment method:', method);
    
    // Update radio button
    document.querySelector(`[name="final_payment_method"][value="${method}"]`).checked = true;
    
    // Remove selected class from all payment methods
    document.querySelectorAll('.payment-method').forEach(pm => {
        pm.classList.remove('selected');
    });
    
    // Add selected class to clicked method
    event.target.closest('.payment-method').classList.add('selected');
    
    // Show/hide bank details
    const bankDetails = document.getElementById('bankDetails');
    if (method === 'bank_transfer') {
        bankDetails.style.display = 'block';
    } else {
        bankDetails.style.display = 'none';
    }
    
    // Enable confirm payment button
    document.getElementById('confirmPaymentBtn').disabled = false;
}

function confirmPayment() {
    const selectedMethod = document.querySelector('[name="final_payment_method"]:checked');
    
    if (!selectedMethod) {
        alert('Please select a payment method first!');
        return;
    }
    
    const confirmBtn = document.getElementById('confirmPaymentBtn');
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing Payment...';
    confirmBtn.disabled = true;
    
    // If no booking exists yet, create it first
    if (!window.currentBookingId && window.pendingBookingData) {
        console.log('ðŸ’³ Creating booking after payment confirmation...');
        
        // Add the selected payment method to the booking data
        window.pendingBookingData.append('payment_method', selectedMethod.value);
        
        // Create the booking
        const createBookingUrl = '/bookings/create/' + PLAYGROUND_ID + '/';
        console.log('ðŸš€ Creating booking at URL:', createBookingUrl);
        
        fetch(createBookingUrl, {
            method: 'POST',
            body: window.pendingBookingData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => {
            console.log('ðŸ“¡ Booking creation response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                return response.text().then(text => {
                    console.error('âŒ Response text:', text.substring(0, 500));
                    throw new Error('Server returned HTML instead of JSON. Check server logs.');
                });
            }
            
            return response.json();
        })
        .then(data => {
            if (data.success) {
                console.log('âœ… Booking created successfully:', data.booking_id);
                window.currentBookingId = data.booking_id;
                
                // Now complete the payment process
                completePayment(selectedMethod.value, data.booking_id);
            } else {
                console.error('âŒ Booking creation failed:', data.error);
                alert('Booking failed: ' + (data.error || 'Unknown error'));
                // Re-enable confirm button
                confirmBtn.innerHTML = '<i class="fas fa-check-circle"></i> Confirm Payment';
                confirmBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('âŒ Booking creation error:', error);
            alert('Booking creation failed. Please try again.');
            // Re-enable confirm button
            confirmBtn.innerHTML = '<i class="fas fa-check-circle"></i> Confirm Payment';
            confirmBtn.disabled = false;
        });
    } else {
        // Booking already exists, just complete payment
        completePayment(selectedMethod.value, window.currentBookingId);
    }
}

function completePayment(paymentMethod, bookingId) {
    // Simulate payment processing
    setTimeout(() => {
        alert(`ðŸŽ‰ Payment confirmed! Your booking has been successfully completed.\n\nBooking ID: ${bookingId}\nPayment Method: ${paymentMethod.replace('_', ' ').toUpperCase()}\n\nYou will receive a confirmation email shortly.`);
        
        // Redirect to success page or refresh
        window.location.href = '/bookings/';
    }, 2000);
}

function backToCheckout() {
    // Show checkout form
    document.querySelector('.container').style.display = 'block';
    
    // Hide payment section
    document.getElementById('paymentSection').style.display = 'none';
    
    // Scroll back to form
    document.querySelector('.container').scrollIntoView({ 
        behavior: 'smooth' 
    });
    
    // Re-enable submit button
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.innerHTML = '<i class="fas fa-credit-card"></i> Proceed to Payment';
    submitBtn.disabled = false;
} 

// TEST FUNCTION - Enhanced test data for complete booking simulation
function fillTestData() {
    console.log('ðŸ§ª FILLING ENHANCED TEST DATA...');
    
    // Get tomorrow's date
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];
    
    // Fill required fields
    const bookingDateField = document.getElementById('bookingDate') || document.querySelector('[name="booking_date"]');
    if (bookingDateField) {
        bookingDateField.value = tomorrowStr;
        // Trigger change event to load slots
        bookingDateField.dispatchEvent(new Event('change'));
    }
    
    document.querySelector('[name="first_name"]').value = 'Test';
    document.querySelector('[name="last_name"]').value = 'User';
    document.querySelector('[name="email"]').value = 'test@example.com';
    document.querySelector('[name="phone_number"]').value = '0123456789';
    document.querySelector('[name="number_of_players"]').value = '4';
    document.querySelector('[name="special_requests"]').value = 'Automated test booking - testing complete flow';
    document.getElementById('terms').checked = true;
    
    // Set booking state
    bookingState.selectedDate = tomorrowStr;
    
    console.log('âœ… Test data filled successfully!');
    console.log(`ðŸ“… Date set to: ${tomorrowStr}`);
    console.log('ðŸ“‹ Next steps:');
    console.log('   1. Wait for time slots to load');
    console.log('   2. Select a time slot');
    console.log('   3. Optionally select amenities');
    console.log('   4. Click "Proceed to Payment"');
    
    // Show notification
    showNotification('Test Data Loaded', 'All form fields have been pre-filled. Select a time slot to proceed.', 'success');
    
    // Auto-select first available slot after 2 seconds
    setTimeout(() => {
        const availableSlots = document.querySelectorAll('.slot-container[data-available="true"]:not(.selected)');
        if (availableSlots.length > 0) {
            console.log(`ðŸŽ¯ Auto-selecting first available slot...`);
            availableSlots[0].click();
            showNotification('Slot Selected', 'First available slot selected automatically. Ready for booking!', 'success');
        } else {
            console.warn('âš ï¸ No available slots found for auto-selection');
        }
    }, 3000);
}

// Missing utility functions
function updateSelectedDateDisplay(selectedDate = null) {
    const dateInput = document.getElementById('bookingDate');
    const date = selectedDate || (dateInput ? dateInput.value : null);
    
    if (!date) return;
    
    // Update booking state
    bookingState.selectedDate = date;
    
    const dateInfo = document.getElementById('selectedDateInfo');
    const displayDate = document.getElementById('displaySelectedDate');
    
    if (displayDate) {
        displayDate.textContent = new Date(date).toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }
    
    if (dateInfo) {
        dateInfo.style.display = 'block';
    }
    
    // Update summary
    const summaryDate = document.getElementById('summaryDate');
    if (summaryDate) {
        summaryDate.textContent = new Date(date).toLocaleDateString();
    }
}

function showLoading(show = true) {
    // LOADING COMPLETELY DISABLED - NO MORE LOADING SPINNERS!
    console.log('ðŸš« Loading disabled - no loading states will show');
    return; // Exit immediately - no loading will ever show
    
    // All loading code below is disabled
}

function showNoSlots(type = 'regular', message = 'No available slots for this date') {
    let container;
    
    if (type === 'regular') {
        container = document.getElementById('slotsContainer');
    } else if (type === 'custom') {
        container = document.getElementById('customSlotsContainer');
    } else if (type === 'membership') {
        container = document.getElementById('membershipContainer');
    } else {
        container = document.getElementById('slotsContainer');
    }
    
    if (container) {
        container.innerHTML = `
            <div class="text-center py-12" style="color: var(--text-secondary);">
                <i class="fas fa-calendar-times" style="color: var(--error-color); font-size: 3rem; margin-bottom: 1rem; opacity: 0.7;"></i>
                <h3 style="color: var(--text-primary); margin-bottom: 0.5rem; font-size: 1.2rem;">No Available Slots</h3>
                <p style="margin: 0; font-size: 0.9rem;">${message}</p>
            </div>
        `;
    }
}

function switchSlotType(type) {
    console.log('ðŸ”„ Switching to slot type:', type);
    
    // Prevent page scrolling
    event.preventDefault();
    
    // Update booking state
    bookingState.slotType = type;
    currentSlotType = type;
    
    // Force immediate slot type display update
    const slotTypeText = type.charAt(0).toUpperCase() + type.slice(1);
    updateSummaryElement('summarySlotType', slotTypeText);
    console.log('ðŸ“‹ Tab switched - slot type updated to:', slotTypeText);
    
    // Update tab visual states
    const tabs = document.querySelectorAll('.tab-button');
    tabs.forEach(tab => {
        tab.classList.remove('active');
        tab.style.borderBottom = '3px solid transparent';
        tab.style.color = 'var(--text-secondary)';
        tab.style.background = 'none';
    });
    
    // Activate selected tab
    const activeTab = document.getElementById(`${type}-tab`);
    if (activeTab) {
        activeTab.classList.add('active');
        activeTab.style.borderBottom = '3px solid var(--primary-color)';
        activeTab.style.color = 'var(--primary-color)';
        activeTab.style.background = 'rgba(16, 185, 129, 0.1)';
    }
    
    // Show/hide content and load data
    showSlotType(type);
    
    // Load appropriate data based on type
    const dateInput = document.getElementById('bookingDate');
    const selectedDate = dateInput ? dateInput.value : null;
    
    if (type === 'regular') {
        // For regular slots, load slots if date is already selected
        if (selectedDate) {
            console.log('ðŸŽ¯ Regular slots selected - loading for date:', selectedDate);
            loadRegularSlots(selectedDate);
        } else {
            console.log('ðŸŽ¯ Regular slots selected - showing date selection message');
            showSlotSelectionMessage();
        }
    } else if (type === 'custom') {
        loadCustomSlots();
    } else if (type === 'membership') {
        loadMembershipPasses();
    }
    
    return false;
}

// Enhanced checkout system initialization
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸŽ¯ Enhanced checkout system ready');
    
    // Debug all multi-step elements on page load
    debugMultiStepElements();
    
    // Set default date to today but DO NOT auto-load slots
    const dateInput = document.getElementById('bookingDate');
    if (dateInput) {
        const today = new Date().toISOString().split('T')[0];
        if (!dateInput.value) {
            dateInput.value = today;
        }
        bookingState.selectedDate = dateInput.value;
        updateSelectedDateDisplay(dateInput.value);
        
        // DO NOT auto-load slots - only load when user changes date
        console.log('ðŸ“… Date set to:', dateInput.value, '- Slots will load when user selects date');
    }
    
    // Initialize slot type to regular but don't load slots yet
    const regularTab = document.getElementById('regular-tab');
    if (regularTab) {
        regularTab.classList.add('active');
        regularTab.style.borderBottom = '3px solid var(--primary-color)';
        regularTab.style.color = 'var(--primary-color)';
        regularTab.style.background = 'rgba(16, 185, 129, 0.1)';
    }
    
    // Show regular slots section but with "Select Date First" message
    const regularSlots = document.getElementById('regular-slots');
    const regularNoSlots = document.getElementById('regular-no-slots');
    if (regularSlots) {
        regularSlots.style.display = 'block';
    }
    if (regularNoSlots) {
        regularNoSlots.style.display = 'block';
    }
    
    // Hide other slot sections
    const customSlots = document.getElementById('custom-slots');
    const membershipSlots = document.getElementById('membership-slots');
    if (customSlots) customSlots.style.display = 'none';
    if (membershipSlots) membershipSlots.style.display = 'none';
    
    // Load non-date-dependent data
    loadAmenities();
    
    // Visual states are handled individually when amenities are selected
    console.log('ðŸŽ¨ Page load initialization completed');
    
    // FINAL CLEANUP: Force hide any remaining loading states
    setTimeout(() => {
        hideAllLoadingStates();
        console.log('ðŸ§¹ Final cleanup: All loading states forced hidden');
    }, 100);
});
// CONFIRMATION DETAILS FUNCTION
function populateConfirmationDetails() {
    const bookingDate = document.querySelector('[name="booking_date"]').value;
    const firstName = document.querySelector('[name="first_name"]').value;
    const lastName = document.querySelector('[name="last_name"]').value;
    const email = document.querySelector('[name="email"]').value;
    const phone = document.querySelector('[name="phone_number"]').value;
    const players = document.querySelector('[name="number_of_players"]').value;
    const specialRequests = document.querySelector('[name="special_requests"]').value;
    
    // Build time slot display
    let timeSlotText = '';
    if (bookingState.type === 'slots') {
        if (bookingState.slotType === 'regular' && bookingState.selectedSlots.length > 0) {
            const sortedSlots = bookingState.selectedSlots.sort((a, b) => {
                return a.start_time.localeCompare(b.start_time);
            });
            const firstSlot = sortedSlots[0];
            const lastSlot = sortedSlots[sortedSlots.length - 1];
            timeSlotText = `${firstSlot.start_time} - ${lastSlot.end_time} (${sortedSlots.length} slot${sortedSlots.length > 1 ? 's' : ''})`;
        } else if (bookingState.slotType === 'custom' && bookingState.customSlot) {
            timeSlotText = bookingState.customSlot.time || 'Custom slot';
        }
    } else if (bookingState.type === 'membership' && bookingState.selectedMembershipPass) {
        timeSlotText = `${bookingState.selectedMembershipPass.name} Pass`;
    }
    
    // Get payment method display name
    const paymentMethodDisplay = window.selectedPaymentMethod.replace('_', ' ').toUpperCase();
    
    // Populate booking details
    document.getElementById('finalBookingDetails').innerHTML = `
        <div class="detail-grid">
            <div class="detail-row">
                <span class="detail-label"><i class="fas fa-user"></i> Customer Name:</span>
                <span class="detail-value">${firstName} ${lastName}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label"><i class="fas fa-envelope"></i> Email:</span>
                <span class="detail-value">${email}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label"><i class="fas fa-phone"></i> Phone:</span>
                <span class="detail-value">${phone}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label"><i class="fas fa-calendar"></i> Date:</span>
                <span class="detail-value">${bookingDate}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label"><i class="fas fa-clock"></i> Time:</span>
                <span class="detail-value">${timeSlotText}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label"><i class="fas fa-users"></i> Players:</span>
                <span class="detail-value">${players}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label"><i class="fas fa-map-marker-alt"></i> Playground:</span>
                <span class="detail-value">${bookingState.playgroundData?.name || '{{ playground.name }}'}</span>
            </div>
            ${specialRequests ? `
            <div class="detail-row">
                <span class="detail-label"><i class="fas fa-comment"></i> Special Requests:</span>
                <span class="detail-value">${specialRequests}</span>
            </div>
            ` : ''}
        </div>
    `;
    
    // Populate payment details
    document.getElementById('finalPaymentDetails').innerHTML = `
        <div class="detail-grid">
            <div class="detail-row">
                <span class="detail-label"><i class="fas fa-credit-card"></i> Payment Method:</span>
                <span class="detail-value">${paymentMethodDisplay}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label"><i class="fas fa-dollar-sign"></i> Amount:</span>
                <span class="detail-value">${bookingState.playgroundData?.currency || '{{ playground.currency }}'} ${bookingState.totalAmount.toFixed(2)}</span>
            </div>
        </div>
    `;
    
    // Update final total
    document.getElementById('finalTotal').textContent = `${bookingState.playgroundData?.currency || '{{ playground.currency }}'} ${bookingState.totalAmount.toFixed(2)}`;
}

// ðŸŽ‰ Professional Success Message Display
function showProfessionalSuccessMessage(bookingId, paymentMethod) {
    // Create professional success overlay
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease-out;
    `;
    
    // Create success message container
    const container = document.createElement('div');
    container.style.cssText = `
        background: linear-gradient(135deg, #ffffff, #f8fafc);
        border-radius: 20px;
        padding: 3rem;
        max-width: 500px;
        width: 90%;
        text-align: center;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(16, 185, 129, 0.2);
        animation: slideInUp 0.4s ease-out;
        position: relative;
        overflow: hidden;
    `;
    
    // Add success content
    const paymentMethodDisplay = paymentMethod ? paymentMethod.replace('_', ' ').toUpperCase() : 'SELECTED METHOD';
    container.innerHTML = `
        <div style="
            position: absolute;
            top: -50px;
            left: -50px;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(245, 158, 11, 0.1));
            border-radius: 50%;
            animation: float 3s ease-in-out infinite;
        "></div>
        
        <div style="
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 50%;
            margin: 0 auto 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: checkmarkBounce 0.6s ease-out 0.2s;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        ">
            <i class="fas fa-check" style="color: white; font-size: 2.5rem; font-weight: bold;"></i>
        </div>
        
        <h2 style="
            color: #1f2937;
            margin: 0 0 1rem;
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        ">ðŸŽ‰ Booking Confirmed!</h2>
        
        <p style="
            color: #6b7280;
            margin: 0 0 2rem;
            font-size: 1rem;
            line-height: 1.6;
        ">Your playground booking has been successfully processed and confirmed.</p>
        
        <div style="
            background: rgba(16, 185, 129, 0.05);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: left;
        ">
            <div style="margin-bottom: 0.75rem;">
                <strong style="color: #374151;">ðŸ“‹ Booking ID:</strong>
                <span style="color: #10b981; font-weight: 600; margin-left: 0.5rem;">${bookingId}</span>
            </div>
            <div style="margin-bottom: 0.75rem;">
                <strong style="color: #374151;">ðŸ’³ Payment Method:</strong>
                <span style="color: #6b7280; margin-left: 0.5rem;">${paymentMethodDisplay}</span>
            </div>
            <div>
                <strong style="color: #374151;">ðŸ“§ Confirmation:</strong>
                <span style="color: #6b7280; margin-left: 0.5rem;">Email sent to your inbox</span>
            </div>
        </div>
        
        <div style="
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: #10b981;
            font-size: 0.9rem;
            font-weight: 500;
        ">
            <div style="
                width: 6px;
                height: 6px;
                background: #10b981;
                border-radius: 50%;
                animation: pulse 1.5s ease-in-out infinite;
            "></div>
            Redirecting to booking details...
        </div>
    `;
    
    overlay.appendChild(container);
    document.body.appendChild(overlay);
    
    // Add keyframe animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideInUp {
            from { 
                opacity: 0;
                transform: translateY(30px) scale(0.9);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        @keyframes checkmarkBounce {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    `;
    document.head.appendChild(style);
    
    // Auto-remove after redirect delay
    setTimeout(() => {
        overlay.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => {
            document.body.removeChild(overlay);
            document.head.removeChild(style);
        }, 300);
    }, 2700);
}

// Professional navigation functions for dynamic booking flow
function navigateToBookingDetail(detailUrl) {
    console.log('ðŸ”„ Navigating to booking detail:', detailUrl);
    
    // Show loading indicator
    showLoadingOverlay('Loading booking details...', 'Taking you to your booking information');
    
    // Navigate after short delay for smooth UX
    setTimeout(() => {
        window.location.href = detailUrl;
    }, 1200);
}

function navigateToBookingDashboard(dashboardUrl) {
    console.log('ðŸ”„ Navigating to booking dashboard:', dashboardUrl);
    
    // Show loading indicator  
    showLoadingOverlay('Loading your bookings...', 'Taking you to your booking dashboard');
    
    // Navigate after short delay for smooth UX
    setTimeout(() => {
        window.location.href = dashboardUrl;
    }, 1200);
}

function showLoadingOverlay(mainText, subText) {
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease-out;
    `;
    
    overlay.innerHTML = `
        <div style="text-align: center; color: white;">
            <div style="width: 60px; height: 60px; border: 4px solid #3b82f6; border-top: 4px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
            <h3 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 10px;">${mainText}</h3>
            <p style="font-size: 1rem; opacity: 0.8;">${subText}</p>
        </div>
    `;
    
    document.body.appendChild(overlay);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (document.body.contains(overlay)) {
            overlay.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => {
                if (document.body.contains(overlay)) {
                    document.body.removeChild(overlay);
                }
            }, 300);
        }
    }, 3000);
}

// âœ… FORCE NAVBAR AND FOOTER VISIBILITY - CRITICAL FIX
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸ”§ Forcing navbar and footer visibility...');
    
    // Force navbar visibility
    const navbar = document.querySelector('nav.navbar-fixed') || document.querySelector('nav');
    if (navbar) {
        navbar.style.display = 'block';
        navbar.style.visibility = 'visible';
        navbar.style.opacity = '1';
        navbar.style.position = 'fixed';
        navbar.style.top = '0';
        navbar.style.left = '0';
        navbar.style.right = '0';
        navbar.style.zIndex = '9999';
        navbar.style.width = '100%';
        console.log('âœ… Navbar forced to visible');
    } else {
        console.error('âŒ Navbar not found!');
    }
    
    // Force footer visibility
    const footer = document.querySelector('footer');
    if (footer) {
        footer.style.display = 'block';
        footer.style.visibility = 'visible';
        footer.style.opacity = '1';
        console.log('âœ… Footer forced to visible');
    } else {
        console.error('âŒ Footer not found!');
    }
    
    // Continuously monitor and enforce visibility (in case JavaScript tries to hide them)
    setInterval(function() {
        if (navbar && navbar.style.display === 'none') {
            navbar.style.display = 'block';
            console.warn('âš ï¸ Navbar was hidden, forcing visible again');
        }
        if (footer && footer.style.display === 'none') {
            footer.style.display = 'block';
            console.warn('âš ï¸ Footer was hidden, forcing visible again');
        }
    }, 500);
});

</script>
{% endblock %}
