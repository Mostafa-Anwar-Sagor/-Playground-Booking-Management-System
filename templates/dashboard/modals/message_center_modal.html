<!-- Message Center Modal -->
<div id="messageCenterModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">Message Center</h2>
                    <button onclick="closeMessageCenter()" class="text-gray-500 hover:text-gray-700 p-2">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex h-[70vh]">
                <!-- Conversations List -->
                <div class="w-1/3 border-r border-gray-200 bg-gray-50">
                    <div class="p-4 border-b border-gray-200">
                        <div class="relative">
                            <input type="text" id="searchConversations" placeholder="Search conversations..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                    </div>
                    
                    <div id="conversationsList" class="overflow-y-auto h-full">
                        <!-- Conversations will be loaded here -->
                    </div>
                </div>
                
                <!-- Chat Area -->
                <div class="flex-1 flex flex-col">
                    <!-- Chat Header -->
                    <div id="chatHeader" class="p-4 border-b border-gray-200 bg-white">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-white"></i>
                            </div>
                            <div>
                                <h3 id="chatUserName" class="font-semibold text-gray-800">Select a conversation</h3>
                                <p id="chatPlaygroundName" class="text-sm text-gray-600"></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Messages Area -->
                    <div id="messagesArea" class="flex-1 overflow-y-auto p-4 bg-gray-50">
                        <div class="text-center text-gray-500 mt-20">
                            <i class="fas fa-comments text-4xl mb-4"></i>
                            <p>Select a conversation to start messaging</p>
                        </div>
                    </div>
                    
                    <!-- Message Input -->
                    <div id="messageInput" class="p-4 border-t border-gray-200 bg-white hidden">
                        <div class="flex items-center space-x-3">
                            <button class="text-gray-400 hover:text-gray-600 p-2">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <input type="text" id="messageText" placeholder="Type your message..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <button onclick="sendMessage()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentConversation = null;
let messagesPollingInterval = null;

function openMessageCenter() {
    document.getElementById('messageCenterModal').classList.remove('hidden');
    loadConversations();
}

function closeMessageCenter() {
    document.getElementById('messageCenterModal').classList.add('hidden');
    
    // Clear polling interval
    if (messagesPollingInterval) {
        clearInterval(messagesPollingInterval);
        messagesPollingInterval = null;
    }
    
    currentConversation = null;
}

async function loadConversations() {
    try {
        // Since we don't have a specific API for conversations yet, 
        // we'll simulate with recent bookings that have messages
        const response = await fetch('/api/owner/pending-bookings/');
        const data = await response.json();
        
        if (data.success) {
            displayConversations(data.bookings);
        }
    } catch (error) {
        console.error('Error loading conversations:', error);
    }
}

function displayConversations(bookings) {
    const container = document.getElementById('conversationsList');
    
    if (bookings.length === 0) {
        container.innerHTML = `
            <div class="p-4 text-center text-gray-500">
                <i class="fas fa-inbox text-3xl mb-2"></i>
                <p>No conversations yet</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = bookings.map(booking => `
        <div class="conversation-item p-4 hover:bg-gray-100 cursor-pointer border-b border-gray-200" 
             onclick="selectConversation('${booking.id}', '${booking.user_name}', '${booking.playground_name}')">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                    <span class="text-white font-medium">${booking.user_name.charAt(0).toUpperCase()}</span>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-start">
                        <h4 class="font-medium text-gray-800 truncate">${booking.user_name}</h4>
                        <span class="text-xs text-gray-500">${new Date(booking.created_at).toLocaleDateString()}</span>
                    </div>
                    <p class="text-sm text-gray-600 truncate">${booking.playground_name}</p>
                    <p class="text-xs text-gray-500 truncate">Booking: ${booking.booking_date}</p>
                </div>
                <div class="flex flex-col items-end space-y-1">
                    <span class="w-3 h-3 bg-blue-500 rounded-full"></span>
                    <span class="text-xs text-gray-500">Active</span>
                </div>
            </div>
        </div>
    `).join('');
}

function selectConversation(bookingId, userName, playgroundName) {
    currentConversation = bookingId;
    
    // Update chat header
    document.getElementById('chatUserName').textContent = userName;
    document.getElementById('chatPlaygroundName').textContent = playgroundName;
    
    // Show message input
    document.getElementById('messageInput').classList.remove('hidden');
    
    // Load messages for this conversation
    loadMessages(bookingId);
    
    // Start polling for new messages
    if (messagesPollingInterval) {
        clearInterval(messagesPollingInterval);
    }
    messagesPollingInterval = setInterval(() => loadMessages(bookingId), 5000);
    
    // Highlight selected conversation
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('bg-blue-50', 'border-blue-200');
    });
    event.currentTarget.classList.add('bg-blue-50', 'border-blue-200');
}

function loadMessages(bookingId) {
    // Simulate loading messages - in real implementation, this would fetch from API
    const messages = [
        {
            id: 1,
            sender: 'user',
            message: 'Hi, I have a booking for tomorrow. Can you confirm the availability?',
            timestamp: new Date(Date.now() - 3600000).toISOString()
        },
        {
            id: 2,
            sender: 'owner',
            message: 'Hello! Yes, your booking is confirmed. The playground will be ready for you.',
            timestamp: new Date(Date.now() - 1800000).toISOString()
        },
        {
            id: 3,
            sender: 'user',
            message: 'Great! Do you provide equipment or should I bring my own?',
            timestamp: new Date(Date.now() - 900000).toISOString()
        }
    ];
    
    displayMessages(messages);
}

function displayMessages(messages) {
    const container = document.getElementById('messagesArea');
    
    container.innerHTML = messages.map(message => {
        const isOwner = message.sender === 'owner';
        const time = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        return `
            <div class="flex ${isOwner ? 'justify-end' : 'justify-start'} mb-4">
                <div class="max-w-xs lg:max-w-md ${isOwner ? 'order-2' : 'order-1'}">
                    <div class="${isOwner ? 'bg-blue-500 text-white' : 'bg-white border border-gray-200'} rounded-lg px-4 py-2 shadow-sm">
                        <p class="text-sm">${message.message}</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-1 ${isOwner ? 'text-right' : 'text-left'}">${time}</p>
                </div>
                ${!isOwner ? `
                    <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center order-0 mr-2">
                        <i class="fas fa-user text-gray-600 text-xs"></i>
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
    
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
}

function sendMessage() {
    const messageText = document.getElementById('messageText');
    const text = messageText.value.trim();
    
    if (!text || !currentConversation) return;
    
    // Add message to UI immediately
    const messagesArea = document.getElementById('messagesArea');
    const messageHTML = `
        <div class="flex justify-end mb-4">
            <div class="max-w-xs lg:max-w-md">
                <div class="bg-blue-500 text-white rounded-lg px-4 py-2 shadow-sm">
                    <p class="text-sm">${text}</p>
                </div>
                <p class="text-xs text-gray-500 mt-1 text-right">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
            </div>
        </div>
    `;
    
    messagesArea.insertAdjacentHTML('beforeend', messageHTML);
    messagesArea.scrollTop = messagesArea.scrollHeight;
    
    // Clear input
    messageText.value = '';
    
    // TODO: Send message to API
    console.log('Sending message:', text, 'to conversation:', currentConversation);
    
    // Simulate response after 2 seconds
    setTimeout(() => {
        const responseHTML = `
            <div class="flex justify-start mb-4">
                <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center mr-2">
                    <i class="fas fa-user text-gray-600 text-xs"></i>
                </div>
                <div class="max-w-xs lg:max-w-md">
                    <div class="bg-white border border-gray-200 rounded-lg px-4 py-2 shadow-sm">
                        <p class="text-sm">Thank you for the quick response!</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                </div>
            </div>
        `;
        messagesArea.insertAdjacentHTML('beforeend', responseHTML);
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }, 2000);
}

// Handle Enter key in message input
document.getElementById('messageText').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// Search conversations
document.getElementById('searchConversations').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const conversations = document.querySelectorAll('.conversation-item');
    
    conversations.forEach(conversation => {
        const userName = conversation.querySelector('h4').textContent.toLowerCase();
        const playgroundName = conversation.querySelector('p').textContent.toLowerCase();
        
        if (userName.includes(searchTerm) || playgroundName.includes(searchTerm)) {
            conversation.style.display = '';
        } else {
            conversation.style.display = 'none';
        }
    });
});

// Close modal when clicking outside
document.getElementById('messageCenterModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeMessageCenter();
    }
});
</script>
